/*//////////////////////////////////////////////////////////////////////////////
O₂ Engine  -  version 2.3.0
Date : 2014-3-13
Copyright ©2012-2014 Gengosha Inc. All rights reserved.
To use or redistribute this software, please read 
http://developer.novelsphere.jp/

This software includes undermentioned libraries.
The following license descriptions are NOT about the license of O₂ Engine itself.

*** jQuery ***
Copyright 2013 jQuery Foundation and other contributors
http://jquery.com/

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//////////////////////////////////////////////////////////////////////////////*/
(function(a,b){function c(a){var b=a.length,c=h.type(a);return h.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||"function"!==c&&(0===b||"number"==typeof b&&0<b&&b-1 in a)}function d(){Object.defineProperty(this.cache={},0,{get:function(){return{}}});this.expando=h.expando+Math.random()}function e(a,c,d){var s;if(d===b&&1===a.nodeType)if(s="data-"+c.replace(dc,"-$1").toLowerCase(),d=a.getAttribute(s),"string"==typeof d){try{d="true"===d?!0:"false"===d?!1:"null"===d?null:+d+""===d?+d:ec.test(d)?JSON.parse(d):
d}catch(h){}F.set(a,c,d)}else d=b;return d}function g(){return!0}function i(){return!1}function j(){try{return x.activeElement}catch(a){}}function k(a,b){for(;(a=a[b])&&1!==a.nodeType;);return a}function l(a,b,c){if(h.isFunction(b))return h.grep(a,function(a,w){return!!b.call(a,w,a)!==c});if(b.nodeType)return h.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(fc.test(b))return h.filter(b,a,c);b=h.filter(b,a)}return h.grep(a,function(a){return 0<=Aa.call(b,a)!==c})}function n(a,b){return h.nodeName(a,
"table")&&h.nodeName(1===b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function p(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function q(a){var b=gc.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function m(a,b){for(var c=a.length,d=0;c>d;d++)v.set(a[d],"globalEval",!b||v.get(b[d],"globalEval"))}function r(a,b){var c,d,t,e,g,i;if(1===b.nodeType){if(v.hasData(a)&&(c=v.access(a),d=h.extend({},
c),i=c.events,v.set(b,d),i))for(t in delete d.handle,d.events={},i){c=0;for(d=i[t].length;d>c;c++)h.event.add(b,t,i[t][c])}F.hasData(a)&&(e=F.access(a),g=h.extend({},e),F.set(b,g))}}function z(a,c){var d=a.getElementsByTagName?a.getElementsByTagName(c||"*"):a.querySelectorAll?a.querySelectorAll(c||"*"):[];return c===b||c&&h.nodeName(a,c)?h.merge([a],d):d}function D(a,b){if(b in a)return b;for(var c=b.charAt(0).toUpperCase()+b.slice(1),d=b,h=nb.length;h--;)if(b=nb[h]+c,b in a)return b;return d}function H(a,
b){return a=b||a,"none"===h.css(a,"display")||!h.contains(a.ownerDocument,a)}function ha(a,b){for(var c,d,t,e=[],g=0,i=a.length;i>g;g++)d=a[g],d.style&&(e[g]=v.get(d,"olddisplay"),c=d.style.display,b?(e[g]||"none"!==c||(d.style.display=""),""===d.style.display&&H(d)&&(e[g]=v.access(d,"olddisplay",hc(d.nodeName)))):e[g]||(t=H(d),(c&&"none"!==c||!t)&&v.set(d,"olddisplay",t?c:h.css(d,"display"))));for(g=0;i>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?
e[g]||"":"none"));return a}function I(a,b,c){return(a=ic.exec(b))?Math.max(0,a[1]-(c||0))+(a[2]||"px"):b}function L(a,b,c,d,t){for(var b=c===(d?"border":"content")?4:"width"===b?1:0,e=0;4>b;b+=2)"margin"===c&&(e+=h.css(a,c+ia[b],!0,t)),d?("content"===c&&(e-=h.css(a,"padding"+ia[b],!0,t)),"margin"!==c&&(e-=h.css(a,"border"+ia[b]+"Width",!0,t))):(e+=h.css(a,"padding"+ia[b],!0,t),"padding"!==c&&(e+=h.css(a,"border"+ia[b]+"Width",!0,t)));return e}function R(b,c,d){var s=!0,t="width"===c?b.offsetWidth:
b.offsetHeight,e=a.getComputedStyle(b,null),g=h.support.boxSizing&&"border-box"===h.css(b,"boxSizing",!1,e);if(0>=t||null==t){if(t=qa(b,c,e),(0>t||null==t)&&(t=b.style[c]),Ua.test(t))return t;s=g&&(h.support.boxSizingReliable||t===b.style[c]);t=parseFloat(t)||0}return t+L(b,c,d||(g?"border":"content"),s,e)+"px"}function hc(a){var b=x,c=ob[a];return c||(c=pb(a,b),"none"!==c&&c||(ua=(ua||h("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(b.documentElement),
b=(ua[0].contentWindow||ua[0].contentDocument).document,b.write("<!doctype html><html><body>"),b.close(),c=pb(a,b),ua.detach()),ob[a]=c),c}function pb(a,b){var c=h(b.createElement(a)).appendTo(b.body),d=h.css(c[0],"display");return c.remove(),d}function Va(a,b,c,d){var t;if(h.isArray(b))h.each(b,function(b,u){c||jc.test(a)?d(a,u):Va(a+"["+("object"==typeof u?b:"")+"]",u,c,d)});else if(c||"object"!==h.type(b))d(a,b);else for(t in b)Va(a+"["+t+"]",b[t],c,d)}function qb(a){return function(b,c){"string"!=
typeof b&&(c=b,b="*");var d,t=0,e=b.toLowerCase().match(X)||[];if(h.isFunction(c))for(;d=e[t++];)"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function rb(a,c,d,s){function t(i){var j;return e[i]=!0,h.each(a[i]||[],function(a,w){var h=w(c,d,s);return"string"!=typeof h||g||e[h]?g?!(j=h):b:(c.dataTypes.unshift(h),t(h),!1)}),j}var e={},g=a===Wa;return t(c.dataTypes[0])||!e["*"]&&t("*")}function Xa(a,c){var d,s,t=h.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&
((t[d]?a:s||(s={}))[d]=c[d]);return s&&h.extend(!0,a,s),a}function sb(){return setTimeout(function(){ra=b}),ra=h.now()}function tb(a,b,c){var d,t,e=0,g=Ba.length,i=h.Deferred().always(function(){delete j.elem}),j=function(){if(t)return!1;for(var b=ra||sb(),b=Math.max(0,k.startTime+k.duration-b),c=1-(b/k.duration||0),d=0,u=k.tweens.length;u>d;d++)k.tweens[d].run(c);return i.notifyWith(a,[k,c,b]),1>c&&u?b:(i.resolveWith(a,[k]),!1)},k=i.promise({elem:a,props:h.extend({},b),opts:h.extend(!0,{specialEasing:{}},
c),originalProperties:b,originalOptions:c,startTime:ra||sb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=h.Tween(a,k.opts,b,c,k.opts.specialEasing[b]||k.opts.easing);return k.tweens.push(d),d},stop:function(b){var c=0,d=b?k.tweens.length:0;if(t)return this;for(t=!0;d>c;c++)k.tweens[c].run(1);return b?i.resolveWith(a,[k,b]):i.rejectWith(a,[k,b]),this}}),b=k.props,c=k.opts.specialEasing,l,M,n,p;for(d in b)if(l=h.camelCase(d),M=c[l],n=b[d],h.isArray(n)&&(M=n[1],n=b[d]=n[0]),d!==l&&
(b[l]=n,delete b[d]),p=h.cssHooks[l],p&&"expand"in p)for(d in n=p.expand(n),delete b[l],n)d in b||(b[d]=n[d],c[d]=M);else c[l]=M;for(;g>e;e++)if(d=Ba[e].call(k,a,b,k.opts))return d;var q=k;h.each(b,function(a,b){for(var w=(va[a]||[]).concat(va["*"]),c=0,d=w.length;d>c&&!w[c].call(q,a,b);c++);});return h.isFunction(k.opts.start)&&k.opts.start.call(a,k),h.fx.timer(h.extend(j,{elem:a,anim:k,queue:k.opts.queue})),k.progress(k.opts.progress).done(k.opts.done,k.opts.complete).fail(k.opts.fail).always(k.opts.always)}
function N(a,b,c,d,h){return new N.prototype.init(a,b,c,d,h)}function Ca(a,b){for(var c,d={height:a},h=0,b=b?1:0;4>h;h+=2-b)c=ia[h],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}var ub,Da,Ea=typeof b,lc=a.location,x=a.document,vb=x.documentElement,mc=a.jQuery,nc=a.$,Fa={},Ga=[],wb=Ga.concat,Ya=Ga.push,ka=Ga.slice,Aa=Ga.indexOf,oc=Fa.toString,Za=Fa.hasOwnProperty,pc="2.0.0".trim,h=function(a,b){return new h.fn.init(a,b,ub)},Ha=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,X=/\S+/g,
qc=/^(?:(<[\w\W]+>)[^>]*|#([\w-]*))$/,xb=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,rc=/^-ms-/,sc=/-([\da-z])/gi,tc=function(a,b){return b.toUpperCase()},Ia=function(){x.removeEventListener("DOMContentLoaded",Ia,!1);a.removeEventListener("load",Ia,!1);h.ready()};h.fn=h.prototype={jquery:"2.0.0",constructor:h,init:function(a,c,d){var s,t;if(!a)return this;if("string"==typeof a){if(s="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&3<=a.length?[null,a,null]:qc.exec(a),!s||!s[1]&&c)return!c||c.jquery?(c||d).find(a):
this.constructor(c).find(a);if(s[1]){if(c=c instanceof h?c[0]:c,h.merge(this,h.parseHTML(s[1],c&&c.nodeType?c.ownerDocument||c:x,!0)),xb.test(s[1])&&h.isPlainObject(c))for(s in c)h.isFunction(this[s])?this[s](c[s]):this.attr(s,c[s]);return this}return t=x.getElementById(s[2]),t&&t.parentNode&&(this.length=1,this[0]=t),this.context=x,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):h.isFunction(a)?d.ready(a):(a.selector!==b&&(this.selector=a.selector,this.context=
a.context),h.makeArray(a,this))},selector:"",length:0,toArray:function(){return ka.call(this)},get:function(a){return null==a?this.toArray():0>a?this[this.length+a]:this[a]},pushStack:function(a){a=h.merge(this.constructor(),a);return a.prevObject=this,a.context=this.context,a},each:function(a,b){return h.each(this,a,b)},ready:function(a){return h.ready.promise().done(a),this},slice:function(){return this.pushStack(ka.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},
eq:function(a){var b=this.length,a=+a+(0>a?b:0);return this.pushStack(0<=a&&b>a?[this[a]]:[])},map:function(a){return this.pushStack(h.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:Ya,sort:[].sort,splice:[].splice};h.fn.init.prototype=h.fn;h.extend=h.fn.extend=function(){var a,c,d,s,t,e,g=arguments[0]||{},i=1,j=arguments.length,k=!1;"boolean"==typeof g&&(k=g,g=arguments[1]||{},i=2);"object"==typeof g||h.isFunction(g)||(g={});for(j===
i&&(g=this,--i);j>i;i++)if(null!=(a=arguments[i]))for(c in a)d=g[c],s=a[c],g!==s&&(k&&s&&(h.isPlainObject(s)||(t=h.isArray(s)))?(t?(t=!1,e=d&&h.isArray(d)?d:[]):e=d&&h.isPlainObject(d)?d:{},g[c]=h.extend(k,e,s)):s!==b&&(g[c]=s));return g};h.extend({expando:"jQuery"+("2.0.0"+Math.random()).replace(/\D/g,""),noConflict:function(b){return a.$===h&&(a.$=nc),b&&a.jQuery===h&&(a.jQuery=mc),h},isReady:!1,readyWait:1,holdReady:function(a){a?h.readyWait++:h.ready(!0)},ready:function(a){(!0===a?--h.readyWait:
h.isReady)||(h.isReady=!0,!0!==a&&0<--h.readyWait||(Da.resolveWith(x,[h]),h.fn.trigger&&h(x).trigger("ready").off("ready")))},isFunction:function(a){return"function"===h.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?Fa[oc.call(a)]||"object":typeof a},isPlainObject:function(a){if("object"!==h.type(a)||a.nodeType||h.isWindow(a))return!1;
try{if(a.constructor&&!Za.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}return!0},isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw Error(a);},parseHTML:function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1);var b=b||x,d=xb.exec(a),c=!c&&[];return d?[b.createElement(d[1])]:(d=h.buildFragment([a],b,c),c&&h(c).remove(),h.merge([],d.childNodes))},parseJSON:JSON.parse,parseXML:function(a){var c,d;if(!a||"string"!=
typeof a)return null;try{d=new DOMParser,c=d.parseFromString(a,"text/xml")}catch(s){c=b}return(!c||c.getElementsByTagName("parsererror").length)&&h.error("Invalid XML: "+a),c},noop:function(){},globalEval:function(a){var b,c=eval;(a=h.trim(a))&&(1===a.indexOf("use strict")?(b=x.createElement("script"),b.text=a,x.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(rc,"ms-").replace(sc,tc)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===
b.toLowerCase()},each:function(a,b,d){var s,h=0,e=a.length,g=c(a);if(d)if(g)for(;e>h&&!(s=b.apply(a[h],d),!1===s);h++);else for(h in a){if(s=b.apply(a[h],d),!1===s)break}else if(g)for(;e>h&&!(s=b.call(a[h],h,a[h]),!1===s);h++);else for(h in a)if(s=b.call(a[h],h,a[h]),!1===s)break;return a},trim:function(a){return null==a?"":pc.call(a)},makeArray:function(a,b){var d=b||[];return null!=a&&(c(Object(a))?h.merge(d,"string"==typeof a?[a]:a):Ya.call(d,a)),d},inArray:function(a,b,c){return null==b?-1:Aa.call(b,
a,c)},merge:function(a,c){var d=c.length,s=a.length,h=0;if("number"==typeof d)for(;d>h;h++)a[s++]=c[h];else for(;c[h]!==b;)a[s++]=c[h++];return a.length=s,a},grep:function(a,b,c){for(var d,h=[],e=0,g=a.length,c=!!c;g>e;e++)d=!!b(a[e],e),c!==d&&h.push(a[e]);return h},map:function(a,b,d){var h,e=0,g=a.length,i=[];if(c(a))for(;g>e;e++)h=b(a[e],e,d),null!=h&&(i[i.length]=h);else for(e in a)h=b(a[e],e,d),null!=h&&(i[i.length]=h);return wb.apply([],i)},guid:1,proxy:function(a,c){var d,s,e;return"string"==
typeof c&&(d=a[c],c=a,a=d),h.isFunction(a)?(s=ka.call(arguments,2),e=function(){return a.apply(c||this,s.concat(ka.call(arguments)))},e.guid=a.guid=a.guid||h.guid++,e):b},access:function(a,c,d,s,e,g,i){var j=0,k=a.length,l=null==d;if("object"===h.type(d))for(j in e=!0,d)h.access(a,c,j,d[j],!0,g,i);else if(s!==b&&(e=!0,h.isFunction(s)||(i=!0),l&&(i?(c.call(a,s),c=null):(l=c,c=function(a,b,c){return l.call(h(a),c)})),c))for(;k>j;j++)c(a[j],d,i?s:s.call(a[j],j,c(a[j],d)));return e?a:l?c.call(a):k?c(a[0],
d):g},now:Date.now,swap:function(a,b,c,d){var h,e={};for(h in b)e[h]=a.style[h],a.style[h]=b[h];c=c.apply(a,d||[]);for(h in b)a.style[h]=e[h];return c}});h.ready.promise=function(b){return Da||(Da=h.Deferred(),"complete"===x.readyState?setTimeout(h.ready):(x.addEventListener("DOMContentLoaded",Ia,!1),a.addEventListener("load",Ia,!1))),Da.promise(b)};h.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){Fa["[object "+b+"]"]=b.toLowerCase()});ub=h(x);var $a=
a,ab=function(){var a,b=[];return a=function(c,d){return b.push(c+=" ")>y.cacheLength&&delete a[b.shift()],a[c]=d}},U=function(a){return a[E]=!0,a},Y=function(a){var b=J.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b)}},C=function(a,b,c,d){var h,e,g,i,j;if((b?b.ownerDocument||b:ba)!==J&&sa(b),b=b||J,c=c||[],!a||"string"!=typeof a)return c;if(1!==(i=b.nodeType)&&9!==i)return[];if(V&&!d){if(h=uc.exec(a))if(g=h[1])if(9===i){if(e=b.getElementById(g),
!e||!e.parentNode)return c;if(e.id===g)return c.push(e),c}else{if(b.ownerDocument&&(e=b.ownerDocument.getElementById(g))&&wa(b,e)&&e.id===g)return c.push(e),c}else{if(h[2])return ca.apply(c,b.getElementsByTagName(a)),c;if((g=h[3])&&A.getElementsByClassName&&b.getElementsByClassName)return ca.apply(c,b.getElementsByClassName(g)),c}if(A.qsa&&(!O||!O.test(a))){if(e=h=E,g=b,j=9===i&&a,1===i&&"object"!==b.nodeName.toLowerCase()){i=Ja(a);(h=b.getAttribute("id"))?e=h.replace(vc,"\\$&"):b.setAttribute("id",
e);e="[id='"+e+"'] ";for(g=i.length;g--;)i[g]=e+Ka(i[g]);g=bb.test(a)&&b.parentNode||b;j=i.join(",")}if(j)try{return ca.apply(c,g.querySelectorAll(j)),c}catch(k){}finally{h||b.removeAttribute("id")}}}var l;a:{var a=a.replace(La,"$1"),M,n;e=Ja(a);if(!d&&1===e.length){if(l=e[0]=e[0].slice(0),2<l.length&&"ID"===(M=l[0]).type&&9===b.nodeType&&V&&y.relative[l[1].type]){if(b=(y.find.ID(M.matches[0].replace(da,ea),b)||[])[0],!b){l=c;break a}a=a.slice(l.shift().value.length)}for(i=Ma.needsContext.test(a)?
0:l.length;i--&&!(M=l[i],y.relative[h=M.type]);)if((n=y.find[h])&&(d=n(M.matches[0].replace(da,ea),bb.test(l[0].type)&&b.parentNode||b))){if(l.splice(i,1),a=d.length&&Ka(l),!a){l=(ca.apply(c,d),c);break a}break}}l=(cb(a,e)(d,b,!V,c,bb.test(a)),c)}return l},zb=function(a,b){var c=b&&a,d=c&&(~b.sourceIndex||yb)-(~a.sourceIndex||yb);if(d)return d;if(c)for(;c=c.nextSibling;)if(c===b)return-1;return a?1:-1},wc=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&d.specified?d.value:!0===a[b]?
b.toLowerCase():null},xc=function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)},yc=function(a){return function(b){return"input"===b.nodeName.toLowerCase()&&b.type===a}},zc=function(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}},la=function(a){return U(function(b){return b=+b,U(function(c,d){for(var h,e=a([],c.length,b),g=e.length;g--;)c[h=e[g]]&&(c[h]=!(d[h]=c[h]))})})},Ja=function(a,b){var c,d,h,e,g,i,j;if(g=Ab[a+" "])return b?
0:g.slice(0);g=a;i=[];for(j=y.preFilter;g;){(!c||(d=Ac.exec(g)))&&(d&&(g=g.slice(d[0].length)||g),i.push(h=[]));c=!1;(d=Bc.exec(g))&&(c=d.shift(),h.push({value:c,type:d[0].replace(La," ")}),g=g.slice(c.length));for(e in y.filter)!(d=Ma[e].exec(g))||j[e]&&!(d=j[e](d))||(c=d.shift(),h.push({value:c,type:e,matches:d}),g=g.slice(c.length));if(!c)break}return b?g.length:g?C.error(a):Ab(a,i).slice(0)},Ka=function(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d},db=function(a,b,c){var d=b.dir,
h=c&&"parentNode"===d,e=Cc++;return b.first?function(b,c,u){for(;b=b[d];)if(1===b.nodeType||h)return a(b,c,u)}:function(b,c,u){var G,g,i,j=Z+" "+e;if(u)for(;b=b[d];){if((1===b.nodeType||h)&&a(b,c,u))return!0}else for(;b=b[d];)if(1===b.nodeType||h)if(i=b[E]||(b[E]={}),(g=i[d])&&g[0]===j){if(!0===(G=g[1])||G===Na)return!0===G}else if(g=i[d]=[j],g[1]=a(b,c,u)||Na,!0===g[1])return!0}},eb=function(a){return 1<a.length?function(b,c,d){for(var h=a.length;h--;)if(!a[h](b,c,d))return!1;return!0}:a[0]},Oa=
function(a,b,c,d,h){for(var e,g=[],i=0,j=a.length,k=null!=b;j>i;i++)(e=a[i])&&(!c||c(e,d,h))&&(g.push(e),k&&b.push(i));return g},fb=function(a,b,c,d,h,e){return d&&!d[E]&&(d=fb(d)),h&&!h[E]&&(h=fb(h,e)),U(function(e,g,i,Q){var j,k,l=[],n=[],p=g.length,q;if(!(q=e)){q=b||"*";for(var m=i.nodeType?[i]:i,r=[],z=0,H=m.length;H>z;z++)C(q,m[z],r);q=r}q=!a||!e&&b?q:Oa(q,l,a,i,Q);m=c?h||(e?a:p||d)?[]:g:q;if(c&&c(q,m,i,Q),d){j=Oa(m,n);d(j,[],i,Q);for(i=j.length;i--;)(k=j[i])&&(m[n[i]]=!(q[n[i]]=k))}if(e){if(h||
a){if(h){j=[];for(i=m.length;i--;)(k=m[i])&&j.push(q[i]=k);h(null,m=[],j,Q)}for(i=m.length;i--;)(k=m[i])&&-1<(j=h?ma.call(e,k):l[i])&&(e[j]=!(g[j]=k))}}else m=Oa(m===g?m.splice(p,m.length):m),h?h(null,g,m,Q):ca.apply(g,m)})},gb=function(a){var b,c,d,h=a.length,e=y.relative[a[0].type];c=e||y.relative[" "];for(var g=e?1:0,i=db(function(a){return a===b},c,!0),j=db(function(a){return-1<ma.call(b,a)},c,!0),k=[function(a,c,d){return!e&&(d||c!==Pa)||((b=c).nodeType?i(a,c,d):j(a,c,d))}];h>g;g++)if(c=y.relative[a[g].type])k=
[db(eb(k),c)];else{if(c=y.filter[a[g].type].apply(null,a[g].matches),c[E]){for(d=++g;h>d&&!y.relative[a[d].type];d++);return fb(1<g&&eb(k),1<g&&Ka(a.slice(0,g-1)).replace(La,"$1"),c,d>g&&gb(a.slice(g,d)),h>d&&gb(a=a.slice(d)),h>d&&Ka(a))}k.push(c)}return eb(k)},Bb=function(){},ta,Na,y,Qa,Cb,cb,Pa,na,sa,J,aa,V,O,oa,Ra,wa,E="sizzle"+-new Date,ba=$a.document,A={},Z=0,Cc=0,Db=ab(),Ab=ab(),Eb=ab(),xa=!1,Sa=function(){return 0},yb=-2147483648,fa=[],Dc=fa.pop,Ec=fa.push,ca=fa.push,Fb=fa.slice,ma=fa.indexOf||
function(a){for(var b=0,c=this.length;c>b;b++)if(this[b]===a)return b;return-1},Gb="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+".replace("w","w#"),Hb="\\[[\\x20\\t\\r\\n\\f]*((?:\\\\.|[\\w-]|[^\\x00-\\xa0])+)[\\x20\\t\\r\\n\\f]*(?:([*^$|!~]?=)[\\x20\\t\\r\\n\\f]*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+Gb+")|)|)[\\x20\\t\\r\\n\\f]*\\]",hb=":((?:\\\\.|[\\w-]|[^\\x00-\\xa0])+)(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+Hb.replace(3,8)+")*)|.*)\\)|)",La=/^[\x20\t\r\n\f]+|((?:^|[^\\])(?:\\.)*)[\x20\t\r\n\f]+$/g,
Ac=/^[\x20\t\r\n\f]*,[\x20\t\r\n\f]*/,Bc=/^[\x20\t\r\n\f]*([>+~]|[\x20\t\r\n\f])[\x20\t\r\n\f]*/,bb=/[\x20\t\r\n\f]*[+~]/,Fc=/=[\x20\t\r\n\f]*([^\]'"]*)[\x20\t\r\n\f]*\]/g,Gc=RegExp(hb),Hc=RegExp("^"+Gb+"$"),Ma={ID:/^#((?:\\.|[\w-]|[^\x00-\xa0])+)/,CLASS:/^\.((?:\\.|[\w-]|[^\x00-\xa0])+)/,TAG:RegExp("^("+"(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+".replace("w","w*")+")"),ATTR:RegExp("^"+Hb),PSEUDO:RegExp("^"+hb),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\([\\x20\\t\\r\\n\\f]*(even|odd|(([+-]|)(\\d*)n|)[\\x20\\t\\r\\n\\f]*(?:([+-]|)[\\x20\\t\\r\\n\\f]*(\\d+)|))[\\x20\\t\\r\\n\\f]*\\)|)",
"i"),"boolean":RegExp("^(?:checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped)$","i"),needsContext:RegExp("^[\\x20\\t\\r\\n\\f]*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\([\\x20\\t\\r\\n\\f]*((?:-\\d)?\\d*)[\\x20\\t\\r\\n\\f]*\\)|)(?=[^-]|$)","i")},ib=/^[^{]+\{\s*\[native \w/,uc=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,Ic=/^(?:input|select|textarea|button)$/i,Jc=/^h\d$/i,vc=/'|\\/g,da=/\\([\da-fA-F]{1,6}[\x20\t\r\n\f]?|.)/g,ea=
function(a,b){var c="0x"+b-65536;return c!==c?b:0>c?String.fromCharCode(c+65536):String.fromCharCode(55296|c>>10,56320|1023&c)};try{ca.apply(fa=Fb.call(ba.childNodes),ba.childNodes),fa[ba.childNodes.length].nodeType}catch(jd){ca={apply:fa.length?function(a,b){Ec.apply(a,Fb.call(b))}:function(a,b){for(var c=a.length,d=0;a[c++]=b[d++];);a.length=c-1}}}Cb=C.isXML=function(a){return(a=a&&(a.ownerDocument||a).documentElement)?"HTML"!==a.nodeName:!1};sa=C.setDocument=function(a){var b=a?a.ownerDocument||
a:ba;if(b!==J&&9===b.nodeType&&b.documentElement){J=b;aa=b.documentElement;V=!Cb(b);A.getElementsByTagName=Y(function(a){return a.appendChild(b.createComment("")),!a.getElementsByTagName("*").length});A.attributes=Y(function(a){return a.className="i",!a.getAttribute("className")});A.getElementsByClassName=Y(function(a){return a.innerHTML="<div class='a'></div><div class='a i'></div>",a.firstChild.className="i",2===a.getElementsByClassName("i").length});A.sortDetached=Y(function(a){return 1&a.compareDocumentPosition(J.createElement("div"))});
A.getById=Y(function(a){return aa.appendChild(a).id=E,!b.getElementsByName||!b.getElementsByName(E).length});A.getById?(y.find.ID=function(a,b){if("undefined"!==typeof b.getElementById&&V){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},y.filter.ID=function(a){var b=a.replace(da,ea);return function(a){return a.getAttribute("id")===b}}):(y.find.ID=function(a,b){if("undefined"!==typeof b.getElementById&&V){var c=b.getElementById(a);return c?c.id===a||"undefined"!==typeof c.getAttributeNode&&
c.getAttributeNode("id").value===a?[c]:void 0:[]}},y.filter.ID=function(a){var b=a.replace(da,ea);return function(a){return(a="undefined"!==typeof a.getAttributeNode&&a.getAttributeNode("id"))&&a.value===b}});y.find.TAG=A.getElementsByTagName?function(a,b){return"undefined"!==typeof b.getElementsByTagName?b.getElementsByTagName(a):void 0}:function(a,b){var c,d=[],w=0,h=b.getElementsByTagName(a);if("*"===a){for(;c=h[w++];)1===c.nodeType&&d.push(c);return d}return h};y.find.CLASS=A.getElementsByClassName&&
function(a,b){return"undefined"!==typeof b.getElementsByClassName&&V?b.getElementsByClassName(a):void 0};oa=[];O=[];(A.qsa=ib.test(b.querySelectorAll+""))&&(Y(function(a){a.innerHTML="<select><option selected=''></option></select>";a.querySelectorAll("[selected]").length||O.push("\\[[\\x20\\t\\r\\n\\f]*(?:value|checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped)");a.querySelectorAll(":checked").length||O.push(":checked")}),Y(function(a){var b=
J.createElement("input");b.setAttribute("type","hidden");a.appendChild(b).setAttribute("t","");a.querySelectorAll("[t^='']").length&&O.push("[*^$]=[\\x20\\t\\r\\n\\f]*(?:''|\"\")");a.querySelectorAll(":enabled").length||O.push(":enabled",":disabled");a.querySelectorAll("*,:x");O.push(",.*:")}));var a=A,c;c=Ra=aa.webkitMatchesSelector||aa.mozMatchesSelector||aa.oMatchesSelector||aa.msMatchesSelector;c=ib.test(c+"");a=((a.matchesSelector=c)&&Y(function(a){A.disconnectedMatch=Ra.call(a,"div");Ra.call(a,
"[s!='']:x");oa.push("!=",hb)}),O=O.length&&RegExp(O.join("|")),oa=oa.length&&RegExp(oa.join("|")),wa=ib.test(aa.contains+"")||aa.compareDocumentPosition?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},Sa=aa.compareDocumentPosition?function(a,c){if(a===c)return xa=!0,0;var d=c.compareDocumentPosition&&
a.compareDocumentPosition&&a.compareDocumentPosition(c);return d?1&d||!A.sortDetached&&c.compareDocumentPosition(a)===d?a===b||wa(ba,a)?-1:c===b||wa(ba,c)?1:na?ma.call(na,a)-ma.call(na,c):0:4&d?-1:1:a.compareDocumentPosition?-1:1}:function(a,c){var d,w=0;d=a.parentNode;var h=c.parentNode,e=[a],g=[c];if(a===c)return xa=!0,0;if(!d||!h)return a===b?-1:c===b?1:d?-1:h?1:na?ma.call(na,a)-ma.call(na,c):0;if(d===h)return zb(a,c);for(d=a;d=d.parentNode;)e.unshift(d);for(d=c;d=d.parentNode;)g.unshift(d);for(;e[w]===
g[w];)w++;return w?zb(e[w],g[w]):e[w]===ba?-1:g[w]===ba?1:0},J)}else a=J;return a};C.matches=function(a,b){return C(a,null,null,b)};C.matchesSelector=function(a,b){if((a.ownerDocument||a)!==J&&sa(a),b=b.replace(Fc,"='$1']"),!(!A.matchesSelector||!V||oa&&oa.test(b)||O&&O.test(b)))try{var c=Ra.call(a,b);if(c||A.disconnectedMatch||a.document&&11!==a.document.nodeType)return c}catch(d){}return 0<C(b,J,null,[a]).length};C.contains=function(a,b){return(a.ownerDocument||a)!==J&&sa(a),wa(a,b)};C.attr=function(a,
b){(a.ownerDocument||a)!==J&&sa(a);var c=y.attrHandle[b.toLowerCase()],c=c&&c(a,b,!V);return void 0===c?A.attributes||!V?a.getAttribute(b):(c=a.getAttributeNode(b))&&c.specified?c.value:null:c};C.error=function(a){throw Error("Syntax error, unrecognized expression: "+a);};C.uniqueSort=function(a){var b,c=[],d=0,h=0;if(xa=!A.detectDuplicates,na=!A.sortStable&&a.slice(0),a.sort(Sa),xa){for(;b=a[h++];)b===a[h]&&(d=c.push(h));for(;d--;)a.splice(c[d],1)}return a};Qa=C.getText=function(a){var b,c="",d=
0;if(b=a.nodeType)if(1===b||9===b||11===b){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=Qa(a)}else{if(3===b||4===b)return a.nodeValue}else for(;b=a[d];d++)c+=Qa(b);return c};y=C.selectors={cacheLength:50,createPseudo:U,match:Ma,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(da,ea),a[3]=(a[4]||
a[5]||"").replace(da,ea),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||C.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&C.error(a[0]),a},PSEUDO:function(a){var b,c=!a[5]&&a[2];return Ma.CHILD.test(a[0])?null:(a[4]?a[2]=a[4]:c&&Gc.test(c)&&(b=Ja(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=
a.replace(da,ea).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=Db[a+" "];return b||(b=RegExp("(^|[\\x20\\t\\r\\n\\f])"+a+"([\\x20\\t\\r\\n\\f]|$)"))&&Db(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!==typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){d=C.attr(d,a);return null==d?"!="===b:b?(d+="","="===b?d===c:"!="===b?d!==c:"^="===
b?c&&0===d.indexOf(c):"*="===b?c&&-1<d.indexOf(c):"$="===b?c&&d.slice(-c.length)===c:"~="===b?-1<(" "+d+" ").indexOf(c):"|="===b?d===c||d.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,h){var e="nth"!==a.slice(0,3),g="last"!==a.slice(-4),i="of-type"===b;return 1===d&&0===h?function(a){return!!a.parentNode}:function(b,c,u){var G,j,k,l,n,c=e!==g?"nextSibling":"previousSibling",p=b.parentNode,m=i&&b.nodeName.toLowerCase(),u=!u&&!i;if(p){if(e){for(;c;){for(j=b;j=j[c];)if(i?j.nodeName.toLowerCase()===
m:1===j.nodeType)return!1;n=c="only"===a&&!n&&"nextSibling"}return!0}if(n=[g?p.firstChild:p.lastChild],g&&u){u=p[E]||(p[E]={});G=u[a]||[];l=G[0]===Z&&G[1];k=G[0]===Z&&G[2];for(j=l&&p.childNodes[l];j=++l&&j&&j[c]||(k=l=0)||n.pop();)if(1===j.nodeType&&++k&&j===b){u[a]=[Z,l,k];break}}else if(u&&(G=(b[E]||(b[E]={}))[a])&&G[0]===Z)k=G[1];else for(;(j=++l&&j&&j[c]||(k=l=0)||n.pop())&&(!(i?j.nodeName.toLowerCase()===m:1===j.nodeType)||!++k||!(u&&((j[E]||(j[E]={}))[a]=[Z,k]),j===b)););return k-=h,k===d||
0===k%d&&0<=k/d}}},PSEUDO:function(a,b){var c,d=y.pseudos[a]||y.setFilters[a.toLowerCase()]||C.error("unsupported pseudo: "+a);return d[E]?d(b):1<d.length?(c=[a,a,"",b],y.setFilters.hasOwnProperty(a.toLowerCase())?U(function(a,c){for(var w,h=d(a,b),e=h.length;e--;)w=ma.call(a,h[e]),a[w]=!(c[w]=h[e])}):function(a){return d(a,0,c)}):d}},pseudos:{not:U(function(a){var b=[],c=[],d=cb(a.replace(La,"$1"));return d[E]?U(function(a,b,c,w){for(var h,c=d(a,null,w,[]),w=a.length;w--;)(h=c[w])&&(a[w]=!(b[w]=
h))}):function(a,w,h){return b[0]=a,d(b,null,h,c),!c.pop()}}),has:U(function(a){return function(b){return 0<C(a,b).length}}),contains:U(function(a){return function(b){return-1<(b.textContent||b.innerText||Qa(b)).indexOf(a)}}),lang:U(function(a){return Hc.test(a||"")||C.error("unsupported lang: "+a),a=a.replace(da,ea).toLowerCase(),function(b){var c;do if(c=V?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);
return!1}}),target:function(a){var b=$a.location&&$a.location.hash;return b&&b.slice(1)===a.id},root:function(a){return a===aa},focus:function(a){return a===J.activeElement&&(!J.hasFocus||J.hasFocus())&&!(!a.type&&!a.href&&!~a.tabIndex)},enabled:function(a){return!1===a.disabled},disabled:function(a){return!0===a.disabled},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,
!0===a.selected},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if("@"<a.nodeName||3===a.nodeType||4===a.nodeType)return!1;return!0},parent:function(a){return!y.pseudos.empty(a)},header:function(a){return Jc.test(a.nodeName)},input:function(a){return Ic.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||b.toLowerCase()===
a.type)},first:la(function(){return[0]}),last:la(function(a,b){return[b-1]}),eq:la(function(a,b,c){return[0>c?c+b:c]}),even:la(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:la(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:la(function(a,b,c){for(b=0>c?c+b:c;0<=--b;)a.push(b);return a}),gt:la(function(a,b,c){for(c=0>c?c+b:c;b>++c;)a.push(c);return a})}};for(ta in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})y.pseudos[ta]=yc(ta);for(ta in{submit:!0,reset:!0})y.pseudos[ta]=
zc(ta);cb=C.compile=function(a,b){var c,d=[],h=[],e=Eb[a+" "];if(!e){b||(b=Ja(a));for(c=b.length;c--;)e=gb(b[c]),e[E]?d.push(e):h.push(e);var g=0,i=0<d.length,j=0<h.length;c=function(a,b,c,w,e){var u,G,k=[],Q=0,l="0",n=a&&[],p=null!=e,m=Pa,q=a||j&&y.find.TAG("*",e&&b.parentNode||b),r=Z+=null==m?1:Math.random()||0.1;for(p&&(Pa=b!==J&&b,Na=g);null!=(e=q[l]);l++){if(j&&e){for(u=0;G=h[u++];)if(G(e,b,c)){w.push(e);break}p&&(Z=r,Na=++g)}i&&((e=!G&&e)&&Q--,a&&n.push(e))}if(Q+=l,i&&l!==Q){for(u=0;G=d[u++];)G(n,
k,b,c);if(a){if(0<Q)for(;l--;)n[l]||k[l]||(k[l]=Dc.call(w));k=Oa(k)}ca.apply(w,k);p&&!a&&0<k.length&&1<Q+d.length&&C.uniqueSort(w)}return p&&(Z=r,Pa=m),n};c=i?U(c):c;e=Eb(a,c)}return e};y.pseudos.nth=y.pseudos.eq;Bb.prototype=y.filters=y.pseudos;y.setFilters=new Bb;A.sortStable=E.split("").sort(Sa).join("")===E;sa();[0,0].sort(Sa);A.detectDuplicates=xa;Y(function(a){if(a.innerHTML="<a href='#'></a>","#"!==a.firstChild.getAttribute("href"))for(var a=["type","href","height","width"],b=a.length;b--;)y.attrHandle[a[b]]=
xc});Y(function(a){if(null!=a.getAttribute("disabled"))for(var a="checked selected async autofocus autoplay controls defer disabled hidden ismap loop multiple open readonly required scoped".split(" "),b=a.length;b--;)y.attrHandle[a[b]]=wc});h.find=C;h.expr=C.selectors;h.expr[":"]=h.expr.pseudos;h.unique=C.uniqueSort;h.text=C.getText;h.isXMLDoc=C.isXML;h.contains=C.contains;var Ib={};h.Callbacks=function(a){var c;if("string"==typeof a){if(!(c=Ib[a])){c=a;var d=Ib[c]={};c=(h.each(c.match(X)||[],function(a,
b){d[b]=!0}),d)}}else c=h.extend({},a);var a=c,e,g,i,j,k,l,n=[],p=!a.once&&[],M=function(b){e=a.memory&&b;g=!0;l=j||0;j=0;k=n.length;for(i=!0;n&&k>l;l++)if(!1===n[l].apply(b[0],b[1])&&a.stopOnFalse){e=!1;break}i=!1;n&&(p?p.length&&M(p.shift()):e?n=[]:m.disable())},m={add:function(){if(n){var b=n.length;(function kc(b){h.each(b,function(b,c){var d=h.type(c);"function"===d?a.unique&&m.has(c)||n.push(c):c&&c.length&&"string"!==d&&kc(c)})})(arguments);i?k=n.length:e&&(j=b,M(e))}return this},remove:function(){return n&&
h.each(arguments,function(a,b){for(var c;-1<(c=h.inArray(b,n,c));)n.splice(c,1),i&&(k>=c&&k--,l>=c&&l--)}),this},has:function(a){return a?-1<h.inArray(a,n):!(!n||!n.length)},empty:function(){return n=[],k=0,this},disable:function(){return n=p=e=b,this},disabled:function(){return!n},lock:function(){return p=b,e||m.disable(),this},locked:function(){return!p},fireWith:function(a,b){return b=b||[],b=[a,b.slice?b.slice():b],!n||g&&!p||(i?p.push(b):M(b)),this},fire:function(){return m.fireWith(this,arguments),
this},fired:function(){return!!g}};return m};h.extend({Deferred:function(a){var b=[["resolve","done",h.Callbacks("once memory"),"resolved"],["reject","fail",h.Callbacks("once memory"),"rejected"],["notify","progress",h.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return h.Deferred(function(c){h.each(b,function(b,w){var g=w[0],u=h.isFunction(a[b])&&a[b];e[w[1]](function(){var a=u&&u.apply(this,
arguments);a&&h.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[g+"With"](this===d?c.promise():this,u?[a]:arguments)})});a=null}).promise()},promise:function(a){return null!=a?h.extend(a,d):d}},e={};return d.pipe=d.then,h.each(b,function(a,w){var h=w[2],g=w[3];d[w[1]]=h.add;g&&h.add(function(){c=g},b[1^a][2].disable,b[2][2].lock);e[w[0]]=function(){return e[w[0]+"With"](this===e?d:this,arguments),this};e[w[0]+"With"]=h.fireWith}),d.promise(e),a&&a.call(e,e),e},
when:function(a){var b=0,c=ka.call(arguments),d=c.length,e=1!==d||a&&h.isFunction(a.promise)?d:0,g=1===e?a:h.Deferred(),i=function(a,b,c){return function(d){b[a]=this;c[a]=1<arguments.length?ka.call(arguments):d;c===j?g.notifyWith(b,c):--e||g.resolveWith(b,c)}},j,k,l;if(1<d){j=Array(d);k=Array(d);for(l=Array(d);d>b;b++)c[b]&&h.isFunction(c[b].promise)?c[b].promise().done(i(b,l,c)).fail(g.reject).progress(i(b,k,j)):--e}return e||g.resolveWith(l,c),g.promise()}});var Kc=h,Jb,K={},S=x.createElement("input"),
Kb=x.createDocumentFragment(),T=x.createElement("div"),Lb=x.createElement("select"),Mb=Lb.appendChild(x.createElement("option"));Jb=S.type?(S.type="checkbox",K.checkOn=""!==S.value,K.optSelected=Mb.selected,K.reliableMarginRight=!0,K.boxSizingReliable=!0,K.pixelPosition=!1,S.checked=!0,K.noCloneChecked=S.cloneNode(!0).checked,Lb.disabled=!0,K.optDisabled=!Mb.disabled,S=x.createElement("input"),S.value="t",S.type="radio",K.radioValue="t"===S.value,S.setAttribute("checked","t"),S.setAttribute("name",
"t"),Kb.appendChild(S),K.checkClone=Kb.cloneNode(!0).cloneNode(!0).lastChild.checked,K.focusinBubbles="onfocusin"in a,T.style.backgroundClip="content-box",T.cloneNode(!0).style.backgroundClip="",K.clearCloneStyle="content-box"===T.style.backgroundClip,h(function(){var b,c,d=x.getElementsByTagName("body")[0];d&&(b=x.createElement("div"),b.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",d.appendChild(b).appendChild(T),T.innerHTML="",T.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",
h.swap(d,null!=d.style.zoom?{zoom:1}:{},function(){K.boxSizing=4===T.offsetWidth}),a.getComputedStyle&&(K.pixelPosition="1%"!==(a.getComputedStyle(T,null)||{}).top,K.boxSizingReliable="4px"===(a.getComputedStyle(T,null)||{width:"4px"}).width,c=T.appendChild(x.createElement("div")),c.style.cssText=T.style.cssText="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",c.style.marginRight=c.style.width="0",T.style.width="1px",K.reliableMarginRight=
!parseFloat((a.getComputedStyle(c,null)||{}).marginRight)),d.removeChild(b))}),K):K;Kc.support=Jb;var F,v,ec=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,dc=/([A-Z])/g;d.uid=1;d.accepts=function(a){return a.nodeType?1===a.nodeType||9===a.nodeType:!0};d.prototype={key:function(a){if(!d.accepts(a))return 0;var b={},c=a[this.expando];if(!c){c=d.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(e){b[this.expando]=c,h.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,
a=this.key(a),e=this.cache[a];if("string"==typeof b)e[b]=c;else if(h.isEmptyObject(e))this.cache[a]=b;else for(d in b)e[d]=b[d]},get:function(a,c){var d=this.cache[this.key(a)];return c===b?d:d[c]},access:function(a,c,d){return c===b||c&&"string"==typeof c&&d===b?this.get(a,c):(this.set(a,c,d),d!==b?d:c)},remove:function(a,c){var d,e;d=this.key(a);var g=this.cache[d];if(c===b)this.cache[d]={};else{h.isArray(c)?e=c.concat(c.map(h.camelCase)):c in g?e=[c]:(e=h.camelCase(c),e=e in g?[e]:e.match(X)||
[]);for(d=e.length;d--;)delete g[e[d]]}},hasData:function(a){return!h.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){delete this.cache[this.key(a)]}};F=new d;v=new d;h.extend({acceptData:d.accepts,hasData:function(a){return F.hasData(a)||v.hasData(a)},data:function(a,b,c){return F.access(a,b,c)},removeData:function(a,b){F.remove(a,b)},_data:function(a,b,c){return v.access(a,b,c)},_removeData:function(a,b){v.remove(a,b)}});h.fn.extend({data:function(a,c){var d,g,i=this[0],j=0,
k=null;if(a===b){if(this.length&&(k=F.get(i),1===i.nodeType&&!v.get(i,"hasDataAttrs"))){for(d=i.attributes;d.length>j;j++)g=d[j].name,0===g.indexOf("data-")&&(g=h.camelCase(g.substring(5)),e(i,g,k[g]));v.set(i,"hasDataAttrs",!0)}return k}return"object"==typeof a?this.each(function(){F.set(this,a)}):h.access(this,function(c){var d,g=h.camelCase(a);if(i&&c===b){if((d=F.get(i,a),d!==b)||(d=F.get(i,g),d!==b)||(d=e(i,g,b),d!==b))return d}else this.each(function(){var d=F.get(this,g);F.set(this,g,c);-1!==
a.indexOf("-")&&d!==b&&F.set(this,a,c)})},null,c,1<arguments.length,null,!0)},removeData:function(a){return this.each(function(){F.remove(this,a)})}});h.extend({queue:function(a,c,d){var e;return a?(c=(c||"fx")+"queue",e=v.get(a,c),d&&(!e||h.isArray(d)?e=v.access(a,c,h.makeArray(d)):e.push(d)),e||[]):b},dequeue:function(a,b){var b=b||"fx",c=h.queue(a,b),d=c.length,e=c.shift(),g=h._queueHooks(a,b),i=function(){h.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--);(g.cur=e)&&("fx"===b&&c.unshift("inprogress"),
delete g.stop,e.call(a,i,g));!d&&g&&g.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return v.get(a,c)||v.access(a,c,{empty:h.Callbacks("once memory").add(function(){v.remove(a,[b+"queue",c])})})}});h.fn.extend({queue:function(a,c){var d=2;return"string"!=typeof a&&(c=a,a="fx",d--),d>arguments.length?h.queue(this[0],a):c===b?this:this.each(function(){var b=h.queue(this,a,c);h._queueHooks(this,a);"fx"===a&&"inprogress"!==b[0]&&h.dequeue(this,a)})},dequeue:function(a){return this.each(function(){h.dequeue(this,
a)})},delay:function(a,b){return a=h.fx?h.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){var d,e=1,g=h.Deferred(),i=this,j=this.length,k=function(){--e||g.resolveWith(i,[i])};"string"!=typeof a&&(c=a,a=b);for(a=a||"fx";j--;)(d=v.get(i[j],a+"queueHooks"))&&d.empty&&(e++,d.empty.add(k));return k(),g.promise(c)}});var Nb,jb=/[\t\r\n]/g,Lc=/\r/g,Mc=/^(?:input|select|textarea|button)$/i;
h.fn.extend({attr:function(a,b){return h.access(this,h.attr,a,b,1<arguments.length)},removeAttr:function(a){return this.each(function(){h.removeAttr(this,a)})},prop:function(a,b){return h.access(this,h.prop,a,b,1<arguments.length)},removeProp:function(a){return this.each(function(){delete this[h.propFix[a]||a]})},addClass:function(a){var b,c,d,e,g,i=0,j=this.length;b="string"==typeof a&&a;if(h.isFunction(a))return this.each(function(b){h(this).addClass(a.call(this,b,this.className))});if(b)for(b=
(a||"").match(X)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(jb," "):" ")){for(g=0;e=b[g++];)0>d.indexOf(" "+e+" ")&&(d+=e+" ");c.className=h.trim(d)}return this},removeClass:function(a){var b,c,d,e,g,i=0,j=this.length;b=0===arguments.length||"string"==typeof a&&a;if(h.isFunction(a))return this.each(function(b){h(this).removeClass(a.call(this,b,this.className))});if(b)for(b=(a||"").match(X)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+
" ").replace(jb," "):"")){for(g=0;e=b[g++];)for(;0<=d.indexOf(" "+e+" ");)d=d.replace(" "+e+" "," ");c.className=a?h.trim(d):""}return this},toggleClass:function(a,b){var c=typeof a,d="boolean"==typeof b;return h.isFunction(a)?this.each(function(c){h(this).toggleClass(a.call(this,c,this.className,b),b)}):this.each(function(){if("string"===c)for(var e,g=0,i=h(this),j=b,k=a.match(X)||[];e=k[g++];)j=d?j:!i.hasClass(e),i[j?"addClass":"removeClass"](e);else(c===Ea||"boolean"===c)&&(this.className&&v.set(this,
"__className__",this.className),this.className=this.className||!1===a?"":v.get(this,"__className__")||"")})},hasClass:function(a){for(var a=" "+a+" ",b=0,c=this.length;c>b;b++)if(1===this[b].nodeType&&0<=(" "+this[b].className+" ").replace(jb," ").indexOf(a))return!0;return!1},val:function(a){var c,d,e,g=this[0];if(arguments.length)return e=h.isFunction(a),this.each(function(d){var g,i=h(this);1===this.nodeType&&(g=e?a.call(this,d,i.val()):a,null==g?g="":"number"==typeof g?g+="":h.isArray(g)&&(g=
h.map(g,function(a){return null==a?"":a+""})),c=h.valHooks[this.type]||h.valHooks[this.nodeName.toLowerCase()],c&&"set"in c&&c.set(this,g,"value")!==b||(this.value=g))});if(g)return c=h.valHooks[g.type]||h.valHooks[g.nodeName.toLowerCase()],c&&"get"in c&&(d=c.get(g,"value"))!==b?d:(d=g.value,"string"==typeof d?d.replace(Lc,""):null==d?"":d)}});h.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){for(var b,c=a.options,d=
a.selectedIndex,e="select-one"===a.type||0>d,g=e?null:[],i=e?d+1:c.length,j=0>d?i:e?d:0;i>j;j++)if(b=c[j],!(!b.selected&&j!==d||(h.support.optDisabled?b.disabled:null!==b.getAttribute("disabled"))||b.parentNode.disabled&&h.nodeName(b.parentNode,"optgroup"))){if(a=h(b).val(),e)return a;g.push(a)}return g},set:function(a,b){for(var c,d,e=a.options,g=h.makeArray(b),i=e.length;i--;)d=e[i],(d.selected=0<=h.inArray(h(d).val(),g))&&(c=!0);return c||(a.selectedIndex=-1),g}}},attr:function(a,c,d){var e,g,
i=a.nodeType;if(a&&3!==i&&8!==i&&2!==i)return typeof a.getAttribute===Ea?h.prop(a,c,d):(1===i&&h.isXMLDoc(a)||(c=c.toLowerCase(),e=h.attrHooks[c]||(h.expr.match.boolean.test(c)?Nb:void 0)),d===b?e&&"get"in e&&null!==(g=e.get(a,c))?g:(g=h.find.attr(a,c),null==g?b:g):null!==d?e&&"set"in e&&(g=e.set(a,d,c))!==b?g:(a.setAttribute(c,d+""),d):(h.removeAttr(a,c),b))},removeAttr:function(a,b){var c,d,e=0,g=b&&b.match(X);if(g&&1===a.nodeType)for(;c=g[e++];)d=h.propFix[c]||c,h.expr.match.boolean.test(c)&&(a[d]=
!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!h.support.radioValue&&"radio"===b&&h.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},propFix:{"for":"htmlFor","class":"className"},prop:function(a,c,d){var e,g,i,j=a.nodeType;if(a&&3!==j&&8!==j&&2!==j)return i=1!==j||!h.isXMLDoc(a),i&&(c=h.propFix[c]||c,g=h.propHooks[c]),d!==b?g&&"set"in g&&(e=g.set(a,d,c))!==b?e:a[c]=d:g&&"get"in g&&null!==(e=g.get(a,c))?e:a[c]},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||
Mc.test(a.nodeName)||a.href?a.tabIndex:-1}}}});Nb={set:function(a,b,c){return!1===b?h.removeAttr(a,c):a.setAttribute(c,c),c}};h.each(h.expr.match.boolean.source.match(/\w+/g),function(a,c){var d=h.expr.attrHandle[c]||h.find.attr;h.expr.attrHandle[c]=function(a,c,e){var g=h.expr.attrHandle[c],a=e?b:(h.expr.attrHandle[c]=b)!=d(a,c,e)?c.toLowerCase():null;return h.expr.attrHandle[c]=g,a}});h.support.optSelected||(h.propHooks.selected={get:function(a){a=a.parentNode;return a&&a.parentNode&&a.parentNode.selectedIndex,
null}});h.each("tabIndex readOnly maxLength cellSpacing cellPadding rowSpan colSpan useMap frameBorder contentEditable".split(" "),function(){h.propFix[this.toLowerCase()]=this});h.each(["radio","checkbox"],function(){h.valHooks[this]={set:function(a,c){return h.isArray(c)?a.checked=0<=h.inArray(h(a).val(),c):b}};h.support.checkOn||(h.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var Nc=/^key/,Oc=/^(?:mouse|contextmenu)|click/,Ob=/^(?:focusinfocus|focusoutblur)$/,
Pb=/^([^.]*)(?:\.(.+)|)$/;h.event={global:{},add:function(a,c,d,e,g){var i,j,k,l,n,p,m,q,r,z;if(n=v.get(a)){d.handler&&(i=d,d=i.handler,g=i.selector);d.guid||(d.guid=h.guid++);(l=n.events)||(l=n.events={});(j=n.handle)||(j=n.handle=function(a){return typeof h===Ea||a&&h.event.triggered===a.type?b:h.event.dispatch.apply(j.elem,arguments)},j.elem=a);c=(c||"").match(X)||[""];for(n=c.length;n--;)k=Pb.exec(c[n])||[],r=z=k[1],k=(k[2]||"").split(".").sort(),r&&(m=h.event.special[r]||{},r=(g?m.delegateType:
m.bindType)||r,m=h.event.special[r]||{},p=h.extend({type:r,origType:z,data:e,handler:d,guid:d.guid,selector:g,needsContext:g&&h.expr.match.needsContext.test(g),namespace:k.join(".")},i),(q=l[r])||(q=l[r]=[],q.delegateCount=0,m.setup&&!1!==m.setup.call(a,e,k,j)||a.addEventListener&&a.addEventListener(r,j,!1)),m.add&&(m.add.call(a,p),p.handler.guid||(p.handler.guid=d.guid)),g?q.splice(q.delegateCount++,0,p):q.push(p),h.event.global[r]=!0);a=null}},remove:function(a,b,c,d,e){var g,i,j,k,l,n,p,m,q,r,
z,H=v.hasData(a)&&v.get(a);if(H&&(k=H.events)){b=(b||"").match(X)||[""];for(l=b.length;l--;)if(j=Pb.exec(b[l])||[],q=z=j[1],r=(j[2]||"").split(".").sort(),q){p=h.event.special[q]||{};q=(d?p.delegateType:p.bindType)||q;m=k[q]||[];j=j[2]&&RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)");for(i=g=m.length;g--;)n=m[g],!e&&z!==n.origType||c&&c.guid!==n.guid||j&&!j.test(n.namespace)||d&&d!==n.selector&&("**"!==d||!n.selector)||(m.splice(g,1),n.selector&&m.delegateCount--,p.remove&&p.remove.call(a,n));
i&&!m.length&&(p.teardown&&!1!==p.teardown.call(a,r,H.handle)||h.removeEvent(a,q,H.handle),delete k[q])}else for(q in k)h.event.remove(a,q+b[l],c,d,!0);h.isEmptyObject(k)&&(delete H.handle,v.remove(a,"events"))}},trigger:function(c,d,e,g){var i,j,k,l,n,p,m,q=[e||x],r=Za.call(c,"type")?c.type:c;i=Za.call(c,"namespace")?c.namespace.split("."):[];if(j=k=e=e||x,3!==e.nodeType&&8!==e.nodeType&&!Ob.test(r+h.event.triggered)&&(0<=r.indexOf(".")&&(i=r.split("."),r=i.shift(),i.sort()),n=0>r.indexOf(":")&&
"on"+r,c=c[h.expando]?c:new h.Event(r,"object"==typeof c&&c),c.isTrigger=g?2:3,c.namespace=i.join("."),c.namespace_re=c.namespace?RegExp("(^|\\.)"+i.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,c.result=b,c.target||(c.target=e),d=null==d?[c]:h.makeArray(d,[c]),m=h.event.special[r]||{},g||!m.trigger||!1!==m.trigger.apply(e,d))){if(!g&&!m.noBubble&&!h.isWindow(e)){l=m.delegateType||r;for(Ob.test(l+r)||(j=j.parentNode);j;j=j.parentNode)q.push(j),k=j;k===(e.ownerDocument||x)&&q.push(k.defaultView||k.parentWindow||
a)}for(i=0;(j=q[i++])&&!c.isPropagationStopped();)c.type=1<i?l:m.bindType||r,(p=(v.get(j,"events")||{})[c.type]&&v.get(j,"handle"))&&p.apply(j,d),(p=n&&j[n])&&h.acceptData(j)&&p.apply&&!1===p.apply(j,d)&&c.preventDefault();return c.type=r,g||c.isDefaultPrevented()||m._default&&!1!==m._default.apply(q.pop(),d)||!h.acceptData(e)||n&&h.isFunction(e[r])&&!h.isWindow(e)&&(k=e[n],k&&(e[n]=null),h.event.triggered=r,e[r](),h.event.triggered=b,k&&(e[n]=k)),c.result}},dispatch:function(a){var a=h.event.fix(a),
c,d,e,g,i,j=[],k=ka.call(arguments);c=(v.get(this,"events")||{})[a.type]||[];var l=h.event.special[a.type]||{};if(k[0]=a,a.delegateTarget=this,!l.preDispatch||!1!==l.preDispatch.call(this,a)){j=h.event.handlers.call(this,a,c);for(c=0;(g=j[c++])&&!a.isPropagationStopped();){a.currentTarget=g.elem;for(d=0;(i=g.handlers[d++])&&!a.isImmediatePropagationStopped();)(!a.namespace_re||a.namespace_re.test(i.namespace))&&(a.handleObj=i,a.data=i.data,e=((h.event.special[i.origType]||{}).handle||i.handler).apply(g.elem,
k),e!==b&&!1===(a.result=e)&&(a.preventDefault(),a.stopPropagation()))}return l.postDispatch&&l.postDispatch.call(this,a),a.result}},handlers:function(a,c){var d,e,g,i,j=[],k=c.delegateCount,l=a.target;if(k&&l.nodeType&&(!a.button||"click"!==a.type))for(;l!==this;l=l.parentNode||this)if(!0!==l.disabled||"click"!==a.type){e=[];for(d=0;k>d;d++)i=c[d],g=i.selector+" ",e[g]===b&&(e[g]=i.needsContext?0<=h(g,this).index(l):h.find(g,this,null,[l]).length),e[g]&&e.push(i);e.length&&j.push({elem:l,handlers:e})}return c.length>
k&&j.push({elem:this,handlers:c.slice(k)}),j},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:["char","charCode","key","keyCode"],filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,c){var d,e,h,g=c.button;return null==
a.pageX&&null!=c.clientX&&(d=a.target.ownerDocument||x,e=d.documentElement,h=d.body,a.pageX=c.clientX+(e&&e.scrollLeft||h&&h.scrollLeft||0)-(e&&e.clientLeft||h&&h.clientLeft||0),a.pageY=c.clientY+(e&&e.scrollTop||h&&h.scrollTop||0)-(e&&e.clientTop||h&&h.clientTop||0)),a.which||g===b||(a.which=1&g?1:2&g?3:4&g?2:0),a}},fix:function(a){if(a[h.expando])return a;var b,c,d;b=a.type;var e=a,g=this.fixHooks[b];g||(this.fixHooks[b]=g=Oc.test(b)?this.mouseHooks:Nc.test(b)?this.keyHooks:{});d=g.props?this.props.concat(g.props):
this.props;a=new h.Event(e);for(b=d.length;b--;)c=d[b],a[c]=e[c];return 3===a.target.nodeType&&(a.target=a.target.parentNode),g.filter?g.filter(a,e):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==j()&&this.focus?(this.focus(),!1):b},delegateType:"focusin"},blur:{trigger:function(){return this===j()&&this.blur?(this.blur(),!1):b},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&h.nodeName(this,"input")?(this.click(),!1):b},_default:function(a){return h.nodeName(a.target,
"a")}},beforeunload:{postDispatch:function(a){a.result!==b&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){a=h.extend(new h.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?h.event.trigger(a,null,b):h.event.dispatch.call(b,a);a.isDefaultPrevented()&&c.preventDefault()}};h.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)};h.Event=function(a,c){return this instanceof h.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=
a.defaultPrevented||a.getPreventDefault&&a.getPreventDefault()?g:i):this.type=a,c&&h.extend(this,c),this.timeStamp=a&&a.timeStamp||h.now(),this[h.expando]=!0,b):new h.Event(a,c)};h.Event.prototype={isDefaultPrevented:i,isPropagationStopped:i,isImmediatePropagationStopped:i,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=g;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=g;a&&a.stopPropagation&&a.stopPropagation()},
stopImmediatePropagation:function(){this.isImmediatePropagationStopped=g;this.stopPropagation()}};h.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){h.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=a.relatedTarget,e=a.handleObj;return(!d||d!==this&&!h.contains(this,d))&&(a.type=e.origType,c=e.handler.apply(this,arguments),a.type=b),c}}});h.support.focusinBubbles||h.each({focus:"focusin",blur:"focusout"},function(a,b){var c=0,d=function(a){h.event.simulate(b,
a.target,h.event.fix(a),!0)};h.event.special[b]={setup:function(){0===c++&&x.addEventListener(a,d,!0)},teardown:function(){0===--c&&x.removeEventListener(a,d,!0)}}});h.fn.extend({on:function(a,c,d,e,g){var j,k;if("object"==typeof a){"string"!=typeof c&&(d=d||c,c=b);for(k in a)this.on(k,c,d,a[k],g);return this}if(null==d&&null==e?(e=c,d=c=b):null==e&&("string"==typeof c?(e=d,d=b):(e=d,d=c,c=b)),!1===e)e=i;else if(!e)return this;return 1===g&&(j=e,e=function(a){return h().off(a),j.apply(this,arguments)},
e.guid=j.guid||(j.guid=h.guid++)),this.each(function(){h.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,c,d){var e,g;if(a&&a.preventDefault&&a.handleObj)return e=a.handleObj,h(a.delegateTarget).off(e.namespace?e.origType+"."+e.namespace:e.origType,e.selector,e.handler),this;if("object"==typeof a){for(g in a)this.off(g,c,a[g]);return this}return(!1===c||"function"==typeof c)&&(d=c,c=b),!1===d&&(d=i),this.each(function(){h.event.remove(this,a,d,c)})},trigger:function(a,
b){return this.each(function(){h.event.trigger(a,b,this)})},triggerHandler:function(a,c){var d=this[0];return d?h.event.trigger(a,c,d,!0):b}});var fc=/^.[^:#\[\.,]*$/,Qb=h.expr.match.needsContext,Pc={children:!0,contents:!0,next:!0,prev:!0};h.fn.extend({find:function(a){var b,c,d,e=this.length;if("string"!=typeof a)return b=this,this.pushStack(h(a).filter(function(){for(d=0;e>d;d++)if(h.contains(b[d],this))return!0}));c=[];for(d=0;e>d;d++)h.find(a,this[d],c);return c=this.pushStack(1<e?h.unique(c):
c),c.selector=(this.selector?this.selector+" ":"")+a,c},has:function(a){var b=h(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(h.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(l(this,a||[],!0))},filter:function(a){return this.pushStack(l(this,a||[],!1))},is:function(a){return!!a&&("string"==typeof a?Qb.test(a)?0<=h(a,this.context).index(this[0]):0<h.filter(a,this).length:0<this.filter(a).length)},closest:function(a,b){for(var c,d=0,e=this.length,g=[],
i=Qb.test(a)||"string"!=typeof a?h(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(11>c.nodeType&&(i?-1<i.index(c):1===c.nodeType&&h.find.matchesSelector(c,a))){g.push(c);break}return this.pushStack(1<g.length?h.unique(g):g)},index:function(a){return a?"string"==typeof a?Aa.call(h(a),this[0]):Aa.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){var c="string"==typeof a?h(a,b):h.makeArray(a&&a.nodeType?[a]:a),c=h.merge(this.get(),
c);return this.pushStack(h.unique(c))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});h.each({parent:function(a){return(a=a.parentNode)&&11!==a.nodeType?a:null},parents:function(a){return h.dir(a,"parentNode")},parentsUntil:function(a,b,c){return h.dir(a,"parentNode",c)},next:function(a){return k(a,"nextSibling")},prev:function(a){return k(a,"previousSibling")},nextAll:function(a){return h.dir(a,"nextSibling")},prevAll:function(a){return h.dir(a,"previousSibling")},
nextUntil:function(a,b,c){return h.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return h.dir(a,"previousSibling",c)},siblings:function(a){return h.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return h.sibling(a.firstChild)},contents:function(a){return h.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:h.merge([],a.childNodes)}},function(a,b){h.fn[a]=function(c,d){var e=h.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=h.filter(d,e)),
1<this.length&&(Pc[a]||h.unique(e),"p"===a[0]&&e.reverse()),this.pushStack(e)}});h.extend({filter:function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?h.find.matchesSelector(d,a)?[d]:[]:h.find.matches(a,h.grep(b,function(a){return 1===a.nodeType}))},dir:function(a,c,d){for(var e=[],g=d!==b;(a=a[c])&&9!==a.nodeType;)if(1===a.nodeType){if(g&&h(a).is(d))break;e.push(a)}return e},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}});
var Rb=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,Sb=/<([\w:]+)/,Qc=/<|&#?\w+;/,Rc=/<(?:script|style|link)/i,Tb=/^(?:checkbox|radio)$/i,Sc=/checked\s*(?:[^=]|=\s*.checked.)/i,Ub=/^$|\/(?:java|ecma)script/i,gc=/^true\/(.*)/,Tc=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,P={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};
P.optgroup=P.option;P.tbody=P.tfoot=P.colgroup=P.caption=P.col=P.thead;P.th=P.td;h.fn.extend({text:function(a){return h.access(this,function(a){return a===b?h.text(this):this.empty().append((this[0]&&this[0].ownerDocument||x).createTextNode(a))},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&n(this,a).appendChild(a)})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||
11===this.nodeType||9===this.nodeType){var b=n(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?h.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||h.cleanData(z(c)),c.parentNode&&(b&&h.contains(c.ownerDocument,c)&&
m(z(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(h.cleanData(z(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return h.clone(this,a,b)})},html:function(a){return h.access(this,function(a){var c=this[0]||{},d=0,e=this.length;if(a===b&&1===c.nodeType)return c.innerHTML;if("string"==typeof a&&!Rc.test(a)&&!P[(Sb.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Rb,
"<$1></$2>");try{for(;e>d;d++)c=this[d]||{},1===c.nodeType&&(h.cleanData(z(c,!1)),c.innerHTML=a);c=0}catch(g){}}c&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=h.map(this,function(a){return[a.nextSibling,a.parentNode]}),b=0;return this.domManip(arguments,function(c){var d=a[b++],e=a[b++];e&&(h(this).remove(),e.insertBefore(c,d))},!0),b?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b,c){var a=wb.apply([],a),d,e,g,i,j=0,k=this.length,
l=this,n=k-1,m=a[0],r=h.isFunction(m);if(r||!(1>=k||"string"!=typeof m||h.support.checkClone)&&Sc.test(m))return this.each(function(d){var e=l.eq(d);r&&(a[0]=m.call(this,d,e.html()));e.domManip(a,b,c)});if(k&&(d=h.buildFragment(a,this[0].ownerDocument,!1,!c&&this),e=d.firstChild,1===d.childNodes.length&&(d=e),e)){e=h.map(z(d,"script"),p);for(g=e.length;k>j;j++)i=d,j!==n&&(i=h.clone(i,!0,!0),g&&h.merge(e,z(i,"script"))),b.call(this[j],i,j);if(g){d=e[e.length-1].ownerDocument;h.map(e,q);for(j=0;g>j;j++)i=
e[j],Ub.test(i.type||"")&&!v.access(i,"globalEval")&&h.contains(d,i)&&(i.src?h._evalUrl(i.src):h.globalEval(i.textContent.replace(Tc,"")))}}return this}});h.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){h.fn[a]=function(a){for(var c=[],d=h(a),e=d.length-1,g=0;e>=g;g++)a=g===e?this:this.clone(!0),h(d[g])[b](a),Ya.apply(c,a.get());return this.pushStack(c)}});h.extend({clone:function(a,b,c){var d,e,g,i,j=a.cloneNode(!0),
k=h.contains(a.ownerDocument,a);if(!h.support.noCloneChecked&&!(1!==a.nodeType&&11!==a.nodeType||h.isXMLDoc(a))){i=z(j);g=z(a);d=0;for(e=g.length;e>d;d++){var l=g[d],n=i[d],p=n.nodeName.toLowerCase();"input"===p&&Tb.test(l.type)?n.checked=l.checked:("input"===p||"textarea"===p)&&(n.defaultValue=l.defaultValue)}}if(b)if(c){g=g||z(a);i=i||z(j);d=0;for(e=g.length;e>d;d++)r(g[d],i[d])}else r(a,j);return i=z(j,"script"),0<i.length&&m(i,!k&&z(a,"script")),j},buildFragment:function(a,b,c,d){for(var e,g,
i,j,k=0,l=a.length,n=b.createDocumentFragment(),p=[];l>k;k++)if(e=a[k],e||0===e)if("object"===h.type(e))h.merge(p,e.nodeType?[e]:e);else if(Qc.test(e)){g=g||n.appendChild(b.createElement("div"));i=(Sb.exec(e)||["",""])[1].toLowerCase();i=P[i]||P._default;g.innerHTML=i[1]+e.replace(Rb,"<$1></$2>")+i[2];for(i=i[0];i--;)g=g.firstChild;h.merge(p,g.childNodes);g=n.firstChild;g.textContent=""}else p.push(b.createTextNode(e));n.textContent="";for(k=0;e=p[k++];)if((!d||-1===h.inArray(e,d))&&(j=h.contains(e.ownerDocument,
e),g=z(n.appendChild(e),"script"),j&&m(g),c))for(i=0;e=g[i++];)Ub.test(e.type||"")&&c.push(e);return n},cleanData:function(a){for(var b,c,d,e=a.length,g=0,i=h.event.special;e>g;g++){if(c=a[g],h.acceptData(c)&&(b=v.access(c)))for(d in b.events)i[d]?h.event.remove(c,d):h.removeEvent(c,d,b.handle);F.discard(c);v.discard(c)}},_evalUrl:function(a){return h.ajax({url:a,type:"GET",dataType:"text",async:!1,global:!1,success:h.globalEval})}});h.fn.extend({wrapAll:function(a){var b;return h.isFunction(a)?this.each(function(b){h(this).wrapAll(a.call(this,
b))}):(this[0]&&(b=h(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){for(var a=this;a.firstElementChild;)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return h.isFunction(a)?this.each(function(b){h(this).wrapInner(a.call(this,b))}):this.each(function(){var b=h(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=h.isFunction(a);return this.each(function(c){h(this).wrapAll(b?a.call(this,
c):a)})},unwrap:function(){return this.parent().each(function(){h.nodeName(this,"body")||h(this).replaceWith(this.childNodes)}).end()}});var qa,ua,Uc=/^(none|table(?!-c[ea]).+)/,Vb=/^margin/,ic=RegExp("^("+Ha+")(.*)$","i"),Ua=RegExp("^("+Ha+")(?!px)[a-z%]+$","i"),Vc=RegExp("^([+-])=("+Ha+")","i"),ob={BODY:"block"},Wc={position:"absolute",visibility:"hidden",display:"block"},Wb={letterSpacing:0,fontWeight:400},ia=["Top","Right","Bottom","Left"],nb=["Webkit","O","Moz","ms"];h.fn.extend({css:function(c,
d){return h.access(this,function(c,d,e){var g,i={},j=0;if(h.isArray(d)){e=a.getComputedStyle(c,null);for(g=d.length;g>j;j++)i[d[j]]=h.css(c,d[j],!1,e);return i}return e!==b?h.style(c,d,e):h.css(c,d)},c,d,1<arguments.length)},show:function(){return ha(this,!0)},hide:function(){return ha(this)},toggle:function(a){var b="boolean"==typeof a;return this.each(function(){(b?a:H(this))?h(this).show():h(this).hide()})}});h.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=qa(a,"opacity");return""===
c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,c,d,e){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var g,i,j,k=h.camelCase(c),l=a.style;return c=h.cssProps[k]||(h.cssProps[k]=D(l,k)),j=h.cssHooks[c]||h.cssHooks[k],d===b?j&&"get"in j&&(g=j.get(a,!1,e))!==b?g:l[c]:(i=typeof d,"string"===i&&(g=Vc.exec(d))&&(d=(g[1]+1)*g[2]+parseFloat(h.css(a,c)),i="number"),null==d||"number"===
i&&isNaN(d)||("number"!==i||h.cssNumber[k]||(d+="px"),h.support.clearCloneStyle||""!==d||0!==c.indexOf("background")||(l[c]="inherit"),j&&"set"in j&&(d=j.set(a,d,e))===b||(l[c]=d)),b)}},css:function(a,c,d,e){var g,i,j,k=h.camelCase(c);return c=h.cssProps[k]||(h.cssProps[k]=D(a.style,k)),j=h.cssHooks[c]||h.cssHooks[k],j&&"get"in j&&(g=j.get(a,!0,d)),g===b&&(g=qa(a,c,e)),"normal"===g&&c in Wb&&(g=Wb[c]),""===d||d?(i=parseFloat(g),!0===d||h.isNumeric(i)?i||0:g):g}});qa=function(c,d,e){var g,i,j,k=(e=
e||a.getComputedStyle(c,null))?e.getPropertyValue(d)||e[d]:b,l=c.style;return e&&(""!==k||h.contains(c.ownerDocument,c)||(k=h.style(c,d)),Ua.test(k)&&Vb.test(d)&&(g=l.width,i=l.minWidth,j=l.maxWidth,l.minWidth=l.maxWidth=l.width=k,k=e.width,l.width=g,l.minWidth=i,l.maxWidth=j)),k};h.each(["height","width"],function(c,d){h.cssHooks[d]={get:function(a,c,e){return c?0===a.offsetWidth&&Uc.test(h.css(a,"display"))?h.swap(a,Wc,function(){return R(a,d,e)}):R(a,d,e):b},set:function(b,c,e){var g=e&&a.getComputedStyle(b,
null);return I(b,c,e?L(b,d,e,h.support.boxSizing&&"border-box"===h.css(b,"boxSizing",!1,g),g):0)}}});h(function(){h.support.reliableMarginRight||(h.cssHooks.marginRight={get:function(a,c){return c?h.swap(a,{display:"inline-block"},qa,[a,"marginRight"]):b}});!h.support.pixelPosition&&h.fn.position&&h.each(["top","left"],function(a,c){h.cssHooks[c]={get:function(a,d){return d?(d=qa(a,c),Ua.test(d)?h(a).position()[c]+"px":d):b}}})});h.expr&&h.expr.filters&&(h.expr.filters.hidden=function(a){return 0>=
a.offsetWidth&&0>=a.offsetHeight},h.expr.filters.visible=function(a){return!h.expr.filters.hidden(a)});h.each({margin:"",padding:"",border:"Width"},function(a,b){h.cssHooks[a+b]={expand:function(c){for(var d=0,e={},c="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+ia[d]+b]=c[d]||c[d-2]||c[0];return e}};Vb.test(a)||(h.cssHooks[a+b].set=I)});var Xc=/%20/g,jc=/\[\]$/,Xb=/\r?\n/g,Yc=/^(?:submit|button|image|reset|file)$/i,Zc=/^(?:input|select|textarea|keygen)/i;h.fn.extend({serialize:function(){return h.param(this.serializeArray())},
serializeArray:function(){return this.map(function(){var a=h.prop(this,"elements");return a?h.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!h(this).is(":disabled")&&Zc.test(this.nodeName)&&!Yc.test(a)&&(this.checked||!Tb.test(a))}).map(function(a,b){var c=h(this).val();return null==c?null:h.isArray(c)?h.map(c,function(a){return{name:b.name,value:a.replace(Xb,"\r\n")}}):{name:b.name,value:c.replace(Xb,"\r\n")}}).get()}});h.param=function(a,c){var d,e=[],g=function(a,b){b=
h.isFunction(b)?b():null==b?"":b;e[e.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(c===b&&(c=h.ajaxSettings&&h.ajaxSettings.traditional),h.isArray(a)||a.jquery&&!h.isPlainObject(a))h.each(a,function(){g(this.name,this.value)});else for(d in a)Va(d,a[d],c,g);return e.join("&").replace(Xc,"+")};h.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),
function(a,b){h.fn[b]=function(a,c){return 0<arguments.length?this.on(b,null,a,c):this.trigger(b)}});h.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var pa,ga,kb=h.now(),lb=/\?/,$c=/#.*$/,Yb=/([?&])_=[^&]*/,ad=/^(.*?):[ \t]*([^\r\n]*)$/gm,
bd=/^(?:GET|HEAD)$/,cd=/^\/\//,Zb=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,$b=h.fn.load,ac={},Wa={},bc="*/".concat("*");try{ga=lc.href}catch(kd){ga=x.createElement("a"),ga.href="",ga=ga.href}pa=Zb.exec(ga.toLowerCase())||[];h.fn.load=function(a,c,d){if("string"!=typeof a&&$b)return $b.apply(this,arguments);var e,g,i,j=this,k=a.indexOf(" ");return 0<=k&&(e=a.slice(k),a=a.slice(0,k)),h.isFunction(c)?(d=c,c=b):c&&"object"==typeof c&&(g="POST"),0<j.length&&h.ajax({url:a,type:g,dataType:"html",data:c}).done(function(a){i=
arguments;j.html(e?h("<div>").append(h.parseHTML(a)).find(e):a)}).complete(d&&function(a,b){j.each(d,i||[a.responseText,b,a])}),this};h.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){h.fn[b]=function(a){return this.on(b,a)}});h.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ga,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(pa[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",
accepts:{"*":bc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":h.parseJSON,"text xml":h.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Xa(Xa(a,h.ajaxSettings),b):Xa(h.ajaxSettings,a)},ajaxPrefilter:qb(ac),ajaxTransport:qb(Wa),ajax:function(a,
c){function d(a,c,j,l){var w,p,u,G,W=c;if(2!==y){y=2;k&&clearTimeout(k);e=b;i=l||"";B.readyState=0<a?4:0;l=200<=a&&300>a||304===a;if(j){u=m;for(var v=B,I,x,L,D,C=u.contents,R=u.dataTypes;"*"===R[0];)R.shift(),I===b&&(I=u.mimeType||v.getResponseHeader("Content-Type"));if(I)for(x in C)if(C[x]&&C[x].test(I)){R.unshift(x);break}if(R[0]in j)L=R[0];else{for(x in j){if(!R[0]||u.converters[x+" "+R[0]]){L=x;break}D||(D=x)}L=L||D}u=L?(L!==R[0]&&R.unshift(L),j[L]):b}var ja;a:{j=m;I=u;x=B;L=l;var A,E,F;u={};
v=j.dataTypes.slice();if(v[1])for(A in j.converters)u[A.toLowerCase()]=j.converters[A];for(D=v.shift();D;)if(j.responseFields[D]&&(x[j.responseFields[D]]=I),!F&&L&&j.dataFilter&&(I=j.dataFilter(I,j.dataType)),F=D,D=v.shift())if("*"===D)D=F;else if("*"!==F&&F!==D){if(A=u[F+" "+D]||u["* "+D],!A)for(ja in u)if(E=ja.split(" "),E[1]===D&&(A=u[F+" "+E[0]]||u["* "+E[0]])){!0===A?A=u[ja]:!0!==u[ja]&&(D=E[0],v.unshift(E[1]));break}if(!0!==A)if(A&&j["throws"])I=A(I);else try{I=A(I)}catch(J){ja={state:"parsererror",
error:A?J:"No conversion from "+F+" to "+D};break a}}ja={state:"success",data:I}}u=ja;l?(m.ifModified&&(G=B.getResponseHeader("Last-Modified"),G&&(h.lastModified[g]=G),G=B.getResponseHeader("etag"),G&&(h.etag[g]=G)),204===a?W="nocontent":304===a?W="notmodified":(W=u.state,w=u.data,p=u.error,l=!p)):(p=W,(a||!W)&&(W="error",0>a&&(a=0)));B.status=a;B.statusText=(c||W)+"";l?z.resolveWith(q,[w,W,B]):z.rejectWith(q,[B,W,p]);B.statusCode(ha);ha=b;n&&r.trigger(l?"ajaxSuccess":"ajaxError",[B,m,l?w:p]);H.fireWith(q,
[B,W]);n&&(r.trigger("ajaxComplete",[B,m]),--h.active||h.event.trigger("ajaxStop"))}}"object"==typeof a&&(c=a,a=b);var c=c||{},e,g,i,j,k,l,n,p,m=h.ajaxSetup({},c),q=m.context||m,r=m.context&&(q.nodeType||q.jquery)?h(q):h.event,z=h.Deferred(),H=h.Callbacks("once memory"),ha=m.statusCode||{},v={},I={},y=0,x="canceled",B={readyState:0,getResponseHeader:function(a){var b;if(2===y){if(!j)for(j={};b=ad.exec(i);)j[b[1].toLowerCase()]=b[2];b=j[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===
y?i:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return y||(a=I[c]=I[c]||a,v[a]=b),this},overrideMimeType:function(a){return y||(m.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>y)for(b in a)ha[b]=[ha[b],a[b]];else B.always(a[B.status]);return this},abort:function(a){a=a||x;return e&&e.abort(a),d(0,a),this}};if(z.promise(B).complete=H.add,B.success=B.done,B.error=B.fail,m.url=((a||m.url||ga)+"").replace($c,"").replace(cd,pa[1]+"//"),m.type=c.method||c.type||m.method||m.type,
m.dataTypes=h.trim(m.dataType||"*").toLowerCase().match(X)||[""],null==m.crossDomain&&(l=Zb.exec(m.url.toLowerCase()),m.crossDomain=!(!l||l[1]===pa[1]&&l[2]===pa[2]&&(l[3]||("http:"===l[1]?"80":"443"))===(pa[3]||("http:"===pa[1]?"80":"443")))),m.data&&m.processData&&"string"!=typeof m.data&&(m.data=h.param(m.data,m.traditional)),rb(ac,m,c,B),2===y)return B;(n=m.global)&&0===h.active++&&h.event.trigger("ajaxStart");m.type=m.type.toUpperCase();m.hasContent=!bd.test(m.type);g=m.url;m.hasContent||(m.data&&
(g=m.url+=(lb.test(g)?"&":"?")+m.data,delete m.data),!1===m.cache&&(m.url=Yb.test(g)?g.replace(Yb,"$1_="+kb++):g+(lb.test(g)?"&":"?")+"_="+kb++));m.ifModified&&(h.lastModified[g]&&B.setRequestHeader("If-Modified-Since",h.lastModified[g]),h.etag[g]&&B.setRequestHeader("If-None-Match",h.etag[g]));(m.data&&m.hasContent&&!1!==m.contentType||c.contentType)&&B.setRequestHeader("Content-Type",m.contentType);B.setRequestHeader("Accept",m.dataTypes[0]&&m.accepts[m.dataTypes[0]]?m.accepts[m.dataTypes[0]]+("*"!==
m.dataTypes[0]?", "+bc+"; q=0.01":""):m.accepts["*"]);for(p in m.headers)B.setRequestHeader(p,m.headers[p]);if(m.beforeSend&&(!1===m.beforeSend.call(q,B,m)||2===y))return B.abort();x="abort";for(p in{success:1,error:1,complete:1})B[p](m[p]);if(e=rb(Wa,m,c,B)){B.readyState=1;n&&r.trigger("ajaxSend",[B,m]);m.async&&0<m.timeout&&(k=setTimeout(function(){B.abort("timeout")},m.timeout));try{y=1,e.send(v,d)}catch(L){if(!(2>y))throw L;d(-1,L)}}else d(-1,"No Transport");return B},getJSON:function(a,b,c){return h.get(a,
b,c,"json")},getScript:function(a,c){return h.get(a,b,c,"script")}});h.each(["get","post"],function(a,c){h[c]=function(a,d,e,g){return h.isFunction(d)&&(g=g||e,e=d,d=b),h.ajax({url:a,type:c,dataType:g,data:d,success:e})}});h.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return h.globalEval(a),a}}});h.ajaxPrefilter("script",function(a){a.cache===b&&
(a.cache=!1);a.crossDomain&&(a.type="GET")});h.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,e){b=h("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove();c=null;a&&e("error"===a.type?404:200,a.type)});x.head.appendChild(b[0])},abort:function(){c&&c()}}}});var cc=[],mb=/(=)\?(?=&|$)|\?\?/;h.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=cc.pop()||h.expando+"_"+kb++;return this[a]=!0,a}});h.ajaxPrefilter("json jsonp",
function(c,d,e){var g,i,j,k=!1!==c.jsonp&&(mb.test(c.url)?"url":"string"==typeof c.data&&!(c.contentType||"").indexOf("application/x-www-form-urlencoded")&&mb.test(c.data)&&"data");return k||"jsonp"===c.dataTypes[0]?(g=c.jsonpCallback=h.isFunction(c.jsonpCallback)?c.jsonpCallback():c.jsonpCallback,k?c[k]=c[k].replace(mb,"$1"+g):!1!==c.jsonp&&(c.url+=(lb.test(c.url)?"&":"?")+c.jsonp+"="+g),c.converters["script json"]=function(){return j||h.error(g+" was not called"),j[0]},c.dataTypes[0]="json",i=a[g],
a[g]=function(){j=arguments},e.always(function(){a[g]=i;c[g]&&(c.jsonpCallback=d.jsonpCallback,cc.push(g));j&&h.isFunction(i)&&i(j[0]);j=i=b}),"script"):b});h.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var ya=h.ajaxSettings.xhr(),dd={"0":200,1223:204},ed=0,za={};a.ActiveXObject&&h(a).on("unload",function(){for(var a in za)za[a]();za=b});h.support.cors=!!ya&&"withCredentials"in ya;h.support.ajax=ya=!!ya;h.ajaxTransport(function(a){var c;return h.support.cors||ya&&!a.crossDomain?
{send:function(d,e){var g,h,i=a.xhr();if(i.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(g in a.xhrFields)i[g]=a.xhrFields[g];a.mimeType&&i.overrideMimeType&&i.overrideMimeType(a.mimeType);a.crossDomain||d["X-Requested-With"]||(d["X-Requested-With"]="XMLHttpRequest");for(g in d)i.setRequestHeader(g,d[g]);c=function(a){return function(){c&&(delete za[h],c=i.onload=i.onerror=null,"abort"===a?i.abort():"error"===a?e(i.status||404,i.statusText):e(dd[i.status]||i.status,i.statusText,
"string"==typeof i.responseText?{text:i.responseText}:b,i.getAllResponseHeaders()))}};i.onload=c();i.onerror=c("error");c=za[h=ed++]=c("abort");i.send(a.hasContent&&a.data||null)},abort:function(){c&&c()}}:b});var ra,Ta,fd=/^(?:toggle|show|hide)$/,gd=RegExp("^(?:([+-])=|)("+Ha+")([a-z%]*)$","i"),hd=/queueHooks$/,Ba=[function(a,c,d){var e,g,i,j,k,l,n=this,m=a.style,p={},q=[],r=a.nodeType&&H(a);d.queue||(k=h._queueHooks(a,"fx"),null==k.unqueued&&(k.unqueued=0,l=k.empty.fire,k.empty.fire=function(){k.unqueued||
l()}),k.unqueued++,n.always(function(){n.always(function(){k.unqueued--;h.queue(a,"fx").length||k.empty.fire()})}));1===a.nodeType&&("height"in c||"width"in c)&&(d.overflow=[m.overflow,m.overflowX,m.overflowY],"inline"===h.css(a,"display")&&"none"===h.css(a,"float")&&(m.display="inline-block"));d.overflow&&(m.overflow="hidden",n.always(function(){m.overflow=d.overflow[0];m.overflowX=d.overflow[1];m.overflowY=d.overflow[2]}));j=v.get(a,"fxshow");for(e in c)if(i=c[e],fd.exec(i)){if(delete c[e],g=g||
"toggle"===i,i===(r?"hide":"show")){if("show"!==i||j===b||j[e]===b)continue;r=!0}q.push(e)}if(c=q.length){j=v.get(a,"fxshow")||v.access(a,"fxshow",{});"hidden"in j&&(r=j.hidden);g&&(j.hidden=!r);r?h(a).show():n.done(function(){h(a).hide()});n.done(function(){var b;v.remove(a,"fxshow");for(b in p)h.style(a,b,p[b])});for(e=0;c>e;e++)g=q[e],i=n.createTween(g,r?j[g]:0),p[g]=j[g]||h.style(a,g),g in j||(j[g]=i.start,r&&(i.end=i.start,i.start="width"===g||"height"===g?1:0))}}],va={"*":[function(a,b){var c,
d,e=this.createTween(a,b),g=gd.exec(b),i=e.cur(),j=+i||0,k=1,l=20;if(g){if(c=+g[2],d=g[3]||(h.cssNumber[a]?"":"px"),"px"!==d&&j){j=h.css(e.elem,a,!0)||c||1;do k=k||".5",j/=k,h.style(e.elem,a,j+d);while(k!==(k=e.cur()/i)&&1!==k&&--l)}e.unit=d;e.start=j;e.end=g[1]?j+(g[1]+1)*c:c}return e}]};h.Animation=h.extend(tb,{tweener:function(a,b){h.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],va[c]=va[c]||[],va[c].unshift(b)},prefilter:function(a,b){b?Ba.unshift(a):Ba.push(a)}});
h.Tween=N;N.prototype={constructor:N,init:function(a,b,c,d,e,g){this.elem=a;this.prop=c;this.easing=e||"swing";this.options=b;this.start=this.now=this.cur();this.end=d;this.unit=g||(h.cssNumber[c]?"":"px")},cur:function(){var a=N.propHooks[this.prop];return a&&a.get?a.get(this):N.propHooks._default.get(this)},run:function(a){var b,c=N.propHooks[this.prop];return this.pos=b=this.options.duration?h.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*
b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):N.propHooks._default.set(this),this}};N.prototype.init.prototype=N.prototype;N.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=h.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){h.fx.step[a.prop]?h.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[h.cssProps[a.prop]]||h.cssHooks[a.prop])?h.style(a.elem,a.prop,
a.now+a.unit):a.elem[a.prop]=a.now}}};N.propHooks.scrollTop=N.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}};h.each(["toggle","show","hide"],function(a,b){var c=h.fn[b];h.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Ca(b,!0),a,d,e)}});h.fn.extend({fadeTo:function(a,b,c,d){return this.filter(H).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=h.isEmptyObject(a),
g=h.speed(b,c,d),i=function(){var b=tb(this,h.extend({},a),g);i.finish=function(){b.stop(!0)};(e||v.get(this,"finish"))&&b.stop(!0)};return i.finish=i,e||!1===g.queue?this.each(i):this.queue(g.queue,i)},stop:function(a,c,d){var e=function(a){var b=a.stop;delete a.stop;b(d)};return"string"!=typeof a&&(d=c,c=a,a=b),c&&!1!==a&&this.queue(a||"fx",[]),this.each(function(){var b=!0,c=null!=a&&a+"queueHooks",g=h.timers,i=v.get(this);if(c)i[c]&&i[c].stop&&e(i[c]);else for(c in i)i[c]&&i[c].stop&&hd.test(c)&&
e(i[c]);for(c=g.length;c--;)g[c].elem!==this||null!=a&&g[c].queue!==a||(g[c].anim.stop(d),b=!1,g.splice(c,1));(b||!d)&&h.dequeue(this,a)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var b,c=v.get(this),d=c[a+"queue"];b=c[a+"queueHooks"];var e=h.timers,g=d?d.length:0;c.finish=!0;h.queue(this,a,[]);b&&b.cur&&b.cur.finish&&b.cur.finish.call(this);for(b=e.length;b--;)e[b].elem===this&&e[b].queue===a&&(e[b].anim.stop(!0),e.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);
delete c.finish})}});h.each({slideDown:Ca("show"),slideUp:Ca("hide"),slideToggle:Ca("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){h.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}});h.speed=function(a,b,c){var d=a&&"object"==typeof a?h.extend({},a):{complete:c||!c&&b||h.isFunction(a)&&a,duration:a,easing:c&&b||b&&!h.isFunction(b)&&b};return d.duration=h.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in h.fx.speeds?h.fx.speeds[d.duration]:
h.fx.speeds._default,(null==d.queue||!0===d.queue)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){h.isFunction(d.old)&&d.old.call(this);d.queue&&h.dequeue(this,d.queue)},d};h.easing={linear:function(a){return a},swing:function(a){return 0.5-Math.cos(a*Math.PI)/2}};h.timers=[];h.fx=N.prototype.init;h.fx.tick=function(){var a,c=h.timers,d=0;for(ra=h.now();c.length>d;d++)a=c[d],a()||c[d]!==a||c.splice(d--,1);c.length||h.fx.stop();ra=b};h.fx.timer=function(a){a()&&h.timers.push(a)&&h.fx.start()};
h.fx.interval=13;h.fx.start=function(){Ta||(Ta=setInterval(h.fx.tick,h.fx.interval))};h.fx.stop=function(){clearInterval(Ta);Ta=null};h.fx.speeds={slow:600,fast:200,_default:400};h.fx.step={};h.expr&&h.expr.filters&&(h.expr.filters.animated=function(a){return h.grep(h.timers,function(b){return a===b.elem}).length});h.fn.offset=function(a){if(arguments.length)return a===b?this:this.each(function(b){h.offset.setOffset(this,a,b)});var c,d,e=this[0],g={top:0,left:0},i=e&&e.ownerDocument;if(i)return c=
i.documentElement,h.contains(c,e)?(typeof e.getBoundingClientRect!==Ea&&(g=e.getBoundingClientRect()),d=h.isWindow(i)?i:9===i.nodeType&&i.defaultView,{top:g.top+d.pageYOffset-c.clientTop,left:g.left+d.pageXOffset-c.clientLeft}):g};h.offset={setOffset:function(a,b,c){var d,e,g,i,j,k,l=h.css(a,"position"),n=h(a),m={};"static"===l&&(a.style.position="relative");j=n.offset();g=h.css(a,"top");k=h.css(a,"left");("absolute"===l||"fixed"===l)&&-1<(g+k).indexOf("auto")?(d=n.position(),i=d.top,e=d.left):(i=
parseFloat(g)||0,e=parseFloat(k)||0);h.isFunction(b)&&(b=b.call(a,c,j));null!=b.top&&(m.top=b.top-j.top+i);null!=b.left&&(m.left=b.left-j.left+e);"using"in b?b.using.call(a,m):n.css(m)}};h.fn.extend({position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===h.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),h.nodeName(a[0],"html")||(d=a.offset()),d.top+=h.css(a[0],"borderTopWidth",!0),d.left+=h.css(a[0],"borderLeftWidth",!0)),{top:b.top-
d.top-h.css(c,"marginTop",!0),left:b.left-d.left-h.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||vb;a&&!h.nodeName(a,"html")&&"static"===h.css(a,"position");)a=a.offsetParent;return a||vb})}});h.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(c,d){var e="pageYOffset"===d;h.fn[c]=function(g){return h.access(this,function(c,g,i){var j=h.isWindow(c)?c:9===c.nodeType&&c.defaultView;return i===b?j?j[d]:c[g]:(j?j.scrollTo(e?a.pageXOffset:
i,e?i:a.pageYOffset):c[g]=i,b)},c,g,arguments.length,null)}});h.each({Height:"height",Width:"width"},function(a,c){h.each({padding:"inner"+a,content:c,"":"outer"+a},function(d,e){h.fn[e]=function(e,g){var i=arguments.length&&(d||"boolean"!=typeof e),j=d||(!0===e||!0===g?"margin":"border");return h.access(this,function(c,d,e){var g;return h.isWindow(c)?c.document.documentElement["client"+a]:9===c.nodeType?(g=c.documentElement,Math.max(c.body["scroll"+a],g["scroll"+a],c.body["offset"+a],g["offset"+
a],g["client"+a])):e===b?h.css(c,d,j):h.style(c,d,e,j)},c,i?e:b,i,null)}})});h.fn.size=function(){return this.length};h.fn.andSelf=h.fn.addBack;"object"==typeof module&&"object"==typeof module.exports?module.exports=h:"function"==typeof define&&define.amd&&define("jquery",[],function(){return h});"object"==typeof a&&"object"==typeof a.document&&(a.jQuery=a.$=h)})(window);
function clone(a,b){if(a&&a.clone&&"function"===typeof a.clone)return a.clone();if(null==a||"object"!=typeof a||/\[object HTML[A-Za-z]*Element\]/.test(Object.prototype.toString.apply(a))||/\[object Window\]/.test(Object.prototype.toString.apply(a)))return a;if(a instanceof Date){var c=new Date;c.setTime(a.getTime());return c}if(a instanceof Array){for(var c=[],d=0,e=a.length;d<e;d++)c[d]=clone(a[d]);return c}if(a instanceof Object){c=window[a.initializer]?new window[a.initializer]:new a.constructor;
b&&(c.originalReference=a);if("function"===typeof c.importFrom)c.importFrom(a);else for(d in a)a.hasOwnProperty(d)&&(c[d]=clone(a[d]));return c}throw Error("[\u5185\u90e8\u30a8\u30e9\u30fc] \u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u30b3\u30d4\u30fc\u3067\u304d\u307e\u305b\u3093\u3002\u3053\u306e\u578b\u306f\u30b5\u30dd\u30fc\u30c8\u3055\u308c\u3066\u3044\u307e\u305b\u3093");}function mergeObj(a,b){for(var c in a)"object"!=typeof a[c]||void 0==b[c]?b[c]=a[c]:mergeObj(a[c],b[c]);return b}
browser={isIE:-1!=navigator.userAgent.indexOf("MSIE"),isFirefox:-1!=navigator.userAgent.toLowerCase().indexOf("firefox"),isNativeApp:-1!=navigator.userAgent.toLowerCase().indexOf("adsphere")||window.nativeInjected,isIOs:navigator.userAgent.match(/(iPad|iPhone|iPod)/i)?!0:!1,isAndroid:navigator.userAgent.match(/(android)/i)?!0:!1,isNodeWebkit:"object"==typeof process};
browser.supportsMultipleAudio=function(){if(browser.isAndroid)return!1;if(browser.isIOs){var a;a=window.navigator.userAgent;var b=a.indexOf("OS ");a=(-1<a.indexOf("iPhone")||-1<a.indexOf("iPad"))&&-1<b?Number(a.substr(b+3,3).replace("_",".")):-1;return 6<=a?!0:!1}return!0}();
Event.prototype.normalizedCoordinate=function(a){var b=document.getElementById("main-wrapper");returnCoordinate=this.changedTouches?{x:(this.changedTouches[0].pageX-b.getBoundingClientRect().left)/scale+0,y:(this.changedTouches[0].pageY-b.getBoundingClientRect().top)/scale+0}:{x:(this.clientX-b.getBoundingClientRect().left)/scale+0,y:(this.clientY-b.getBoundingClientRect().top)/scale+0};a instanceof Layer&&(returnCoordinate=a.localLocation(returnCoordinate.x,returnCoordinate.y));return returnCoordinate};
var scaleToFitPage,scale=1,setPageScale;
(function(){function a(){if(b)return b;var a=window,c=document,g=c.documentElement,c=c.getElementsByTagName("body")[0];return{width:a.innerWidth||g.clientWidth||c.clientWidth,height:a.innerHeight||g.clientHeight||c.clientHeight}}var b;setPageScale=function(a){scale!=a&&(scale=a,$("#main-wrapper").css("transformOrigin","0% 0%").css("transform","scale("+scale+")"))};var c;scaleToFitPage=function(d,e){var g;-1>=d||-1>=e?b=void 0:d&&e&&(g=b={width:d,height:e});if(!g){g=a();if(c&&c.width==g.width&&c.height==
g.height)return;var i=document.body;i.style.overflow="hidden";i.style.height=browser.isIOs&&window==window.top?2*g.height+"px":g.height+"px";window.scrollTo(0,0);g=a()}c=g;i=Math.min(g.width/config.scWidth,g.height/config.scHeight);setPageScale(i);$("#main-wrapper").css("top",(g.height-config.scHeight*i)/2+"px").css("left",(g.width-config.scWidth*i)/2+"px");return this}})();
function KeySpline(a,b,c,d){this.get=function(e){if(a==b&&c==d)return e;a:{for(var g=e,i=0;4>i;++i){var j=3*(1-3*c+3*a)*g*g+2*(3*c-6*a)*g+3*a;if(0==j){e=g;break a}g-=((((1-3*c+3*a)*g+(3*c-6*a))*g+3*a)*g-e)/j}e=g}return(((1-3*d+3*b)*e+(3*d-6*b))*e+3*b)*e}}
function B_Spline_Generator(a){var b=a.length,c=b-1,d=b+2,e=(b+1)/100;return function(b){var b=e*(0>b?0:100<b?100:b)-1,i={x:0,y:0},j,k,l,n;for(j=-2;j<d;j++)k=b-j,l=1>(k=Math.abs(k))?(n=3*k*k,(k*n-2*n+4)/6):2>k?(n=k-2,n*n*n/-6):0,k=0>j?0:c<j?c:j,i.x+=a[k][0]*l,i.y+=a[k][1]*l;return i}}
function supportCssProperty(a){"string"==typeof a&&(a=[a]);for(var b=0;b<a.length;b++){var c=a[b],d=document.body;if("string"!=typeof d.style[c]&&"string"!=typeof d.style["Webkit"+c.substring(0,1).toUpperCase()+c.substring(1)]&&"string"!=typeof d.style["Moz"+c.substring(0,1).toUpperCase()+c.substring(1)]&&"string"!=typeof d.style["O"+c.substring(0,1).toUpperCase()+c.substring(1)])return!1}return!0}
(function(){browser.isAndroid&&(window.requestAnimationFrame=function(a){return window.setTimeout(a,1E3/60)});for(var a=0,b=Date.now(),c=["ms","moz","webkit","o"],d=0;d<c.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[c[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[c[d]+"CancelAnimationFrame"]||window[c[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(c){var d=(new Date).getTime(),i=Math.max(0,16-
(d-a)),j=window.setTimeout(function(){c(d-b)},i);a=d+i;return j});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})})();(function(){if(window.chrome){var a=CanvasRenderingContext2D.prototype.fillText;CanvasRenderingContext2D.prototype.fillText=function(b,c,d,e){if(-1==b.indexOf("\u3000"))return a.apply(this,arguments);for(var g=b.split(""),i=c,j=0;j<g.length;j++){var k=g[j],l=this.measureText(k).width;if(c+l-i>e)break;a.call(this,k,c,d);c+=l}}}})();
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("[\u5185\u90e8\u30a8\u30e9\u30fc] Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;e.prototype=new d;return e});
function hexToRgb(a){return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null}$(function(){$.fn.bindFirst=function(a,b){this.on(a,b);this.each(function(){var b=$._data(this,"events")[a.split(".")[0]];if(b){var d=b.pop();b.splice(0,0,d)}});return this}});
function wheelDistance(a){a||(a=event);var b=0,c=0,c=a.wheelDelta,d=a.detail;d?c?c=0<c/d/40*d?1:-1:a.deltaX||a.deltaY?(b=a.deltaX,c=a.deltaY):c=-d/3:a.wheelDeltaX||a.wheelDeltaY?(c=a.wheelDeltaY/120,b=a.wheelDeltaX/120):a.deltaX||a.deltaY?(b=-a.deltaX/3,c=-a.deltaY/3):c/=120;"DOMMouseScroll"==a.type?(c*=40,b*=40):browser.isIE||(c*=10,b*=10);return{x:b,y:c}}
function multiplyMatrix(a,b){for(var c=a.length,d=a[0].length,e=b[0].length,g=[],i=0;i<c;i++){g[i]=[];for(var j=0;j<e;j++){for(var k=0,l=0;l<d;l++)k+=a[i][l]*b[l][j];g[i][j]=k}}return g}var isFontLoaded;
(function(){var a=null,b=null,c={};isFontLoaded=function(d){a||(a=document.createElement("canvas"),b=a.getContext("2d"));for(var e=["monospace","sans-serif","serif"],g=0,i=e.length;g<i;g++){var j=e[g],k=c[j];k||(b.font="72px "+j,k=c[j]=b.measureText("0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz").width);var l=c[d];l||(b.font="72px "+d+","+j,l=b.measureText("0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz").width);if(k!=l)return c[d]=l,!0}return!1}})(this);
function layerToPageAndLayerNumber(a){for(var b=0;b<o2.foreLayers.messageLayers.length;b++){var c=o2.foreLayers.messageLayers[b];if(a==c)return{page:"fore",layer:b}}for(b=0;b<o2.backLayers.messageLayers.length;b++)if(c=o2.backLayers.messageLayers[b],a==c)return{page:"back",layer:b}}var ResourceLoader;
(function(){var a,b=function(a,b){if(!d){var e=c.canPlayType(a);if("maybe"===e||"probably"===e)d=b}},c=new Audio,d=void 0;browser.isNodeWebkit&&b("audio/ogg","ogg");b("audio/mp4","mp4");b("audio/ogg","ogg");b("audio/mp3","mp3");b("audio/wav","wav");a=d||"ogg";var e=function(){var a=document.createElement("video");if("maybe"==a.canPlayType("video/webm"))return"webm";if("maybe"==a.canPlayType("video/mp4"))return"mp4";if("maybe"==a.canPlayType("video/ogg"))return"ogv"}(),g=3,i=3,j={},k=[],l={},n=function(a,
b,c){var d=$.Deferred();c||(c="video"==b?document.createElement("video"):new Audio);$(c).on("canplaythrough stalled suspend",function(){$(this).off();d.resolve(c)});$(c).on("error",function(){$(this).off();d.reject()});c.autoplay=!1;c.src="";c.src=a;c.load();setTimeout(function(){d.reject()},1E4);return d.promise()};ResourceLoader={loadImage:function(a,b){"undefined"===typeof b&&(b=!0);"data:"!=a.substr(0,5)&&(a=a.toLowerCase());var c=$.Deferred(),d=a;if(a in o2.imageList)a=o2.imageList[a];else if("data:"!=
a.substr(0,5))return o2.error("\u30b9\u30c8\u30ec\u30fc\u30b8\u306b"+d+"\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),c.reject();if(a in l)return l[a].promise();c.done(function(a){ev.lastimage.width=a.width;ev.lastimage.height=a.height});if(a in j)c.resolve(j[a]);else{l[a]=c;var e=0,g,i=function(){var j=a,k=$.Deferred(),l=new Image;$(l).on("readystatechange load",function(){$(this).off();l.complete||4==l.readyState||"complete"==l.readyState?k.resolve(l):$(l).trigger("error")});$(l).on("error",
function(a){$(this).off();k.reject(a)});var n=setTimeout(function(){$(l).trigger("error")},1E4);k.always(function(){clearTimeout(n)});$(l).attr("src",j);g=k.promise();g.done(function(a){a.originalURL=d;c.resolve(a)}).fail(function(a){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||10>e?(setTimeout(i,100),e++,b&&Renderer.showLoadingSign()):b?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){e=0;b&&Renderer.showLoadingSign();i()})):c.reject(a)})};i();var n;b&&(n=setTimeout(function(){Renderer.showLoadingSign()},
3E3));c.done(function(b){var c=a;if(-1==config.numImageCache)j[c]=b;else{var d=k.indexOf(c);-1!=d&&k.splice(d,1);k.push(c);j[c]=b;k.length>config.numImageCache&&k.splice(0,k.length-config.numImageCache).forEach(function(a){delete j[a]})}});c.always(function(){b&&(clearTimeout(n),Renderer.hideLoadingSign());delete l[a]})}return c.promise()},getFullAudioPath:function(b){b=b.toLowerCase();b=o2.soundList[b];return!b?void 0:b+"."+a},loadAudio:function(a,b,c){function d(){n(i,"audio",c).done(function(a){e.resolve(a)}).fail(function(a){(browser.isIOs||
browser.isAndroid)&&!navigator.onLine||j<g?(setTimeout(d,100),j++,b&&Renderer.showLoadingSign()):b?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){j=0;b&&Renderer.showLoadingSign();d()})):e.reject(a)})}var e=$.Deferred();"undefined"===typeof b&&(b=!0);var i=this.getFullAudioPath(a);if(!i)return o2.error("\u30b9\u30c8\u30ec\u30fc\u30b8\u306b"+i+" \u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093"),e.reject();var j=0;d();var k;b&&(k=setTimeout(function(){Renderer.showLoadingSign()},3E3));
e.always(function(){b&&(clearTimeout(k),Renderer.hideLoadingSign())});return e.promise()},loadVideo:function(a,b,c){function d(){n(a+"."+e,"video",c).done(function(a){g.resolve(a)}).fail(function(a){(browser.isIOs||browser.isAndroid)&&!navigator.onLine||j<i?(setTimeout(d,100),j++,b&&Renderer.showLoadingSign()):b?(Renderer.hideLoadingSign(),Renderer.showServerError(function(){j=0;b&&Renderer.showLoadingSign();d()})):g.reject(a)})}"undefined"===typeof b&&(b=!0);a=a.toLowerCase();if(a in o2.videoList)a=
o2.videoList[a];else throw"\u30e0\u30fc\u30d3\u30fc\u30b9\u30c8\u30ec\u30fc\u30b8 "+a+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093";var g=$.Deferred(),j=0;d();var k;b&&(k=setTimeout(function(){Renderer.showLoadingSign()},3E3));g.always(function(){b&&(clearTimeout(k),Renderer.hideLoadingSign())});return g.promise()},loadFont:function(a,b){var c=a,d=$.Deferred();if(isFontLoaded(c))return d.resolve();a=a.toLowerCase();if(a in o2.fontList)a=o2.fontList[a];else return d.resolve();$("head").prepend('<style type="text/css">@font-face {font-family: "'+
c+'";src: url("'+a+'.ttf"),     url("'+a+'.woff");}</style>');var e=$("<div />").css({"font-family":c,height:0,width:0,opacity:0,margin:0}).html(".").appendTo($("body")),g,i;setTimeout(function I(){isFontLoaded(c)?d.resolve():setTimeout(I,100)},100);b&&(g=setTimeout(function(){Renderer.showLoadingSign()},3E3),i=setTimeout(function(){d.reject()},1E4));d.always(function(){clearTimeout(g);clearTimeout(i);Renderer.hideLoadingSign();e.remove()});return d.promise()}}})();
var Conductor=function(a){this.waitTag={};this.file;this.lineNumber=-1;this.currentTag;this.currentRecordName;this.oneShotStackDepth=0;this.paused=!1;this.tagActions={};this.stack=[];this.queue=[];this.status=Conductor.STATUS_STOP;this.callStack=[];this.macroStack=[];this.macros={};this.ifStack=[];this.dispatchQueue=[];this.callbackVarsStack=[];a&&(a.file&&this.setFile(a.file),a.label&&("*"==a.label.charAt(0)&&(a.label=a.label.substring(1)),(a=this.file.getLabelTag(a.label))&&this.setTag(a)));var b=
this;this.queue.push=function(a){if(a instanceof Tag){var d=Array.prototype.push.apply(this,arguments);if("click"in b.waitTag)trigger("click");else if(b.status==Conductor.STATUS_STOP)b.oneShot();return d}};this.dispatchQueue.push=function(a){if(a instanceof Conductor.DispatchTask)return Array.prototype.push.apply(this,arguments)}};Conductor.STATUS_STOP=0;Conductor.STATUS_PREPARE_TAG=1;Conductor.STATUS_RUN=2;Conductor.STATUS_WAIT=3;
Conductor.prototype.toJSON=function(){result={file:this.file.filename,lineNumber:this.lineNumber,stack:this.queue,ifStack:this.ifStack};config.saveMode==o2.SAVE_MODE_O2KAG&&(result.macroStack=this.macroStack,result.callStack=this.callStack);return result};
Conductor.prototype.importFromSaveData=function(a){this.waitTag={};this.macroStack=[];this.ifStack=[];this.callStack=[];var b=this,c=KAGFiles(a.file);return $.when(c).then(function(c){b.setTag(c.lines[a.lineNumber],!0);b.status!=Conductor.STATUS_RUN&&setTimeout(function(){});delete a.currentTag;return Object.prototype.importFromSaveData.call(b,a)})};
Conductor.prototype.importFrom=function(){throw"\u3010\u5185\u90e8\u30a8\u30e9\u30fc\u3011\u30b3\u30f3\u30c0\u30af\u30bf\u30fc\u306f\u30b3\u30d4\u30fc\u3067\u304d\u307e\u305b\u3093\u3002";};Conductor.prototype.getTagAction=function(a){return this.tagActions[a]||Tag.actions[a]};
Conductor.prototype.run=function(){if(!this.paused){this.waitTag={};this.status=Conductor.STATUS_RUN;if(this.queue.length)this.currentTag=this.queue.shift();else{for(var a=this.file.lines[this.lineNumber],b;b=this.dispatchQueue[0];)if(b.originalTag)if(!a||"s"==this.currentTag.tagName)this.dispatchQueue.shift(),this.setTag(b.originalTag),a=b.originalTag,b.args&&this.callbackVarsStack.pop();else break;else{if(a&&a.isDependency)break;if("function"===typeof b.condition&&!b.condition(a))break;b.originalTag=
a;this.setTag(b.file.lines[0]);b.args&&this.callbackVarsStack.push(b.args);break}this.currentTag=this.file.lines[this.lineNumber];if(!this.currentTag){a=new Tag("s");this.queue.push(a);this.oneShot();return}a="\u30d5\u30a1\u30a4\u30eb: "+this.file.filename+" / ";a+="\u884c:"+(this.currentTag.originalLineNumber||this.currentTag.lineNumber)+" / ";"undefined"!=typeof this.currentTag.originalCharNumber&&(a+="\u6587\u5b57:"+this.currentTag.originalCharNumber+" / ");a=a+"\u30bf\u30b0: "+this.macroStack.map(function(a){return a.definition.name}).concat([this.currentTag.tagName]).join(" > ");
this.callStack.length&&(a+="\ncall stack: ",a+=this.callStack.map(function(a){return a.file+":"+((a.originalLineNumber||a.line)-1)+" : call"}).join(" > "));o2.log(a);this.lineNumber++;this.currentTag.file.recentlyUsed()}var c,a=!0;if("o2_cond"in this.currentTag.args)try{eval(this.currentTag.args.o2_cond)||(a=!1)}catch(d){a=!1}if(a){this.currentTag.conductor=this;if(this.isMacro(this.currentTag)){this.jumpIntoMacro(this.currentTag);return}if(this.shouldMacroEnd()){this.jumpOutOfMacro();return}this.status=
Conductor.STATUS_PREPARE_TAG;c=this.currentTag.run();void 0==c&&(c=0);delete this.currentTag.conductor;this.status=Conductor.STATUS_RUN}else o2.log("o2_cond\u306e\u8a55\u4fa1\u7d50\u679c\u304cfalse\u3060\u3063\u305f\u305f\u3081\u5b9f\u884c\u3055\u308c\u307e\u305b\u3093\u3067\u3057\u305f"),c=0;var e=this;0==c?($(this).trigger("ran",[c]),this.oneShotStackDepth++,this.oneShot()):1==c?(this.oneShotStackDepth=0,this.wait(this.currentTag.tagName,function(){$(e).trigger("ran",[c])})):2==c&&(this.oneShotStackDepth=
0,this.status=Conductor.STATUS_STOP,$(this).trigger("ran",[c]))}};Conductor.prototype.setFile=function(a){this.setTag(a.line(0))};Conductor.prototype.setTag=function(a,b){this.file=a.file;this.lineNumber=a.lineNumber;b&&this.lineNumber++};Conductor.prototype.getNextTag=function(a){if(!a)return this.queue.length?this.queue[0]:this.file.lines[this.lineNumber];for(var b=this.upComingTags(),c=0;c<b.length;c++)if(b[c].tagName==a)return b[c]};Conductor.prototype.upComingTags=function(){return this.queue.concat(this.file.lines.slice(this.lineNumber))};
Conductor.prototype.oneShot=function(){if(5E3>this.oneShotStackDepth)this.run();else{var a=this;setTimeout(function(){a.oneShotStackDepth=0;a.run()})}};Conductor.prototype.isCurrentRead=function(){return!config.autoRecordPageShowing||config.autoRecordPageShowing&&this.currentRecordName&&sf[this.currentRecordName]};Conductor.prototype.pause=function(){this.paused=!0};Conductor.prototype.resume=function(){this.paused=!1};
(function(){function a(){window.mp=currentConductor.macroStack.length?currentConductor.macroStack[currentConductor.macroStack.length-1].args:{}}Conductor.prototype.isMacro=function(a){a instanceof Tag&&(a=a.tagName);return a in this.macros};Conductor.prototype.jumpIntoMacro=function(b){var d=new Macro,e;if(b instanceof Tag){e=this.macros[b.tagName];if(!e)throw"\u767b\u9332\u3055\u308c\u3066\u3044\u306a\u3044\u30de\u30af\u30ed "+b.tagName+" \u304c\u547c\u3073\u51fa\u3055\u308c\u307e\u3057\u305f";d.args=
b.argsForAction();d.args.tagname=b.tagName}else e=this.macros[b];d.definition=e;d.returnTag=this.getNextTag().toRestorable();this.macroStack.push(d);a();var g=this;this.wait("jumpIntoMacro");$.when(e.startTag.restore()).done(function(a){g.setTag(a);g.trigger("jumpIntoMacro")})};Conductor.prototype.shouldMacroEnd=function(){return!this.macroStack.length?!1:"endmacro"==this.currentTag.tagName?!0:!1};Conductor.prototype.jumpOutOfMacro=function(){var b=this.macroStack.pop();a();if(b){this.wait("jumpOutOfMacro");
var b=b.returnTag.restore(),d=this;$.when(b).then(function(a){d.setTag(a);d.trigger("jumpOutOfMacro")})}else this.oneShot()};Conductor.prototype.clearMacroStack=function(){this.macroStack=[];a()};var b=Conductor.prototype.importFromSaveData;Conductor.prototype.importFromSaveData=function(){return b.apply(this,arguments).done(function(){a()})}})();Conductor.prototype.clearIfStack=function(){this.ifStack=[]};
Conductor.prototype.reset=function(){this.queue.splice(0,this.queue.length);this.status=Conductor.STATUS_STOP;this.callStack=[];this.macroStack=[];this.macros={};this.ifStack=[]};Conductor.prototype.wait=function(a,b){this.status=Conductor.STATUS_WAIT;a instanceof Tag&&(a=a.tagName);a in this.waitTag||(this.waitTag[a]=[]);b&&this.waitTag[a].push(b)};
Conductor.prototype.trigger=function(a){if(!(this.status===Conductor.STATUS_PREPARE_TAG&&0==Object.keys(this.waitTag).length)){var b=[],c=!1;a instanceof Tag&&(a=a.tagName);a in this.waitTag?a in this.waitTag&&(c=!0,b=b.concat(this.waitTag[a])):"click"==a&&(0==Object.keys(this.waitTag).length&&this.status!=Conductor.STATUS_STOP)&&(c=!0);for(a=0;a<b.length;a++)b[a]();return c?(this.oneShot(),!0):!1}};
var trigger=function(){return currentConductor.trigger.apply(currentConductor,arguments)},wait=function(){return currentConductor.wait.apply(currentConductor,arguments)};MacroDefinition=function(a){a&&(this.name=a.name,this.startTag=a.startTag,this.endTag=a.endTag)};Macro=function(a){a&&(this.definition=a.definition,this.returnTag=a.returnTag,this.args=a.args)};Macro.prototype.initializer="Macro";var SubRoutineConductor=function(){Conductor.call(this);Object.defineProperty(this,"macros",{get:function(){return conductor.macros}})};
SubRoutineConductor.prototype=Object.create(Conductor.prototype);
SubRoutineConductor.prototype.getTagAction=function(a){SubRoutineConductor.tagActions=SubRoutineConductor.tagActions||{"return":new TagAction({rules:Tag.actions["return"].rules,action:function(a){if(0==this.conductor.callStack.length){currentConductor=conductor;o2.skipMode=o2.SKIP_MODE_NONE;if(a.storage||a.target)a=new Tag("jump",a),currentConductor.queue.push(a);return 2}return Tag.actions["return"].action.call(this,a)}}),label:new TagAction({action:function(a){return config.saveMode==o2.SAVE_MODE_KAG3&&
a.caption?(this.error("\u30b5\u30d6\u30eb\u30fc\u30c1\u30f3\u5185\u306b\u30bb\u30fc\u30d6\u53ef\u80fd\u306a\u30e9\u30d9\u30eb\u3092\u7f6e\u304f\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0):Tag.actions.label.action.call(this,a)}}),o2_savestat:new TagAction({action:function(){config.saveMode==o2.SAVE_MODE_O2KAG&&this.error("\u30b5\u30d6\u30eb\u30fc\u30c1\u30f3\u5185\u306bo2_savestat\u30bf\u30b0\u3092\u7f6e\u304f\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093");return 0}})};return SubRoutineConductor.tagActions[a]||
Conductor.prototype.getTagAction.apply(this,arguments)};Conductor.DispatchTask=function(a){this.file=a;this.currentLine=0;this.originalTag;this.args};var KAGFiles,KAGFile,PartialFile;
(function(){var a={},b=[],c=Infinity,d={};KAGFiles=function(c,g){c=c.toLowerCase();if(void 0==g){if(c in a){var i=a[c];i.recentlyUsed();return i}if(c in d)return $.get(d[c],null,null,"json").then(function(a){return KAGFile.create(c,a)});throw c+"\u3068\u3044\u3046\u30d5\u30a1\u30a4\u30eb\u304c\u898b\u3064\u304b\u3089\u306a\u3044";}b.push(c);a[c]=g;KAGFiles.ensureFileLimit();return g};KAGFiles.setupManifest=function(a){c=config.numScriptCache;for(var b in a)d[b.toLowerCase()]=a[b].toLowerCase()};KAGFiles.ensureFileLimit=
function(){if(!(b.length<=c)){var d=[conductor,extraConductor],d=d.concat(o2.foreLayers.baseLayer.animationConductors,o2.backLayers.baseLayer.animationConductors),d=[].concat.apply(d,o2.foreLayers.imageLayers.map(function(a){return a.animationConductors})),d=[].concat.apply(d,o2.backLayers.imageLayers.map(function(a){return a.animationConductors}));o2.glyphLayer.animationConductors[0]instanceof AnimationConductor&&d.push(o2.glyphLayer.animationConductors[0]);for(var d=d.filter(function(a){return void 0!=
a}).map(function(a){return a.file}),g=0;g<b.length&&b.length>c;){var i=b[g];-1==d.indexOf(a[i])?(b.splice(g,1),delete a[i]):g++}}};KAGFile=function(a){this.filename=a.toLowerCase();this.lines=[];this.labels=[];KAGFiles(a,this);var b=this;this.lines.push=function(a){a.file=b;a.lineNumber=this.length;"label"==a.tagName&&b.labels.push(a);return Array.prototype.push.apply(this,arguments)}};KAGFile.create=function(a,b){for(var c=new KAGFile(a),d=0;d<b.length;d++){var k=b[d],l=new Tag(k[o2.config.scriptTagNameKey],
k[o2.config.scriptTagArgsKey],k[o2.config.scriptTagCallbackArgsKey]);c.lines.push(l);k[o2.config.scriptTagDependencyKey]&&(l.isDependency=!0);"undefined"!=typeof k[o2.config.scriptTagLineKey]&&(l.originalLineNumber=k[o2.config.scriptTagLineKey]);"undefined"!=typeof k[o2.config.scriptTagCharKey]&&(l.originalCharNumber=k[o2.config.scriptTagCharKey])}return c};KAGFile.prototype.recentlyUsed=function(){var a=b.indexOf(this.filename);-1!=a&&b.splice(a,1);b.push(this.filename);KAGFiles.ensureFileLimit()};
KAGFile.prototype.clone=function(){return this};KAGFile.prototype.line=function(a){return this.lines[a]};KAGFile.prototype.getLabelTag=function(a){for(var b=0;b<this.labels.length;b++)if(this.labels[b].args.name==a)return this.labels[b];return null};KAGFile.prototype.basename=function(){var a=this.filename.split(".");a.pop();return a.join(".")};PartialFile=function(a,b,c){this.originalFile=a;this.filename=a.filename+"(virtual:"+b+"~"+c+")";this.start=b;this.end=c;var d=this;this.lines=a.lines.slice(b,
c+1).map(function(a,b){var c=Object.create(a);c.file=d;c.lineNumber=b;return c})};PartialFile.prototype=Object.create(KAGFile.prototype);PartialFile.prototype.getLabelTag=function(a){return this.originalFile.getLabelTag(a)}})();
Rect=function(){if(4==arguments.length)return new Rect({x:arguments[0],y:arguments[1],width:arguments[2],height:arguments[3]});if(1==arguments.length&&"object"===typeof arguments[0])for(var a in arguments[0]){if(this[a]=arguments[0][a],isNaN(this[a]))throw a+"\u306fnumber\u3058\u3083\u306a\u3044\u3067\u3059";}else this.x=this.y=this.width=this.height=0};Rect.prototype.initializer="Rect";Rect.prototype.isEqual=function(a){return a.x==this.x&&a.y==this.y&&a.width==this.width&&a.height==this.height};
Rect.prototype.isZero=function(){return this.isEqual(new Rect(0,0,0,0))};Rect.prototype.coverCoordinate=function(a,b){return a>=this.x&&a<this.x+this.width&&b>this.y&&b<this.y+this.height?!0:!1};Rect.prototype.extend=function(a){(0==this.width||0==this.height)&&$.extend(this,a);var b=Math.min(a.x,this.x),c=Math.min(a.y,this.y),d=Math.max(a.x+a.width,this.x+this.width);maxY=Math.max(a.y+a.height,this.y+this.height);this.x=b;this.y=c;this.width=d-b;this.height=maxY-c};
Rect.prototype.intersect=function(a){if(a.x+a.width>this.x&&a.x<this.x+this.width&&a.y+a.height>this.y&&a.y<this.y+this.height){var b=Math.max(this.x,a.x),c=Math.max(this.y,a.y),d=Math.min(this.x+this.width,a.x+a.width),a=Math.min(this.y+this.height,a.y+a.height);return new Rect({x:b,y:c,width:d-b,height:a-c})}return!1};Rect.prototype.round=function(){this.x=~~(0.5+this.x);this.y=~~(0.5+this.y);this.width=~~(0.5+this.width);this.height=~~(0.5+this.height)};
Drawable=function(a){this.rect=clone(a)||new Rect;this.needRedraw=!0;this.partialDraw=!1};Drawable.prototype.initializer="Drawable";Drawable.prototype.objectToBeSerialized=function(a){switch(a){case "needRedraw":case "partialDraw":return}return this[a]};Drawable.prototype.importFrom=function(a){this.rect=clone(a.rect);this.transform=clone(a.transform)};Drawable.prototype.drawOnContext=function(){};Drawable.prototype.frame=function(){return this.rect};Drawable.prototype.canDrawPartial=function(){return!1};
DrawableCanvas=function(a){Drawable.call(this,a);this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.setRect()};DrawableCanvas.prototype=new Drawable;DrawableCanvas.prototype.initializer="DrawableCanvas";DrawableCanvas.prototype.objectToBeSerialized=function(a){switch(a){case "canvas":case "ctx":return}return this[a]};DrawableCanvas.prototype.importFromSaveData=function(){var a=this;return Drawable.prototype.importFromSaveData.apply(this,arguments).done(function(){a.setRect()})};
DrawableCanvas.prototype.canDrawPartial=function(){return!0};DrawableCanvas.prototype.setRect=function(a){a&&(this.rect=a);this.canvas.width=this.rect.width;this.canvas.height=this.rect.height};DrawableCanvas.prototype.clone=function(){var a=new DrawableCanvas;a.importFrom(this);a.canvas.width=this.rect.width;a.canvas.height=this.rect.height;a.ctx.drawImage(this.canvas,0,0);return a};
DrawableCanvas.prototype.drawOnContext=function(a,b){if(b){var c=b.intersect(this.rect);a.drawImage(this.canvas,c.x-this.rect.x,c.y-this.rect.y,c.width,c.height,c.x,c.y,c.width,c.height)}else a.drawImage(this.canvas,this.rect.x,this.rect.y,this.rect.width,this.rect.height)};DrawableSolidColor=function(a){Drawable.call(this,a);this.color="#000000";this.opacity=1};DrawableSolidColor.prototype=new Drawable;DrawableSolidColor.prototype.initializer="DrawableSolidColor";
DrawableSolidColor.prototype.canDrawPartial=function(){return!0};DrawableSolidColor.prototype.drawOnContext=function(a,b){b=b?b.intersect(this.rect):this.rect;a.save();a.globalAlpha=this.opacity;a.fillStyle=this.color;a.fillRect(b.x,b.y,b.width,b.height);a.restore()};DrawableSolidColor.prototype.importFrom=function(a){a instanceof DrawableSolidColor&&(this.color=a.color,this.opacity=a.opacity)};
DrawableImage=function(a,b,c){Drawable.call(this);if(null==a)throw"image needed";null==b&&(b=0);null==c&&(c=0);Drawable.call(this,new Rect(b,c,a.width,a.height));this.image=a;this.cacheEnabled=!0;this.cacheCanvas;this.options={}};
DrawableImage.defaultOptions={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,visible:!0,opacity:1,blurX:0,blurY:0,blurMode:"linear"};DrawableImage.prototype=new Drawable;DrawableImage.prototype.initializer="DrawableImage";
DrawableImage.prototype.objectToBeSerialized=function(a){switch(a){case "options":var a={},b;for(b in this.options)DrawableImage.defaultOptions.hasOwnProperty(b)&&this.options[b]==DrawableImage.defaultOptions[b]||(a[b]=this.options[b]);return a;case "image":if(this.image.originalURL)return this.image.originalURL;case "cacheCanvas":return}return this[a]};DrawableImage.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(b){b=new DrawableImage(b);b.importFrom(a);return b})};
DrawableImage.prototype.canDrawPartial=function(){return!0};DrawableImage.prototype.clone=function(){var a=new DrawableImage(this.image);a.importFrom(this);this.cacheCanvas&&(a.cacheCanvas=document.createElement("canvas"),a.cacheCanvas.width=this.cacheCanvas.width,a.cacheCanvas.height=this.cacheCanvas.height,a.cacheCanvas.getContext("2d").drawImage(this.cacheCanvas,0,0));return a};DrawableImage.prototype.importFrom=function(a){this.options=clone(a.options);this.rect=clone(a.rect)};
DrawableImage.prototype.drawOnContext=function(a,b){b||(b=this.rect);var c=0,d=0,e=this.rect.width,g=this.rect.height;this.options.clipLeft&&(c+=this.options.clipLeft,e-=this.options.clipLeft);this.options.clipTop&&(d+=this.options.clipTop,g-=this.options.clipTop);this.options.clipWidth&&(e=this.options.clipWidth);this.options.clipHeight&&(g=this.options.clipHeight);var i=b.intersect(new Rect({x:this.rect.x,y:this.rect.y,width:e,height:g}));if(i){var j=this.image;if(this.cacheCanvas)j=this.cacheCanvas;
else{var k=this,l,n,p=function(a){switch(a){case "canvas":return $(j).is("canvas")||(k.cacheCanvas=document.createElement("canvas"),k.cacheCanvas.width=j.width,k.cacheCanvas.height=j.height,l=k.cacheCanvas.getContext("2d"),l.drawImage(j,0,0),j=k.cacheCanvas),n&&(l.putImageData(n,0,0),n=null),j;case "imageData":return n?n:n=p("canvas").getContext("2d").getImageData(0,0,j.width,j.height);default:o2.error("\u30bd\u30fc\u30b9\u30bf\u30a4\u30d7\u304c\u9593\u9055\u3063\u3066\u307e\u3059\u3002")}};if(0!=
c||0!=d||e!=this.rect.width||g!=this.rect.height){p("canvas");var q=document.createElement("canvas");q.width=e;q.height=g;tempContext=q.getContext("2d");tempContext.drawImage(this.cacheCanvas,c,d,e,g,0,0,e,g);this.cacheCanvas.width=e;this.cacheCanvas.height=g;l.drawImage(q,0,0)}for(c=0;c<DrawableImage.effects.length;c++)DrawableImage.effects[c](p,this.options);n&&p("canvas")}a.save();"opacity"in this.options&&(a.globalAlpha=this.options.opacity);a.drawImage(j,i.x-this.rect.x,i.y-this.rect.y,i.width,
i.height,i.x,i.y,i.width,i.height);a.restore();this.cacheEnabled||(this.cacheCanvas=null)}};
DrawableImage.effects=[function(a,b){if(b.flipLR){var c=a("canvas"),d=document.createElement("canvas");d.width=c.width;d.height=c.height;tempContext=d.getContext("2d");tempContext.translate(c.width,0);tempContext.scale(-1,1);tempContext.drawImage(c,0,0);c.getContext("2d").drawImage(d,0,0)}},function(a,b){if(b.flipUD){var c=a("canvas"),d=document.createElement("canvas");d.width=c.width;d.height=c.height;tempContext=d.getContext("2d");tempContext.translate(0,c.height);tempContext.scale(1,-1);tempContext.drawImage(c,
0,0);c.getContext("2d").drawImage(d,0,0)}},function(a,b){if(b.grayscale)for(var c=a("imageData").data,d=0;d<c.length;d+=4){var e=0.34*c[d]+0.5*c[d+1]+0.16*c[d+2];c[d]=e;c[d+1]=e;c[d+2]=e}},function(a,b){var c=b.rGamma;if("rGamma"in b&&1!=c)for(var d=a("imageData").data,c=1/c,e=0;e<d.length;e+=4)d[e]=255*Math.pow(d[e]/255,c)},function(a,b){var c=b.gGamma;if("gGamma"in b&&1!=c)for(var d=a("imageData").data,c=1/c,e=0;e<d.length;e+=4)d[e+1]=255*Math.pow(d[e+1]/255,c)},function(a,b){var c=b.bGamma;if("bGamma"in
b&&1!=c)for(var d=a("imageData").data,c=1/c,e=0;e<d.length;e+=4)d[e+2]=255*Math.pow(d[e+2]/255,c)},function(a,b){if("rFloor"in b||"rCeil"in b){var c="rFloor"in b?b.rFloor:0,d="rCeil"in b?b.rCeil:255,e=d-c;if(!(0===c&&255===d))for(var d=a("imageData").data,g=0;g<d.length;g+=4)d[g]=d[g]/255*e+c}},function(a,b){if("gFloor"in b||"gCeil"in b){var c="gFloor"in b?b.gFloor:0,d="gCeil"in b?b.gCeil:255,e=d-c;if(!(0===c&&255===d))for(var d=a("imageData").data,g=0;g<d.length;g+=4)d[g+1]=d[g+1]/255*e+c}},function(a,
b){if("bFloor"in b||"bCeil"in b){var c="bFloor"in b?b.bFloor:0,d="gCeil"in b?b.bCeil:255,e=d-c;if(!(0===c&&255===d))for(var d=a("imageData").data,g=0;g<d.length;g+=4)d[g+2]=d[g+2]/255*e+c}},function(a,b){if(b.tintColor&&b.tintOpacity){var c=a("canvas"),d=c.getContext("2d");d.save();d.globalAlpha=b.tintOpacity;d.fillStyle=b.tintColor;d.fillRect(0,0,c.width,c.height);d.restore()}},function(a,b){if(b.blurX||b.blurY){var c=a("canvas"),d=c.getContext("2d"),e=document.createElement("canvas"),g=e.getContext("2d");
e.width=c.width;e.height=c.height;var i=(b.blurX||0)+1,j=(b.blurY||0)+1;if("linear"==b.blurMode){for(var k=0;k<i;k++){g.globalAlpha=1-k/i;var l=(i-k)/2*(k%2?-1:1);g.drawImage(c,l,0)}d.save();d.clearRect(0,0,c.width,c.height);for(k=0;k<j;k++)d.globalAlpha=1-k/j,l=(j-k)/2*(k%2?-1:1),d.drawImage(e,0,l);d.restore()}else{for(var n=0,l=255,p=d.getImageData(0,0,c.width,c.height).data,k=p.length-1;0<k;)n<p[k]&&(n=p[k]),l>p[k]&&(l=p[k]),k-=4;g.globalAlpha=1/i;for(k=0;k<i;k++)g.drawImage(c,k-i/2,0);d.save();
d.clearRect(0,0,c.width,c.height);d.globalAlpha=1/j;for(k=0;k<j;k++)d.drawImage(e,0,k-j/2);d.restore();c=d.getImageData(0,0,c.width,c.height);e=c.data;i=0;g=255;for(k=e.length-1;0<k;)i<e[k]&&(i=e[k]),g>e[k]&&(g=e[k]),k-=4;n-=l;i-=g;for(k=e.length-1;0<k;)e[k]=l+n*((e[k]-g)/i),k-=4;d.putImageData(c,0,0)}}}];
var Renderer=function(){this.animator=new Animator(this);this.foreLayers=[];this.backLayers=[];this.foreCanvas=document.createElement("canvas");this.foreCtx=this.foreCanvas.getContext("2d");this.backCanvas=document.createElement("canvas");this.backCtx=this.backCanvas.getContext("2d");this.yShift=this.xShift=0;this.foreCanvas.width=this.backCanvas.width=config.scWidth;this.foreCanvas.height=this.backCanvas.height=config.scHeight;this.renderBackCanvas=!1;this.transForeCanvas;this.transBackCanvas;this.transCanvas};
Renderer.prototype={render:function(){for(var a=-1,b=this.foreLayers.length-1;0<=b;b--)if(this.foreLayers[b].transTag){a=b;break}this.foreCtx.clearRect(0,0,this.foreCanvas.width,this.foreCanvas.height);(this.renderBackCanvas||0<=a)&&this.backCtx.clearRect(0,0,this.backCanvas.width,this.backCanvas.height);this.foreCtx.save();this.foreCtx.translate(this.xShift,this.yShift);for(var c=!1,b=0;b<this.foreLayers.length;b++){var d=this.foreLayers[b],e=this.backLayers[b];d.flush();e.flush();if(d.transTag){this.transForeCanvas||
(this.transForeCanvas=document.createElement("canvas"),this.transBackCanvas=document.createElement("canvas"),this.transCanvas=document.createElement("canvas"),this.transForeCanvas.width=this.transBackCanvas.width=this.transCanvas.width=this.backCanvas.width,this.transForeCanvas.height=this.transBackCanvas.height=this.transCanvas.height=this.foreCanvas.height);var g=this.transForeCanvas.getContext("2d"),i=this.transBackCanvas.getContext("2d");g.clearRect(0,0,this.transForeCanvas.width,this.transForeCanvas.height);
i.clearRect(0,0,this.transBackCanvas.width,this.transBackCanvas.height);i.drawImage(this.backCanvas,0,0);e.drawOnContext(i);g.drawImage(this.foreCanvas,0,0);d.drawOnContext(g);d.transTag.method.transit.call(d.transTag,d.transTag.transArgs,this.transForeCanvas,this.transBackCanvas,this.transCanvas);this.foreCtx.drawImage(this.transCanvas,0,0,this.transCanvas.width,this.transCanvas.height)}else if(d.drawOnContext(this.foreCtx),this.renderBackCanvas||b<=a)c=!0,e.drawOnContext(this.backCtx)}o2.historyLayer.visible&&
(o2.historyLayer.flush(),o2.historyLayer.drawOnContext(this.foreCtx));this.foreCtx.restore();$(this.foreCanvas).trigger("draw");c&&$(this.backCanvas).trigger("draw")}};Renderer.showLoadingSign=function(){$("#loading").show()};Renderer.hideLoadingSign=function(){$("#loading").hide()};Renderer.showServerError=function(a){$("#error").show();$("#retryButton").one("click",function(){Renderer.hideServerError();a()})};Renderer.hideServerError=function(){$("#error").hide()};
Renderer.askForLogin=function(){var a=$.Deferred();if(o2.serverStat.mode!=o2.SERVER_MODE_O2SERVER||-1!=o2.serverStat.uid)return a.resolve();$("#login-box iframe").one("load",function(){$("#login-box").fadeIn()}).attr("src",o2.serverStat.userServer+"/auth/login_box");$(window).one("message",function(b){b=b.originalEvent;"login/cancel"==b.data?(Renderer.closeLoginBox(),a.reject()):"login/success"==b.data&&(Renderer.closeLoginBox(),$.getScript(o2.serverStat.userServer+"/js?id="+config.gameID).then(function(){return loadSystemStateFromServer()}).then(function(){saveCurrentSystemState();
$(o2).trigger("loginbox.loggedin");a.resolve()}))});return a.promise()};Renderer.closeLoginBox=function(){$("#login-box").fadeOut("fast",function(){$("#login-box iframe").attr("src","")});scaleToFitPage()};var Animator=function(a){this.renderer=a;this.animationRequests=[];this.animationRequestId=this.timeoutId=this.nextCallTimestamp=void 0};
Animator.prototype={requestFrame:function(a,b){void 0==b&&(b=0);a||(a=function(){});var c=Date.now()+b;if(!this.isPaused&&(c<this.nextCallTimestamp||void 0==this.nextCallTimestamp))clearTimeout(this.timeoutId),cancelAnimationFrame(this.animationRequestId),0<b?this.timeoutId=setTimeout(this.animationLoopCalled.bind(this),b):this.animationRequestId=requestAnimationFrame(this.animationLoopCalled.bind(this)),this.nextCallTimestamp=c;this.animationRequests.push({callback:a,begin:c})},animationLoopCalled:function(){window.meter&&
window.meter.tickStart();this.animationRequestId=this.timeoutId=this.nextCallTimestamp=void 0;var a=this.animationRequests;this.animationRequests=[];for(var b=[],c=0;c<a.length;c++){var d=a[c],e=d.begin-Date.now();0<e?b.push(d):"function"===typeof d.callback&&d.callback()}for(c=0;c<b.length;c++)d=b[c],e=d.begin-Date.now(),this.requestFrame(d.callback,e);this.renderer.render();window.meter&&window.meter.tick()},isPaused:!1,pause:function(){this.isPaused||(this.isPaused=!0,void 0!==this.timeoutId&&
(clearTimeout(this.timeoutId),this.timeoutId=void 0),void 0!==this.animationRequestId&&(cancelAnimationFrame(this.animationRequestId),this.animationRequestId=void 0),this.nextCallTimestamp=void 0)},resume:function(){this.isPaused&&(this.isPaused=!1,this.animationRequests.length&&this.requestFrame())}};
Layer=function(a){Drawable.call(this,a);this.rect.width||(this.rect.width=config.scWidth);this.rect.height||(this.rect.height=config.scHeight);this.canvas=document.createElement("canvas");this.canvas.width=this.rect.width;this.canvas.height=this.rect.height;this.ctx=this.canvas.getContext("2d");this.stackedClearRect=new Rect;this.requestedFrame=!1;this.visible=!0;this.opacity=1;this.rotation=0;this.scaleY=this.scaleX=1;this.transformOrigin={x:0,y:0};this.cachedTransform={};this.index=0;this.userInteractionEnabled=
!0;this.moveTag=this.transTag=void 0};Layer.prototype=new Drawable;Layer.prototype.initializer="Layer";Layer.prototype.objectToBeSerialized=function(a){switch(a){case "canvas":case "ctx":case "cachedTransform":case "transTag":case "moveTag":case "stackedClearRect":case "requestedFrame":case "needRedraw":case "partialDraw":return}return this[a]};
Layer.prototype.importFromSaveData=function(a){var b=this;a.scale&&(this.scaleX=this.scaleY=a.scale,delete a.scale);this.stopTransition();return Drawable.prototype.importFromSaveData.call(this,a).done(function(){b.setRect()})};
Layer.prototype.importFrom=function(a){this.rect=clone(a.rect);this.visible=a.visible;this.opacity=a.opacity;this.canvas.width=a.canvas.width;this.canvas.height=a.canvas.height;this.redrawRect();this.transTag=void 0;this.rotation=a.rotation;this.scaleX=a.scaleX;this.scaleY=a.scaleY;this.transformOrigin=clone(a.transformOrigin);this.cachedTransform={};this.index=a.index};
Layer.prototype.getCorrespondingLayer=function(){var a=o2.allForeLayers().indexOf(this);if(-1!=a)return o2.allBackLayers()[a];a=o2.allBackLayers().indexOf(this);if(-1!=a)return o2.allForeLayers()[a]};Layer.prototype.setRect=function(a){a&&((!a.width||!a.height)&&o2.error("width/height\u306f0\u3067\u3059"),this.rect=a);this.canvas.width=this.rect.width;this.canvas.height=this.rect.height};
Layer.prototype.transformMatrix=function(){if(this.cachedTransform.x==this.rect.x&&this.cachedTransform.y==this.rect.y&&this.cachedTransform.rotation==this.rotation&&this.cachedTransform.scaleX==this.scaleX&&this.cachedTransform.scaleY==this.scaleY&&this.cachedTransform.originX==this.transformOrigin.x&&this.cachedTransform.originY==this.transformOrigin.y&&void 0!=this.cachedTransform.matrix)return this.cachedTransform.matrix;var a=[[1,0,0],[0,1,0],[0,0,1]],a=multiplyMatrix(a,[[1,0,this.rect.x+this.transformOrigin.x],
[0,1,this.rect.y+this.transformOrigin.y],[0,0,1]]);0!=this.rotation&&(a=multiplyMatrix(a,[[Math.cos(this.rotation),Math.sin(this.rotation),0],[-Math.sin(this.rotation),Math.cos(this.rotation),0],[0,0,1]]));if(1!=this.scaleX||1!=this.scaleY)a=multiplyMatrix(a,[[this.scaleX,0,0],[0,this.scaleY,0],[0,0,1]]);this.cachedTransform.x=this.rect.x;this.cachedTransform.y=this.rect.y;this.cachedTransform.rotation=this.rotation;this.cachedTransform.scaleX=this.scaleX;this.cachedTransform.scaleY=this.scaleY;this.cachedTransform.originX=
this.transformOrigin.x;this.cachedTransform.originY=this.transformOrigin.y;this.cachedTransform.matrix=a;this.cachedTransform.inverted=void 0;return a};
Layer.prototype.localLocation=function(a,b){var c=this.cachedTransform.inverted;if(!c){var c=this.transformMatrix(),d=[[c[0][0],c[0][1]],[c[1][0],c[1][1]]],e=d[0][0]*d[1][1]-d[0][1]*d[1][0],d=[[d[1][1]/e,d[0][1]/-e],[d[1][0]/-e,d[0][0]/e]],c=multiplyMatrix(d,[[c[0][2]],[c[1][2]]]),c=[[-c[0][0]],[-c[1][0]]],c=[[d[0][0],d[0][1],c[0][0]],[d[1][0],d[1][1],c[1][0]],[0,0,1]];this.cachedTransform.inverted=c}c=multiplyMatrix(c,[[a],[b],[1]]);return{x:c[0][0]+this.transformOrigin.x,y:c[1][0]+this.transformOrigin.y}};
Layer.prototype.transit=function(a){this.transTag=a;"function"==typeof a.method.prepare&&a.method.prepare.call(a,a.transArgs)};Layer.prototype.isTransiting=function(){return void 0!=this.transTag};Layer.prototype.stopTransition=function(){this.transTag&&(this.transTag.end=!0,typeof this.transTag.method.teardown&&this.transTag.method.teardown.call(this.transTag),this.importFrom(this.transTag.transArgs.layer.back),this.transTag=void 0)};
Layer.prototype.drawOnContext=function(a){if(this.visible){a.save();var b=this.transformMatrix();a.transform(b[0][0],b[1][0],b[0][1],b[1][1],b[0][2],b[1][2]);a.globalAlpha=this.opacity;a.drawImage(this.canvas,-this.transformOrigin.x,-this.transformOrigin.y,this.rect.width,this.rect.height);a.restore()}};Layer.prototype.children=function(){return[]};Layer.prototype.mousedown=function(){return!this.userInteractionEnabled?!1:!0};
Layer.prototype.mousemove=function(){return!this.userInteractionEnabled?!1:!0};Layer.prototype.mouseup=function(){return!this.userInteractionEnabled?!1:!0};Layer.prototype.draw=function(a){a.needRedraw=!0;this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)};Layer.prototype.redrawRect=function(a){a||(a=new Rect(0,0,this.rect.width,this.rect.height));this.stackedClearRect.extend(a);this.requestedFrame||(renderer.animator.requestFrame(),this.requestedFrame=!0)};
Layer.prototype.flush=function(){if(!this.requestedFrame)return!1;for(var a=!0,b=this.children();a;)for(var a=!1,c=b.length-1;0<=c;c--){var d=b[c];!d.needRedraw&&d.frame().intersect(this.stackedClearRect)&&(d.canDrawPartial()?d.partialDraw=!0:this.stackedClearRect.extend(d.frame()),a=d.needRedraw=!0)}this.stackedClearRect.round();this.ctx.clearRect(this.stackedClearRect.x,this.stackedClearRect.y,this.stackedClearRect.width,this.stackedClearRect.height);a=this.stackedClearRect.isZero();for(c=0;c<b.length;c++)d=
b[c],d.needRedraw&&(!a&&d.partialDraw?d.drawOnContext(this.ctx,this.stackedClearRect):d.drawOnContext(this.ctx),d.needRedraw=!1,d.partialDraw=!1);this.stackedClearRect=new Rect;this.requestedFrame=!1;return!0};var ImageLayer=function(){Layer.call(this);this.images=[];this.animationConductors=[];this.animationChildren=[]};ImageLayer.prototype=Object.create(Layer.prototype);ImageLayer.prototype.initializer="ImageLayer";ImageLayer.prototype.children=function(){return this.images.concat(this.animationChildren)};
ImageLayer.prototype.importFrom=function(a){Layer.prototype.importFrom.apply(this,arguments);this.clearImage();this.images=clone(a.images);this.clearAnimationConductors();for(var b in a.animationConductors){var c=clone(a.animationConductors[b]);this.addAnimationConductor(c,b)}};ImageLayer.prototype.objectToBeSerialized=function(a){return"animationConductors"==a&&!this.animationConductors.length||"animationChildren"==a?void 0:Layer.prototype.objectToBeSerialized.apply(this,arguments)};
ImageLayer.prototype.importFromSaveData=function(a){this.images=[];this.animationConductors.forEach(function(a){a.stop()});this.animationConductors=[];for(var b=this,c=[],d=0;d<a.images.length;d++){var e=a.images[d];(function(a){c.push($.when(e.restore()).done(function(c){b.images[a]=c}))})(d)}delete a.images;return $.when.apply($,c).then(function(){o2.log("\u30a4\u30e1\u30fc\u30b8\u306e\u30ed\u30fc\u30c9\u3092\u5b8c\u4e86\u3057\u307e\u3057\u305f")}).then(function(){var c=[];b.clearAnimationConductors();
if("animationConductors"in a)for(var d=0;d<a.animationConductors.length;d++){var e=a.animationConductors[d];null!==e&&function(a,d){c.push($.when(d.restore()).done(function(c){b.addAnimationConductor(c,a);c.run()}))}(d,e)}delete a.animationConductors;return $.when.apply($,c)}).then(function(){return Layer.prototype.importFromSaveData.call(b,a)}).then(function(){b.redrawRect();return b})};
ImageLayer.prototype.loadImage=function(a,b,c){var d=this,b=b||{};return ResourceLoader.loadImage(a,!c).then(function(a){d.clearImage();d.clearAnimationConductors();a=new DrawableImage(a,0,0);a.options=b;d.addImage(a);d.rect.width=a.rect.width;d.rect.height=a.rect.height;d.setRect();return a})};ImageLayer.prototype.addImage=function(a){this.images.push(a);this.draw(a)};
ImageLayer.prototype.clearImage=function(){for(var a=0;a<this.images.length;a++)this.redrawRect(this.images[a].rect);this.images=[]};ImageLayer.prototype.getImageRect=function(a){var b=void 0;"number"===typeof a?b=this.images[a]:"string"===typeof a?b=this.images.filter(function(b){return b.image.originalURL==a})[0]:"function"===typeof a&&(b=this.images.filter(a)[0]);return!b?void 0:b.rect};
ImageLayer.prototype.addAnimationConductor=function(a,b){b in this.animationConductors||(a.layer=this,this.animationConductors[b]=a)};ImageLayer.prototype.clearAnimationConductors=function(){this.animationConductors.forEach(function(a){a.stop()});this.animationConductors=[]};var BaseLayer=function(){ImageLayer.call(this);this.backgroundSolid=new DrawableSolidColor;this.backgroundSolid.rect=new Rect(0,0,this.rect.width,this.rect.height);this.backgroundSolid.color=config.backgroundColor};
BaseLayer.prototype=Object.create(ImageLayer.prototype);BaseLayer.prototype.initializer="BaseLayer";BaseLayer.prototype.children=function(){return[this.backgroundSolid].concat(this.images)};var GlyphLayer=function(){ImageLayer.call(this);this.triedLoadCurrentAnimationFile=!1;this.parentLayer=void 0};GlyphLayer.prototype=Object.create(ImageLayer.prototype);GlyphLayer.prototype.initializer="GlyphLayer";
GlyphLayer.prototype.objectToBeSerialized=function(a){switch(a){case "parentLayer":case "triedLoadCurrentAnimationFile":return}return ImageLayer.prototype.objectToBeSerialized.apply(this,arguments)};GlyphLayer.prototype.importFromSaveData=function(){return ImageLayer.prototype.importFromSaveData.apply(this,arguments)};GlyphLayer.prototype.redrawRect=function(){this.requestedFrame=!0;this.parentLayer&&this.parentLayer.redrawRect(this.rect);ImageLayer.prototype.redrawRect.apply(this,arguments)};
GlyphLayer.prototype.draw=function(){this.requestedFrame=!0;this.parentLayer&&this.parentLayer.redrawRect(this.rect);ImageLayer.prototype.draw.apply(this,arguments)};GlyphLayer.prototype.drawOnContext=function(){this.flush();ImageLayer.prototype.drawOnContext.apply(this,arguments)};
GlyphLayer.prototype.showOnLayer=function(a,b){var c=this,d=b+".asd";this.parentLayer=a;return $.when(function(){if(!(c.images.length&&c.images[0].image.originalURL===b))return c.triedLoadCurrentAnimationFile=!1,c.loadImage(b)}()).then(function(){if(c.animationConductors.length&&c.animationConductors[0].file.filename==d){c.visible=!0;if(c.animationConductors[0].status==Conductor.STATUS_STOP)c.animationConductors[0].oneShot();return"loaded"}return c.triedLoadCurrentAnimationFile?void 0:KAGFiles(d)}).then(function(a){"loaded"!==
a&&(c.triedLoadCurrentAnimationFile=!0,a?(a=new AnimationConductor({file:a}),c.addAnimationConductor(a,0),a.run(),c.visible=!0):o2.warn(d+"\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u3067\u3059\u3002"))})};GlyphLayer.prototype.hide=function(){this.visible&&(this.visible=!1,this.redrawRect(),this.animationConductors.length&&this.animationConductors[0].status!==Conductor.STATUS_STOP&&(this.animationConductors[0].status=Conductor.STATUS_STOP,this.animationConductors[0].queue.push(new Tag("s"))))};
TextProperties=function(a){Drawable.call(this);this.text=a;this.rubyText;this.styles={opacity:1,size:20,face:"Arial",visible:!1,shadowBlur:5,vertical:void 0,shadowOffsetX:0,shadowOffsetY:0};this.useCanvasCache=!1;this.canvas};TextProperties.prototype=new Drawable;TextProperties.prototype.initializer="TextProperties";TextProperties.prototype.importFrom=function(a){Drawable.prototype.importFrom.call(this,a);this.text=a.text;this.rubyText=a.rubyText;this.styles=clone(a.styles);this.useCanvasCache=a.useCanvasCache};
TextProperties.prototype.objectToBeSerialized=function(a){switch(a){case "canvas":return}return this[a]};
TextProperties.prototype.drawOnContext=function(a){if(this.styles.visible&&0!=this.styles.opacity){if(this.useCanvasCache){var b=this.frame();if(!this.canvas){this.canvas=document.createElement("canvas");this.canvas.width=b.width;this.canvas.height=b.height;var c=this.canvas.getContext("2d");c.textBaseline="top";var d=this.rect.x-b.x,e=this.rect.y-b.y;this.useCanvasCache=!1;var g=this.rect,i=this.styles.opacity;this.styles.opacity=1;this.rect=new Rect(d,e,this.rect.width,this.rect.height);this.drawOnContext(c);
this.rect=g;this.styles.opacity=i;this.useCanvasCache=!0}a.save();a.globalAlpha=this.styles.opacity;a.drawImage(this.canvas,b.x,b.y,this.canvas.width,this.canvas.height)}else a.save(),b=this.styles.color,a.fillStyle!=b&&(a.fillStyle=b),this.styles.shadow?(a.shadowColor=this.styles.shadowColor,a.shadowBlur=this.styles.shadowBlur,a.shadowOffsetX=this.styles.shadowOffsetX,a.shadowOffsetY=this.styles.shadowOffsetY):a.shadowBlur=0,a.globalAlpha!=this.styles.opacity&&(a.globalAlpha=this.styles.opacity),
this.styles.vertical?this.fillTextVertical(a):(this.rubyText&&(b=this.rubyFont(),a.font!=b&&(a.font=b),b=this.measureRuby(a),c=(this.rect.width-b.width)/2,a.lineJoin="round",a.lineWidth=this.styles.size/5,a.strokeStyle=this.styles.edgeColor,a.strokeText(this.rubyText,this.rect.x+c,this.rect.y-b.height-this.styles.rubyOffset),a.fillText(this.rubyText,this.rect.x+c,this.rect.y-b.height-this.styles.rubyOffset)),b=this.font(),a.font!=b&&(a.font=b),this.styles.edge&&(a.lineJoin="round",a.lineWidth=this.styles.size/
5,a.strokeStyle=this.styles.edgeColor,a.strokeText(this.text,this.rect.x,this.rect.y)),a.fillText(this.text,this.rect.x,this.rect.y));a.restore()}};TextProperties.prototype.clearCache=function(){this.canvas&&($(this.canvas).remove(),this.canvas=void 0)};
TextProperties.prototype.frame=function(){var a=0;this.styles.edge&&(a+=0.2*this.styles.size);a=new Rect({x:this.rect.x-a,y:this.rect.y-a,width:this.rect.width+2*a,height:this.rect.height+2*a});if(this.styles.shadow){var b=new Rect({x:a.x-this.styles.shadowBlur,y:a.y-this.styles.shadowBlur,width:a.width+2*this.styles.shadowBlur,height:a.height+2*this.styles.shadowBlur});b.x+=this.styles.shadowOffsetX;b.y+=this.styles.shadowOffsetY;a.extend(b)}if(browser.isIOs||browser.isAndroid)a.height+=5;if(this.rubyText){var b=
this.measureRuby(),c;c=this.styles.vertical?new Rect({x:this.rect.x+this.rect.width+this.styles.rubyOffset,y:this.rect.y+(this.rect.height-b.height)/2-10,width:b.width,height:b.height+10}):new Rect({x:this.rect.x+(this.rect.width-b.width)/2,y:this.rect.y-this.styles.rubySize+this.styles.rubyOffset-10,width:b.width,height:b.height+10});this.styles.edge&&(c.x-=0.1*b.width,c.y-=0.1*b.height,c.width+=0.2*b.width,c.height+=0.2*b.height);a.extend(c)}this.styles.italic&&(a.width+=10);return a};
TextProperties.prototype.font=function(){var a="";this.styles.italic&&(a+="italic ");this.styles.bold&&(a+="bold ");a+=this.styles.size+"px ";a+=this.styles.face;return a+" , Arial"};TextProperties.prototype.rubyFont=function(){return this.styles.rubySize+"px "+this.styles.face};TextProperties.prototype.measure=function(a){a.save();var b=this.font();a.font!=b&&(a.font=b);this.styles.vertical?b=this.measureVertical(a,this.text):(b=a.measureText(this.text),b.height=this.styles.size);a.restore();return b};
TextProperties.prototype.measureRuby=function(a){a||(a=o2.currentMessageLayer.ctx);a.save();var b=this.rubyFont();this.font!=b&&(a.font=b);this.styles.vertical?b=this.measureVertical(a,this.rubyText,this.styles.rubySize):(b=a.measureText(this.rubyText),b.height=this.styles.rubySize);a.restore();return b};
(function(){function a(a,b,c,d,e){var g=c*Math.PI/180,c=Math.cos(g),g=Math.sin(g);return[[a*c,b*g],[-a*g,b*c],[a*(c*d-g*e),b*(g*d+c*e)]]}function b(b,k,l,n,p){var q=b.measureText(k),p=p||this.styles.size,m=this.styles.size;k in c&&(k=c[k]);var r="";-1!=d.indexOf(k)?r="offsetTopRight":-1!=e.indexOf(k)?r="offsetRight":-1!=g.indexOf(k)?(l+=m,n-=p,r="rotate90"):-1!=i.indexOf(k)&&(l+=m,n-=p,r="reflect45");b.save();a:{var m=l,z=n,D=q.width,H=p;switch(r){case "rotate90":m=a(1,1,90,-m+z+H,-m-z);break a;case "reflect45":m=
a(1,-1,270,-m+z+D,m-z-H);break a;case "offsetTopRight":m=a(1,1,0,0.625*D,-0.625*H);break a;case "offsetRight":m=a(1,1,0,0.125*D,-0.125*H);break a;default:m=[[1,0],[0,1],[0,0]]}}b.setTransform(m[0][0],m[0][1],m[1][0],m[1][1],m[2][0],m[2][1]);this.styles.edge&&(b.lineJoin="round",b.lineWidth=q/5,b.strokeStyle=this.styles.edgeColor,b.strokeText(k,l,n));b.fillText(k,l,n);b.restore();return"rotate90"==r?q.width:p}var c={"\u300a":"\ufe3d","\u300b":"\ufe3e","(":"\ufe35","\uff08":"\ufe35",")":"\ufe36","\uff09":"\ufe36",
"{":"\ufe37","\uff5b":"\ufe37","}":"\ufe38","\uff5d":"\ufe38","\u3010":"\ufe3b","\u3011":"\ufe3c","\uff1c":"\ufe3f","<":"\ufe3f","\uff1e":"\ufe40",">":"\ufe40","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44"},d=["\u3001","\u3002"],e="\u3041\u3043\u3045\u3047\u3049\u3063\u3083\u3085\u3087\u308e\u30f5\u30f6",g="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ~\u301c\u2026s\uff07\u2500\u2502\u250c\u2510\u2518\u2514\u251c\u252c\u2524\u2534\u253c\u2501\u2503\u250f\u2513\u251b\u2517\u2523\u2533\u252b\u253b\u254b\u2520\u252f\u2528\u2537\u253f\u251d\u2530\u2525\u2538\u2542".split(""),
i=["\u30fc","\u2015","\uff5e"];TextProperties.prototype.measureVertical=function(a,b,c){for(var b=b.split(""),d=0,e=0,i=0;i<b.length;i++){var m=b[i],r=a.measureText(m).width,z=c||this.styles.size;-1!=g.indexOf(m)&&(m=z,z=r,r=m);e+=z;d<r&&(d=r)}return{width:d,height:e}};TextProperties.prototype.fillTextVertical=function(a){var c=this.text.split(""),d=this.rect.y,e=this.font();a.font!=e&&(a.font=e);a.save();for(e=0;e<c.length;e++)var g=c[e],d=d+b.call(this,a,g,this.rect.x,d);a.restore();if(this.rubyText){e=
this.rubyFont();a.font!=e&&(a.font=e);d=this.measureRuby(a);d=(this.rect.height-d.height)/2;c=this.rubyText.split("");d=this.rect.y+d;for(e=0;e<c.length;e++)g=c[e],d+=b.call(this,a,g,this.rect.x+this.rect.width+this.styles.rubyOffset,d,this.styles.rubySize)}}})();TextProperties.prototype.calculateSize=function(){var a=this.measure();this.rect.width=a.width;this.rect.height=a.height;return a};
TextProperties.prototype.isEqual=function(a){if(!(a instanceof TextProperties)||!this.frame().isEqual(a.frame()))return!1;for(var b in this.styles)if(this.styles[b]!=a.styles[b])return!1;return!0};Button=function(a,b,c){DrawableImage.call(this,a,b,c);this.cacheEnabled=!1;this.state=Button.STATE_NORMAL};Button.prototype=Object.create(DrawableImage.prototype);Button.prototype.initializer="Button";Button.STATE_NORMAL=0;Button.STATE_HOVER=1;Button.STATE_DOWN=2;Button.STATE_DISABLE=3;
Button.prototype.click=function(){this.state=Button.STATE_HOVER};Button.prototype.enter=function(){this.state=Button.STATE_HOVER};Button.prototype.leave=function(){this.state=Button.STATE_NORMAL};Button.prototype.mousemove=function(){};Button.prototype.mousedown=function(){this.state=Button.STATE_DOWN};Button.prototype.cancel=function(){this.state=Button.STATE_NORMAL};Button.prototype.clone=function(){var a=new Button(this.image);a.importFrom(this);return a};
Button.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(){var b=new Button(image);b.importFrom(a);return b})};Link=function(){DrawableSolidColor.call(this);this.color=config.messageLayerDefaultLinkColor||"#0000ff";this.opacity=config.messageLayerDefaultLinkOpacity;this.hovering;this.textsProperties=[];this.rects=[];this.vertical=!1;this.messageLayer};Link.prototype=Object.create(DrawableSolidColor.prototype);Link.prototype.initializer="Link";Link.restore=function(){return(new Link).importFromSaveData()};
Link.prototype.objectToBeSerialized=function(a){switch(a){case "messageLayer":return}return this[a]};Link.prototype.importFrom=function(a){DrawableSolidColor.prototype.importFrom.call(this,a);this.vertical=a.vertical;this.textsProperties=a.messageLayer?a.textsProperties.map(function(a){return a}):clone(a.textsProperties);this.refreshRects()};Link.prototype.isHovering=function(a,b){for(var c=0;c<this.rects.length;c++)if(this.rects[c].coverCoordinate(a,b))return!0;return!1};
Link.prototype.drawOnContext=function(a){if(this.hovering){for(var b=this.rect,c=0;c<this.rects.length;c++)this.rect=this.rects[c],DrawableSolidColor.prototype.drawOnContext.call(this,a);this.rect=b}};Link.prototype.addTextProperties=function(a){a instanceof Array?this.textsProperties=this.textsProperties.concat(a):this.textsProperties.push(a);this.refreshRects()};
Link.prototype.refreshRects=function(){this.rects=[];this.rect=new Rect;for(var a,b=0;b<this.textsProperties.length;b++){var c=this.textsProperties[b].frame();a||(a=new Rect);a.extend(c);if(b==this.textsProperties.length-1||this.textsProperties[b+1].frame().y!=c.y&&!this.vertical||this.textsProperties[b+1].frame().x!=c.x&&this.vertical)this.rects.push(a),this.rect.extend(a),a=void 0}};Link.prototype.click=Link.prototype.enter=Link.prototype.leave=function(){};
MessageLayer=function(a){Layer.call(this,a||new Rect({x:config.messageLayerCurrentPositionX,y:config.messageLayerCurrentPositionY,width:config.messageLayerCurrentWidth,height:config.messageLayerCurrentHeight}));this.frameImage;this.frameSolid=new DrawableSolidColor(new Rect(0,0,this.rect.width,this.rect.height));this.frameSolid.color=config.messageLayerColor||"#000";this.frameSolid.opacity=config.messageLayerOpacity;this.visible=!1;this.opacity=1;this.margin={top:config.messageLayerMarginT||20,right:config.messageLayerMarginR||
20,bottom:config.messageLayerMarginB||20,left:config.messageLayerMarginL||20};this.textsProperties=[];this.vertical=config.messageLayerVertical;this.textCursor={x:0,y:0};this.align="left";this.delaySpeed=config.chSpeeds||20;this.ctx.textBaseline="top";this.defaultFont=MessageLayer.defaults.defaultFont();this.defaultStyle=MessageLayer.defaults.defaultStyle();this.font=clone(this.defaultFont);this.style=clone(this.defaultStyle);ResourceLoader.loadFont(this.defaultFont.face);ResourceLoader.loadFont(this.font.face);
this.glyphOptions=MessageLayer.defaults.glyphOptions();this.textCustomizers=["baseTextCustomizer","alignTextCustomizer"];this.isDrawingText=!1;this.buttons=[];this.routineButtons=[];this.links=[];this.images=[];this.lastLineSize=0;this.resetCursor();var b=this;setTimeout(function(){$(conductor).on("ran",function(){b.refreshRoutineButtons()})})};MessageLayer.prototype=Object.create(Layer.prototype);MessageLayer.prototype.initializer="MessageLayer";
MessageLayer.defaults={defaultFont:function(){return{size:config.messageLayerDefaultFontSize||20,face:config.messageLayerDefaultFontFace||"Arial",color:config.messageLayerDefaultFontColor||"#000000",rubySize:config.messageLayerDefaultRubySize||10,rubyOffset:config.messageLayerDefaultRubyOffset||0,shadow:config.messageLayerDefaultShadow,shadowColor:config.messageLayerDefaultShadowColor||"#999999",shadowBlur:config.messageLayerDefaultShadowBlur,shadowOffsetX:config.messageLayerDefaultShadowOffsetX,
shadowOffsetY:config.messageLayerDefaultShadowOffsetY,edge:config.messageLayerDefaultEdge,edgeColor:config.messageLayerDefaultEdgeColor||"#00ff00",bold:config.messageLayerDefaultFontBold,italic:config.messageLayerDefaultFontItalic}},font:function(){return this.defaultFont()},defaultStyle:function(){return{lineSpacing:Number(config.messageLayerDefaultStyleLineSpacing)||0,pitch:Number(config.messageLayerDefaultStylePitch)||0,lineSize:0,align:"left",autoReturn:config.messageLayerDefaultAutoReturn,kinsoku:MessageLayer.KINSOKU_BURASAGARI,
kinsokuBolChar:" \u3002\uff0e\u3001\uff0c\u300d\u300f\uff09\u3009\u3011\u300b\uff3d\u3015\u201d\uff5d\u2019\u301f\uff1f\uff01\u2047\u203c\u2048\u2049",kinsokuEolChar:"\u300c\u300e\uff08\u3008\u3010\u300a\uff3b\u3014\u201c\uff5b\u2018\u301d",kinsokuBurasagariChar:"\u3002\uff0e\u3001\uff0c"}},style:function(){return this.defaultStyle()},glyphOptions:function(){return{line:config.messageLayerDefaultGlyphLine,page:config.messageLayerDefaultGlyphPage,fixed:config.messageLayerDefaultGlyphFixed,x:config.messageLayerDefaultGlyphX,
y:config.messageLayerDefaultGlyphY}}};MessageLayer.prototype.objectToBeSerialized=function(a){switch(a){case "textsProperties":case "links":case "glyphLayer":case "isDrawingText":return}if(-1==["buttons","routineButtons","images"].indexOf(a)||this[a].length){if(MessageLayer.defaults.hasOwnProperty(a)){var b=MessageLayer.defaults[a]();if(!b)return;var c={},d;for(d in this[a])this[a][d]!=b[d]&&(c[d]=this[a][d]);return c}return Layer.prototype.objectToBeSerialized.call(this,a)}};
MessageLayer.prototype.importFromSaveData=function(a){var b=this;this.buttons=[];var c=[];if(a.buttons){for(var d=0;d<a.buttons.length;d++)c.push($.when(a.buttons[d].restore()).done(function(a){b.addButton(a)}));delete a.buttons}this.images=[];if(a.images)for(d=0;d<a.images.length;d++)c.push($.when(a.images[d].restore()).done(function(a){b.images.push(a)}));delete a.images;this.links=[];if(a.links)for(d=0;d<a.links.length;d++)c.push($.when(a.links[d].restore()).done(function(a){b.addLink(a)}));delete a.links;
this.textCustomizers=[];this.textsProperties=[];c.push(Layer.prototype.importFromSaveData.call(this,a));a.font.face&&c.push(ResourceLoader.loadFont(a.font.face));a.defaultFont.face&&c.push(ResourceLoader.loadFont(a.defaultFont.face));return $.when.apply($,c).then(function(){b.setRect(b.rect);b.redrawRect();return b})};MessageLayer.KINSOKU_NONE=0;MessageLayer.KINSOKU_OIDASHI=1;MessageLayer.KINSOKU_BURASAGARI=2;
MessageLayer.prototype.children=function(){var a=[];this.frameImage?a.push(this.frameImage):a.push(this.frameSolid);a=a.concat(this.textsProperties,this.links,this.images,this.buttons,this.routineButtons);this.glyphLayer&&a.push(this.glyphLayer);return a};
MessageLayer.prototype.importFrom=function(a){if(!(a instanceof MessageLayer))throw"[\u5185\u90e8\u30a8\u30e9\u30fc] otherLayer\u306fMessageLayer\u3067\u306f\u3042\u308a\u307e\u305b\u3093";Layer.prototype.importFrom.call(this,a);var b="frameImage frameSolid margin textsProperties vertical lineWidth textCursor align delaySpeed defaultFont defaultStyle font style textCustomizers buttons images routineButtons".split(" ");if(this.isDrawingText){var c=b.indexOf("textsProperties");0>c||b.splice(c,1)}for(c=
0;c<b.length;c++){var d=b[c];this[d]=clone(a[d])}this.links=[];for(var e=this,c=0;c<a.links.length;c++){var g=a.links[c],b=clone(g);b.textsProperties=g.textsProperties.map(function(a){a=g.messageLayer.textsProperties.indexOf(a);if(-1==a)debugger;else return e.textsProperties[a]});this.addLink(b)}this.setRect(clone(a.rect),!0)};
MessageLayer.prototype.mousemove=function(a){if(!this.visible||!Layer.prototype.mousemove.apply(this,arguments))return!1;var b=!1,c=a.originalEvent.normalizedCoordinate(this);this.refreshRoutineButtons(c.x,c.y)&&(b=!0);this.refreshButtons(c.x,c.y)&&(b=!0);this.refreshLinks(c.x,c.y)&&(b=!0);return b};
MessageLayer.prototype.mouseup=function(a){if(!this.visible||!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var b=a.originalEvent.normalizedCoordinate(this),c=this.buttons.length-1;0<=c;c--){var d=this.buttons[c];if(!d.rect.coverCoordinate(b.x,b.y)&&d.state==Button.STATE_DOWN)return d.leave(b.x,b.y,this),this.redrawRect(d.rect),!0}for(c=this.routineButtons.length-1;0<=c;c--)if(d=this.routineButtons[c],d.rect.coverCoordinate(b.x,b.y)&&d.state!=Button.STATE_DISABLE)return d.click(b.x,
b.y,this),d.state=Button.STATE_HOVER,this.redrawRect(d.rect),!0;for(c=this.buttons.length-1;0<=c;c--)if(d=this.buttons[c],d.rect.coverCoordinate(b.x,b.y))return d.click(b.x,b.y,this),d.state=Button.STATE_HOVER,this.redrawRect(d.rect),!0;for(c=this.links.length-1;0<=c;c--)if(d=this.links[c],d.isHovering(b.x,b.y))return d.click(b.x,b.y,this),!0;return!1};
MessageLayer.prototype.mousedown=function(a){if(!this.visible||!Layer.prototype.mousedown.apply(this,arguments))return!1;for(var b=a.originalEvent.normalizedCoordinate(this),c=this.routineButtons.length-1;0<=c;c--){var d=this.routineButtons[c];if(d.rect.coverCoordinate(b.x,b.y)&&d.state!=Button.STATE_DISABLE)return d.mousedown(b.x,b.y,this),this.redrawRect(d.rect),!0}for(c=this.buttons.length-1;0<=c;c--)if(d=this.buttons[c],d.rect.coverCoordinate(b.x,b.y))return d.mousedown(b.x,b.y,this),this.redrawRect(d.rect),
!0;return!1};MessageLayer.prototype.touchcancel=function(){for(var a=this.routineButtons.length-1;0<=a;a--){var b=this.routineButtons[a];b.cancel()}for(a=this.buttons.length-1;0<=a;a--)b=this.buttons[a],b.cancel()};
MessageLayer.prototype.setRect=function(a,b){a||(a=this.rect);(!a.width||!a.height)&&o2.error("width/height\u306f0\u3067\u3059");var c=this.rect.width!=a.width||this.rect.height!=a.height||this.canvas.width!=a.width||this.canvas.height!=a.height;c&&(this.canvas.width=a.width,this.canvas.height=a.height);this.ctx.textBaseline="top";this.rect=a;this.frameSolid.rect.width=a.width;this.frameSolid.rect.height=a.height;(c||b)&&this.redrawRect()};
MessageLayer.prototype.resetCursor=function(){this.textCursor=this.vertical?{x:this.rect.width-this.margin.right-this.style.lineSpacing,y:this.margin.top}:{x:this.margin.left,y:this.margin.top+this.style.lineSpacing}};MessageLayer.prototype.linebreak=function(){this.vertical?(this.textCursor.y=this.margin.top,this.textCursor.x-=this.style.lineSpacing+this.lastLineSize):(this.textCursor.x=this.margin.left,this.textCursor.y+=this.style.lineSpacing+this.lastLineSize)};
MessageLayer.textCustomizers={baseTextCustomizer:function(a,b,c){this.isAnimation=!1;var d=a.delaySpeed,e=void 0,g=b.concat(c),i;if(!e){for(var e=[],j=a.textCursor.x,k=a.textCursor.y,l=0,n=0,b=void 0,p=0;p<g.length;p++){var q=g[p];q.rect.isZero()&&void 0===q.styles.vertical&&(q.styles.vertical=a.vertical)}for(p=0;p<g.length;p++)if(q=g[p],q.rect.isZero()){if(void 0==b){a.vertical?(l=Math.max(l,a.style.lineSize),a.lastLineSize=l):(n=Math.max(n,a.style.lineSize),a.lastLineSize=n);var m=b=function(){for(var b=
a.vertical?k:j,c=p;c<g.length;c++){var d=g[c].measure(a.ctx);if(a.vertical){if(b+=d.height+a.style.pitch,d.width>l&&(l=d.width,a.lastLineSize=l),b>a.rect.height-a.margin.bottom&&a.style.autoReturn)return c}else if(d.height>n&&(n=d.height,a.lastLineSize=n),b+=d.width+a.style.pitch,b>a.rect.width-a.margin.right&&a.style.autoReturn)return c}return-1}();if(-1!=b){var r=g[b],z=g[b+1];if(a.style.kinsoku==MessageLayer.KINSOKU_BURASAGARI&&-1!=a.style.kinsokuBurasagariChar.indexOf(r.text)&&(!z||-1==a.style.kinsokuBolChar.indexOf(z.text)))z?
b++:b=-1;else if(a.style.kinsoku!=MessageLayer.KINSOKU_NONE)for(;-1!=a.style.kinsokuBolChar.indexOf(g[b].text)||g[b-1]&&-1!=a.style.kinsokuEolChar.indexOf(g[b-1].text);)if(b--,b<=p){b=m;break}}}m=q.measure(a.ctx);b===p?(b=void 0,a.vertical?(k=a.margin.top,j-=l+a.style.lineSpacing,l=0):(j=a.margin.left,k+=n+a.style.lineSpacing,n=0),p--):(e[p]=a.vertical?{x:j-l+(l-m.width)/2,y:k,width:m.width,height:m.height}:{x:j,y:k+n-m.height,width:m.width,height:m.height},q.rect=new Rect(e[p]),a.vertical?k+=m.height+
a.style.pitch:j+=m.width+a.style.pitch)}}i=b=e;var D=this;this.perform=function(){c.forEach(function(a,b){D.timePassed/d>=b&&!a.styles.visible&&(a.styles.visible=!0,a.needRedraw=!0)});i.forEach(function(a,b){g[b].rect=new Rect(a)})};this.isEnded=function(){return D.timePassed/d>=c.length}},alignTextCustomizer:function(a,b,c){if(a.vertical){if("center"!=a.style.align&&"bottom"!=a.style.align)return}else if("left"==a.style.align)return;var d=b.concat(c);this.perform=function(){var b=a.style.align;if(a.vertical)for(l=
k=0;l<d.length;l++){if(i=d[l],l>=d.length-1||i.rect.y>d[l+1].rect.y){for(var c=0,i=k;i<=l;i++)d[i].styles.visible&&(c+=d[i].rect.height+a.style.pitch);var c=c-a.style.pitch,j=0,i=a.rect.height-a.margin.top-a.margin.bottom;"center"==b?j=(i-c)/2:"bottom"==b&&(j=i-c);for(i=k;i<=l;i++)d[i].styles.visible&&(d[i].rect.y=j,d[i].needRedraw=!0,j+=d[i].rect.height+a.style.pitch);k=l+1}}else for(var k=0,l=0;l<d.length;l++){var i=d[l];if(l>=d.length-1||i.rect.x>d[l+1].rect.x){c=0;for(i=k;i<=l;i++)d[i].styles.visible&&
(c+=d[i].rect.width+a.style.pitch);j=0;i=a.rect.width-a.margin.left-a.margin.right;"center"==b?j=(i-c)/2+a.margin.left:"right"==b&&(j=i-c+a.margin.left);for(i=k;i<=l;i++)d[i].styles.visible&&(d[i].rect.x=j,d[i].needRedraw=!0,j+=d[i].rect.width+a.style.pitch);k=l+1}}}}};
MessageLayer.prototype.drawText=function(a,b){function c(){for(var a=!0,d=Date.now()-l,e=0;e<k.length;e++){var g=k[e];g.timePassed=d;if(o2.skipMode||0==this.delaySpeed)g.timePassed=Infinity;"function"===typeof g.perform&&g.perform();"function"===typeof g.isEnded&&!1==g.isEnded()&&(a=!1)}this.redrawRect();for(e=0;e<this.links.length;e++)this.links[e].refreshRects();if(a){if(a=this.textsProperties[this.textsProperties.length-1])this.textCursor=this.vertical?{x:a.rect.x+a.rect.width+(this.lastLineSize-
a.rect.width)/2,y:a.rect.y+a.rect.height}:{x:a.rect.x+a.rect.width,y:a.rect.y+a.rect.height-this.lastLineSize};this.isDrawingText=!1;"function"==typeof b&&setTimeout(b.bind(this),0)}else renderer.animator.requestFrame(c.bind(this),j?0:this.delaySpeed)}this.isDrawingText=!0;var d=this;"string"===typeof a&&(a=a.split(""));for(var e=this.textsProperties.slice(),g=a.map(function(a){if(a instanceof TextProperties)return a;a=new TextProperties(a);$.extend(a.styles,clone(d.font));return a}),i=0;i<g.length;i++)this.textsProperties.push(g[i]);
var j=!1,k=this.textCustomizers.map(function(a){a=MessageLayer.textCustomizers[a];if("function"!=typeof a)o2.error(a+"\u306ftextCustomizer\u3067\u306f\u306a\u3044\u3067\u3059\u3002");else return a=new a(this,e,g),!j&&a.isAnimation&&(j=!0),a},this);(j||0<=["center","right","bottom"].indexOf(this.style.align))&&this.textsProperties.forEach(function(a){a.useCanvasCache=!0});var l=Date.now();c.call(this)};
MessageLayer.prototype.measureText=function(a){"string"===typeof a&&(a=new TextProperties(a),$.extend(a.styles,clone(this.font)));return a.measure(this.ctx)};MessageLayer.prototype.refreshButtons=function(a,b){for(var c=!1,d=this.buttons.length-1;0<=d;d--){var e=this.buttons[d],g=e.rect.coverCoordinate(a,b);this.drawButton(e,g,a,b);if(g||e.state==Button.STATE_DOWN)c=!0,e.mousemove(a,b,this)}return c};
MessageLayer.prototype.drawButton=function(a,b,c,d){b&&a.state==Button.STATE_NORMAL?(a.enter(c,d,this),this.redrawRect(a.rect)):!b&&a.state==Button.STATE_HOVER&&(a.leave(c,d,this),this.redrawRect(a.rect))};MessageLayer.prototype.addButton=function(a){this.buttons.push(a);this.draw(a)};
MessageLayer.prototype.refreshRoutineButtons=function(a,b){for(var c=!1,d=[],e=-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName),g=this.routineButtons.length-1;0<=g;g--){var i=this.routineButtons[g],j=a&&b?i.rect.coverCoordinate(a,b):!1;j?d.push(i):this.drawRoutineButton(i,j,e,a,b);j&&(e&&i.enabled)&&(c=!0)}for(g=0;g<d.length;g++)i=d[g],this.drawRoutineButton(i,!0,e,a,b);return c};
MessageLayer.prototype.drawRoutineButton=function(a,b,c,d,e){var g=Button.STATE_NORMAL;c?b?(g=Button.STATE_HOVER,a.state!=Button.STATE_HOVER&&(a.enter(d,e,this),this.redrawRect(a.rect))):(g=Button.STATE_NORMAL,a.state==Button.STATE_HOVER&&(a.leave(d,e,this),this.redrawRect(a.rect))):g=Button.STATE_DISABLE;a.state!=g&&(a.state=g,this.redrawRect(a.rect))};MessageLayer.prototype.addRoutineButton=function(a){this.routineButtons.push(a);this.draw(a)};
MessageLayer.prototype.refreshLinks=function(a,b){for(var c=!1,d=this.links.length-1;0<=d;d--){var e=this.links[d],g=e.isHovering(a,b);this.drawLink(e,g,a,b);g&&(c=!0)}return c};MessageLayer.prototype.drawLink=function(a,b,c,d){b&&!a.hovering?(a.enter(c,d,this),a.hovering=!0,a.visible=!0,this.draw(a)):!b&&a.hovering&&(a.leave(c,d,this),a.hovering=!1,a.visible=!1,this.redrawRect(a.rect))};MessageLayer.prototype.addLink=function(a){a.vertical=this.vertical;a.messageLayer=this;this.links.push(a)};
MessageLayer.prototype.addButtonLinkImages=function(){for(var a=0;a<this.buttons.length;a++){var b=this.buttons[a],c=new DrawableCanvas(b.rect);b.rect.x=b.rect.y=0;b.drawOnContext(c.ctx);this.images.push(c);this.redrawRect(c.rect)}for(a=0;a<this.links.length;a++)if(b=this.links[a],b.visible&&b.hovering)for(var d=0;d<b.rects.length;d++)c=new DrawableSolidColor(b.rects[d]),c.importFrom(b),this.images.push(c),this.redrawRect(c.rect)};
MessageLayer.prototype.showGlyphLayer=function(a,b){this.glyphLayer=a;var c=this;this.glyphLayer.showOnLayer(this,"line"===(b||"line")?this.glyphOptions.line:this.glyphOptions.page).done(function(){c.glyphOptions.fixed?(a.rect.x=c.glyphOptions.x,a.rect.y=c.glyphOptions.y):c.vertical?(a.rect.x=c.textCursor.x+c.font.size-a.rect.width,a.rect.y=c.textCursor.y):(a.rect.x=c.textCursor.x,a.rect.y=c.textCursor.y+Math.max(c.style.lineSize,c.font.size)-a.rect.height);c.redrawRect(a.rect)})};
MessageLayer.prototype.hideGlyphLayer=function(){this.glyphLayer&&this.glyphLayer.hide();this.glyphLayer=void 0};MessageLayer.prototype.resetFrameSize=function(){this.frameSolid.rect.width=this.rect.width;this.frameSolid.rect.height=this.rect.height};
MessageLayer.prototype.setFrameImage=function(a){if(void 0!=a&&!(a instanceof Drawable))throw"[\u5185\u90e8\u30a8\u30e9\u30fc] image\u306fdrawable\u3067\u306f\u3042\u308a\u307e\u305b\u3093";this.frameImage?this.redrawRect(this.frameImage.frame()):this.redrawRect(this.rect);(this.frameImage=a)&&this.redrawRect(this.frameImage.rect)};
MessageLayer.prototype.resetMessageLayer=function(){for(var a=this.buttons.length-1;0<=a;a--)this.redrawRect(this.buttons[a].frame());for(a=this.textsProperties.length-1;0<=a;a--)this.redrawRect(this.textsProperties[a].frame());this.buttons=[];this.routineButtons=[];this.images=[];this.links=[];this.textsProperties=[];this.font=clone(this.defaultFont);this.style=clone(this.defaultStyle);this.resetCursor();this.resetFrameSize();this.redrawRect()};
var Sound=function(a){this.filepath;this.isPlaying=!1;this.volumePercentage=this.volume=1;this.loop=!1;this.pan=0;this.loadDefer;this.audio=new Audio;this.fadeDefer;this.fadeStatus;"string"==typeof a&&this.setFile(a)};Sound.prototype.objectToBeSerialized=function(a){switch(a){case "audio":case "loadDefer":return}return this[a]};
Sound.prototype.importFromSaveData=function(a){this.filepath=void 0;var b=this;return Object.prototype.importFromSaveData.call(this,a).then(function(){b.fadeStatus&&(b.fadeStatus.sound=b);if(b.filepath){var a=b.setFile(b.filepath);b.isPlaying&&b.loop&&b.play();return a}})};
Sound.prototype.setFile=function(a){this.filepath=a;var b=this;this.loadDefer=ResourceLoader.loadAudio(a,!0,this.audio);this.loadDefer.done(function(a){b.setVolume(b.volume);a.loop=b.loop;$(a).off();$(a).on("ended",function(){$(b).trigger("ended");b.isPlaying=!1;if(b.loop&&(browser.isFirefox||browser.isAndroid))a.currentTime=0,a.play()})});return this.loadDefer};
Sound.prototype.play=function(a){if(!browser.supportsMultipleAudio&&this!=o2.prioritySound)o2.warn("\u518d\u751f\u3057\u3088\u3046\u3068\u3057\u3066\u3044\u307e\u3059\u304c\u3001config.AudioChannel\u3068\u306f\u9055\u3044\u307e\u3059\u306e\u3067\u3057\u306a\u304b\u3063\u305f");else{this.stopFade();a&&this.setFile(a);this.isPlaying=!0;if(this.loadDefer)return this.loadDefer.done(function(a){a.play()}),this.loadDefer;o2.warn("\u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb\u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u518d\u751f\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f")}};
Sound.prototype.pause=function(){this.isPlaying=!1;this.loadDefer&&this.loadDefer.done(function(a){a.pause()})};Sound.prototype.stop=function(){this.isPlaying=!1;if(this.loadDefer){var a=this;this.loadDefer.done(function(){a.pause();a.setTime(0)})}};Sound.prototype.setTime=function(a){this.loadDefer.done(function(b){try{b.currentTime=a/1E3}catch(c){$(b).one("loadedmetadata",function(){b.currentTime=a/1E3})}})};
Sound.prototype.setVolume=function(a){if(0>a||1<a)o2.error("\u30dc\u30ea\u30e5\u30fc\u30e0\u306e\u6307\u5b9a\u304c\u4e0d\u6b63\u3067\u3059");else if(this.volume=a,this.loadDefer){var b=this;this.loadDefer.done(function(a){a.volume=b.volume*b.volumePercentage})}};Sound.prototype.setLoop=function(a){this.loop=a;this.loadDefer&&!browser.isFirefox&&!browser.isAndroid&&this.loadDefer.done(function(b){b.loop=a})};Sound.prototype.setPan=function(a){this.pan=a};
Sound.prototype.fade=function(a){if(a){this.fadeStatus&&this.stopFade();"fromVolume"in a||(a.fromVolume=this.volume);"toVolume"in a||(a.toVolume=this.volume);if(this.loadDefer){this.fadeStatus=new SoundFade(this,a);var b=this;this.fadeStatus.defer.done(function(){delete b.fadeStatus});this.loadDefer.done(function(){b.fadeStatus&&b.fadeStatus.start()});return this.fadeStatus.defer}o2.log("\u30b5\u30a6\u30f3\u30c9\u30d5\u30a1\u30a4\u30eb\u3092\u6307\u5b9a\u3055\u308c\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u30d5\u30a7\u30fc\u30c9\u51e6\u7406\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f")}else if(this.fadeStatus)return this.fadeStatus.defer};
Sound.prototype.stopFade=function(){this.fadeStatus&&this.fadeStatus.stop()};Sound.prototype.dummyLoad=function(){this.audio.src="x";this.audio.load()};SoundFade=function(a,b){this.sound=a;this.fromVolume=1;this.toVolume=0;this.duration=1E3;b&&$.extend(this,b);this.intervalId;this.defer=$.Deferred()};SoundFade.prototype.initializer="SoundFade";
SoundFade.prototype.start=function(){function a(){var a=(Date.now()-b)/this.duration;1<a&&(a=1);this.sound.setVolume(this.fromVolume+(this.toVolume-this.fromVolume)*a);1<=a&&this.stop()}var b=Date.now();this.intervalId=setInterval(a.bind(this),1E3/60);a.call(this)};SoundFade.prototype.stop=function(){clearInterval(this.intervalId);this.sound.setVolume(this.toVolume);this.defer.resolve()};SoundFade.prototype.objectToBeSerialized=function(a){switch(a){case "defer":case "sound":return}return this[a]};
var Tag,TagAction;Tag=function(a,b,c){this.file;this.tagName=a;this.args=b||{};c&&(this.callbackArgs=c);this.callbackTags;this.scopeVars;this.isDependency;this.lineNumber;this.originalLineNumber;this.originalCharNumber;this.conductor};Tag.prototype.getAction=function(a){return this.conductor&&"function"===typeof this.conductor.getTagAction?this.conductor.getTagAction(a):Tag.actions[a]};Tag.prototype.isOpen=function(){return void 0!=this.callbackArgs};Tag.prototype.isClose=function(){return"/"===this.tagName};
Tag.prototype.getOpenTag=function(){if(this.isClose()&&this.file){if(this.openTag)return this.openTag;var a;a:{a=1;for(var b=this.lineNumber-1;0<b;b--){var c=this.file.lines[b];c.isClose()?a++:c.isOpen()&&a--;if(0==a){c.closeTag=this;a=this.openTag=c;break a}}a=void 0}b=this.conductor.stack[this.conductor.stack.length-1];if(a&&b&&b instanceof a)return b;debugger;throw"something wrong in stack";}};
Tag.prototype.getCloseTag=function(){if(this.isOpen()&&this.file){if(this.closeTag)return this.closeTag;for(var a=1,b=this.lineNumber+1;b<this.file.lines.length;b++){var c=this.file.lines[b];c.isOpen()?a++:c.isClose()&&a--;if(0==a)return c.openTag=this,this.closeTag=c}}};Tag.prototype.getCallbackFile=function(){if(this.callbackFile)return this.callbackFile;var a=this.getCloseTag();if(a)return this.callbackFile=a=new PartialFile(this.file,this.lineNumber+1,a.lineNumber-1)};
Tag.prototype.getCallbackTask=function(){var a=this.getCallbackFile();if(a)return a=new Conductor.DispatchTask(a),a.args=this.callbackArgs,a};Tag.prototype.makeScopeVars=function(a){if(a instanceof Array){for(var b={},c=0;c<this.callbackArgs.length;c++)b[this.callbackArgs[c]]=a[c];return b}};
Tag.prototype.setScopeVars=function(a){if(this.isOpen()){var b=this.conductor.callbackVarsStack.indexOf(this.scopeVars);this.scopeVars=a instanceof Array?this.makeScopeVars(a):a;-1==b?this.conductor.callbackVarsStack.push(this.scopeVars):this.conductor.callbackVarsStack[b]=this.scopeVars}};Tag.prototype.keepStack=function(){throw"keepStack\u306fclose tag\u306e\u307f\u4f7f\u3048\u308b";};
Tag.prototype.getScopeTokens=function(a){a instanceof File?a=a.lines:a instanceof Conductor.DispatchTask&&(a=a.file.lines);if(!(a instanceof Array))throw"Not array";var b=[];a.forEach(function(a){if(a.args)for(var d in a.args){var e=a.args[d];if("$"!=e.charAt(0))break;e=e.substring(1);if(-1!=b.indexOf(e))break;b.push(e)}});return b};
Tag.prototype.flattenCurrentScope=function(a){if(!this.conductor)return{};var b={};this.conductor.callbackVarsStack.forEach(function(c){for(var d in c)if(!a||a(d,c[d]))b[d]=c[d]});return b};
Tag.prototype.run=function(){var a=this.tagName,b=this.getAction(a);if(this.isClose()){var c=this.conductor.stack[this.conductor.stack.length-1];if(!c){this.error("open tag\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093");return}a=c.tagName;b=this.getAction(a);if(!b)return;var b=b.closeAction,a=0,d=!0;"function"===typeof b&&(a=Object.create(this),a.keepStack=function(){d=!1},a=b.call(a,c));d&&(this.conductor.stack.pop(),c.scopeVars&&this.conductor.callbackVarsStack.pop());return a}if(b){c=this.argsForAction();
a=Object.create(this);a.conductor=this.conductor;if(this.isOpen()){a.conductor.stack.push(a);var e=this.getCloseTag();this.conductor.setTag(e)}return a=b.action.call(a,c)}this.warn("\u30bf\u30b0\u30cf\u30f3\u30c9\u30e9\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093");this.isOpen()&&this.conductor.setTag(this.getCloseTag(),!0)};
Tag.prototype.preload=function(){var a=this.getAction(this.tagName);if(acthisTagActiontthisTagActionion&&"function"===typeof a.preload){var b=this.validate(this.args);return a.preload.call(this,b)}};
Tag.prototype.normalizedArgs=function(a){var a=a?clone(a):clone(this.args),b,c;for(c in a){var d=a[c],e=this.getAction(this.tagName);e&&(e=e.rules)&&!(c in e)&&("o2_cond"!=c&&"*"!=c)&&this.warn(c+"\u3068\u3044\u3046\u672a\u77e5\u306e\u5c5e\u6027\u304c\u3042\u308a\u307e\u3059");if("*"===c)for(var g in window.mp)window.mp.hasOwnProperty(g)&&(a[g]=window.mp[g]);else if(e=function(){b||(b=this.flattenCurrentScope());for(var a in b)d=d.replace("$"+a,"Tag.tempScopeObj."+a);Tag.tempScopeObj=b;d=eval(d);
delete Tag.tempScopeObj;return d}.bind(this),a.hasOwnProperty(c)&&"string"===typeof d){switch(d.charAt(0)){case "&":d=d.substring(1);d=-1!=d.indexOf("$")?e(d):eval(d);break;case "%":d=d.substring(1);values=d.split("|");e=this.conductor.macroStack[this.conductor.macroStack.length-1];d=void 0!==e.args[values[0]]?e.args[values[0]]:values[1];break;case "$":if(/[\-\+\/\\\*()"'\s|&{:}!=><\[\]\;\?]/.test(d))d=e(d);else{for(var d=d.substring(1),e=d.split("."),i=e[0],j=this.conductor.callbackVarsStack.length-
1;0<=j;j--){var k=this.conductor.callbackVarsStack[j];if(i in k){d=k[i];e.shift();break}}0>j?d=void 0:e.forEach(function(a){a in d&&(d=d[a])})}}a[c]=d}}return a};Tag.prototype.argsForAction=function(){return this.validate(this.normalizedArgs(this.args))};
Tag.prototype.validate=function(a){var a=a?clone(a):{},b=this.getAction(this.tagName);if(!b)return a;b=b.rules;if(!b)return a;if("function"==typeof b)return b(a);for(var c in b){var d=a[c],e=b[c];b[c].required&&void 0===d&&this.error("\u5fc5\u9808\u306e\u5c5e\u6027 "+c+" \u304c\u6307\u5b9a\u3055\u308c\u3066\u3044\u307e\u305b\u3093");void 0===d&&"defaultValue"in e&&(d="function"===typeof e.defaultValue?e.defaultValue():e.defaultValue);if(e.type&&void 0!==d){if("allowString"in e&&"string"===typeof d)for(var g=
!1,i=e.allowString.length-1;0<=i;i--)if(e.allowString[i]===d){g=!0;break}if(!g)if(e.type in Tag.validators)try{d=Tag.validators[e.type](d)}catch(j){console.trace&&console.trace(),this.error(c+"\u306f"+j)}else e.type instanceof RegExp&&(e.type.test(d)||this.error("\u5c5e\u6027 "+c+" \u306e\u5024\u306f "+e.type.toString()+" \u578b\u3067\u306a\u3051\u308c\u3070\u306a\u308a\u307e\u305b\u3093"))}void 0!==d&&(a[c]=d)}return a};
Tag.validators={STRING:function(a){return String(a)},BOOLEAN:function(a){if("boolean"===typeof a)return a;if("string"===typeof a){if("true"===a||"1"===a)return!0;if("false"===a||"0"===a)return!1}else if("number"===typeof a){if(0===a)return!1;if(1===a)return!0}throw"boolean\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";},INT:function(a){if(isNaN(parseFloat(a))||!isFinite(a))throw"int\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return parseInt(a)},FLOAT:function(a){if(isNaN(parseFloat(a))||
!isFinite(a))throw"float\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return parseFloat(a)},LAYER:function(a){if("base"==a)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};try{return this.MESSAGE_LAYER(a)}catch(b){}try{return this.IMAGE_LAYER(a)}catch(c){}throw"\u6307\u5b9a\u3055\u308c\u305f\u30ec\u30a4\u30e4\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093";},IMAGE_LAYER:function(a){if("base"==a)return{fore:o2.foreLayers.baseLayer,back:o2.backLayers.baseLayer};a=Number(a);if(isNaN(a))throw"number\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";
if(!(a in o2.foreLayers.imageLayers))throw"\u30a4\u30e1\u30fc\u30b8\u30ec\u30a4\u30e4 "+a+" \u306f\u5b58\u5728\u3057\u307e\u305b\u3093";return{fore:o2.foreLayers.imageLayers[a],back:o2.backLayers.imageLayers[a]}},MESSAGE_LAYER:function(a){if(a.toString().match(/^message$/i))return o2.currentMessageLayer;if(a.toString().match(/^message(\d+)$/i)){var b=Number(a.toString().match(/^message(\d+)$/i)[1]);if(o2.foreLayers.messageLayers[b])return{fore:o2.foreLayers.messageLayers[b],back:o2.backLayers.messageLayers[b]}}throw"\u30e1\u30c3\u30bb\u30fc\u30b8\u30ec\u30a4\u30e4 "+
a+" \u306f\u5b58\u5728\u3057\u307e\u305b\u3093";},COLOR:function(a){a=/0x([0-9a-fA-F]{6})/.exec(a);if(null==a)throw"color\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return"#"+a[1]},TIME:function(a){if("-1"==a.indexOf(":")){a=parseFloat(a);if(isNaN(a))throw"time\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return a}var b=a.split(":"),c=0,d=0,e=0,g=0;if(4==b.length)c=parseFloat(b[0]),d=parseFloat(b[1]),e=parseFloat(b[2]),g=b[3];else if(3==b.length)d=parseFloat(b[0]),e=parseFloat(b[1]),g=parseFloat(b[2]);
else if(2==b.length)d=parseFloat(b[0]),e=parseFloat(b[1]);else if(1==b.length)g=parseFloat(a)/10;else throw"time\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";if(isNaN(c)||isNaN(d)||isNaN(e)||isNaN(g))throw"time\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return 36E5*c+6E4*d+1E3*e+10*g},OBJECT:function(a){if(null==a||"object"!==typeof a)throw"object\u578b\u3067\u306f\u3042\u308a\u307e\u305b\u3093";return a},FUNCTION:function(a){if("function"!=typeof a)throw"function\u3067\u306f\u3042\u308a\u307e\u305b\u3093";
return a}};Tag.actions={};Tag.prototype.done=function(a){a?this.conductor.wait(this,a):this.conductor&&this.conductor.trigger(this)};
Tag.prototype.error=function(a,b){var c="\u30a8\u30e9\u30fc: ";b&&(c="\u8b66\u544a: ");this.file&&(c+="\u30d5\u30a1\u30a4\u30eb: "+this.file.filename+" / ");void 0!==this.originalLineNumber?c+="\u884c: "+this.originalLineNumber+" / ":void 0!==this.lineNumber&&(c+="\u884c: "+this.lineNumber+" / ");c+="\u30bf\u30b0: "+this.tagName+" ";c+=a;if(b)o2.warn(c,this);else throw o2.error(c,this),"";};Tag.prototype.warn=function(a){this.error(a,!0)};Tag.prototype.clone=function(){return this};
Tag.prototype.toJSON=function(){return config.saveMode==o2.SAVE_MODE_KAG3?{file:this.file.filename,label:this.args.name,initializer:"Tag"}:this.toRestorable()};Tag.prototype.toRestorable=function(){var a={initializer:"Tag"};this.file&&(a.file=this.file.filename);void 0!==this.lineNumber&&(a.line=this.lineNumber);a.file||(a.tagName=this.tagName,a.args=this.args);void 0!==this.originalLineNumber&&(a.originalLineNumber=this.originalLineNumber);return a};
Tag.restore=function(a){if("file"in a&&"line"in a)return $.when(KAGFiles(a.file)).then(function(b){return b.lines[a.line]});if("file"in a&&"label"in a)return $.when(KAGFiles(a.file)).then(function(b){return b.getLabelTag(a.label)});if("tagName"in a)return new Tag(a.tagName,a.args);o2.error("\u30bf\u30b0\u3092\u5fa9\u5143\u3067\u304d\u306a\u3044",a);return{}};TagAction=function(a){this.action=function(){};for(var b in a)this[b]=a[b]};
Tag.actions.s=new TagAction({action:function(){if(this.conductor==conductor||this.conductor==extraConductor)o2.skipMode=o2.SKIP_MODE_NONE;if(config.autoRecordPageShowing&&currentConductor.currentRecordName){var a=sf[currentConductor.currentRecordName];void 0===a&&(a=0);a++;sf[currentConductor.currentRecordName]=a;delete currentConductor.currentRecordName}o2.reloadDelaySpeed();return 2}});
(function(){var a=["text","ch","hch","emb","ruby"];a.concat(["style","resetstyle"]);Tag.actions.text=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(b){function c(){o2.skipMode=o2.SKIP_MODE_CLICK;$(o2).off("click",c)}var d=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);b.text.split("").forEach(function(a){a=new TextProperties(a);$.extend(a.styles,clone(o2.currentMessageLayer.font));o2.currentMessageLayer.currentRubyText&&
(a.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText);o2.currentMessageLayer.stackedTextsProperties.push(a)});if(d&&-1!=a.indexOf(d.tagName))return 0;b=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(a){return a.text}).join(""));o2.historyLayer.recorder.add(b);var b=clone(o2.currentMessageLayer.stackedTextsProperties),e=this;o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){$(o2).off("click",
c);e.done()});o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().drawText(b);delete o2.currentMessageLayer.stackedTextsProperties;if(o2.clickSkipEnabled)$(o2).on("click",c);return 1}});Tag.actions.ch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(b){var c=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||(o2.currentMessageLayer.stackedTextsProperties=[]);b=new TextProperties(b.text);$.extend(b.styles,clone(o2.currentMessageLayer.font));
o2.currentMessageLayer.currentRubyText&&(b.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText);o2.currentMessageLayer.stackedTextsProperties.push(b);if(c&&-1!=a.indexOf(c.tagName))return 0;c=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(a){return a.text}).join(""));o2.historyLayer.recorder.add(c);var d=this;o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){d.done()});o2.currentMessageLayerWithBack&&
o2.currentMessageLayer.getCorrespondingLayer().drawText(clone(o2.currentMessageLayer.stackedTextsProperties));delete o2.currentMessageLayer.stackedTextsProperties;return 1}});Tag.actions.hch=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(b){o2.currentMessageLayer.vertical||this.warn("hch\u30bf\u30b0\u306f\u7e26\u66f8\u304d\u306e\u72b6\u614b\u3067\u3057\u304b\u5b9f\u884c\u3067\u304d\u307e\u305b\u3093");var c=this.conductor.getNextTag();o2.currentMessageLayer.stackedTextsProperties||
(o2.currentMessageLayer.stackedTextsProperties=[]);b=new TextProperties(b.text);$.extend(b.styles,clone(o2.currentMessageLayer.font));b.styles.vertical=!1;o2.currentMessageLayer.currentRubyText&&(b.rubyText=o2.currentMessageLayer.currentRubyText,delete o2.currentMessageLayer.currentRubyText);o2.currentMessageLayer.stackedTextsProperties.push(b);if(c&&-1!=a.indexOf(c.tagName))return 0;c=new HistoryRecord.String(o2.currentMessageLayer.stackedTextsProperties.map(function(a){return a.text}).join(""));
o2.historyLayer.recorder.add(c);var d=this;o2.currentMessageLayer.drawText(o2.currentMessageLayer.stackedTextsProperties,function(){d.done()});o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().drawText(clone(o2.currentMessageLayer.stackedTextsProperties));delete o2.currentMessageLayer.stackedTextsProperties;return 1}});Tag.actions.emb=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){a=eval(a.o2_exp);a=new Tag("text",{text:a});this.conductor.queue.push(a);
return 0}})})();Tag.actions.ruby=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(a){o2.currentMessageLayer.currentRubyText=a.text;o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().currentRubyText=a.text);return 0}});
Tag.actions.cm=new TagAction({action:function(){for(var a=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),b=a.length-1;0<=b;b--)a[b].resetMessageLayer();o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage();return 0}});Tag.actions.ct=new TagAction({action:function(){(new Tag("cm")).run();o2.currentMessageLayer=o2.foreLayers.messageLayers[0];o2.currentMessageLayerWithBack=!1;o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage();return 0}});
Tag.actions.er=new TagAction({action:function(){o2.currentMessageLayer.resetMessageLayer();o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().resetMessageLayer();o2.historyLayer.recorder.options.repage&&o2.historyLayer.recorder.addPage();return 0}});
Tag.actions.current=new TagAction({rules:{layer:{type:"MESSAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},withback:{type:"BOOLEAN"}},action:function(a){o2.currentMessageLayer=a.layer[a.page];"withback"in a&&(o2.currentMessageLayerWithBack=a.withback);return 0}});
Tag.actions.position=new TagAction({rules:{layer:{type:"MESSAGE_LAYER"},page:{type:/fore|back/},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},frame:{type:"STRING"},color:{type:"COLOR"},opacity:{type:"FLOAT"},marginl:{type:"INT"},margint:{type:"INT"},marginr:{type:"INT"},marginb:{type:"INT"},vertical:{type:"BOOLEAN"},visible:{type:"BOOLEAN"}},action:function(a){var b;b=a.layer&&a.page?a.layer[a.page]:o2.currentMessageLayer;var c=!1,d=clone(b.rect);"left"in a&&(d.x=a.left);
"top"in a&&(d.y=a.top);"width"in a&&(d.width=a.width);"height"in a&&(d.height=a.height);b.setRect(d);if("frame"in a)if(""===a.frame)b.setFrameImage();else{var e=this;ResourceLoader.loadImage(a.frame,!0).done(function(a){a=new DrawableImage(a);b.setFrameImage(a)}).always(function(){setTimeout(function(){renderer.animator.requestFrame();"visible"in a&&b.visible!=a.visible&&(b.visible=a.visible);e.done()})});c=!0}"color"in a&&(b.frameSolid.color=a.color);"opacity"in a&&(b.frameSolid.opacity=a.opacity/
255);"marginl"in a&&(b.margin.left=a.marginl);"margint"in a&&(b.margin.top=a.margint);"marginr"in a&&(b.margin.right=a.marginr);"marginb"in a&&(b.margin.bottom=a.marginb);"vertical"in a&&(b.vertical=a.vertical);b.resetMessageLayer();if(c)return 1;"visible"in a&&b.visible!=a.visible&&(b.visible=a.visible);renderer.animator.requestFrame();return 0}});
Tag.actions.delay=new TagAction({rules:{speed:{type:"INT",required:!0,allowString:["user","nowait"]}},action:function(a){"nowait"===a.speed?(sf.__system.chSpeed=0,sf.__system.useUserChSpeed=!1):"user"===a.speed?sf.__system.useUserChSpeed=!0:(sf.__system.chSpeed=parseFloat(a.speed),sf.__system.useUserChSpeed=!1);o2.reloadDelaySpeed()}});
Tag.actions.wc=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){var b=this;setTimeout(function(){b.done()},a.time*o2.currentMessageLayer.delaySpeed);return 1}});(function(){var a=void 0;Tag.actions.nowait=new TagAction({action:function(){a=o2.currentMessageLayer.delaySpeed;return o2.currentMessageLayer.delaySpeed=0}});Tag.actions.endnowait=new TagAction({action:function(){o2.currentMessageLayer.delaySpeed=a;return 0}})})();
Tag.actions.deffont=new TagAction({rules:{size:{type:"INT"},face:{type:"STRING"},color:{type:"COLOR"},rubysize:{type:"INT"},rubyoffset:{type:"INT"},edge:{type:"BOOLEAN"},edgecolor:{type:"COLOR"},bold:{type:"BOOLEAN"},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(a){var b=o2.currentMessageLayer,c={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",
o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"},d;for(d in a){var e=c[d]||d;b.defaultFont[e]=a[d];o2.currentMessageLayerWithBack&&(b.getCorrespondingLayer().defaultFont[e]=a[d])}if(a.face){var g=this;ResourceLoader.loadFont(a.face,!0).always(function(){setTimeout(function(){g.done()})});return 1}return 0}});
Tag.actions.font=new TagAction({rules:{size:{type:"INT",allowString:["default"]},face:{type:"STRING"},color:{type:"COLOR",allowString:["default"]},italic:{type:"BOOLEAN",allowString:["default"]},rubysize:{type:"INT",allowString:["default"]},rubyoffset:{type:"INT",allowString:["default"]},edge:{type:"BOOLEAN",allowString:["default"]},edgecolor:{type:"COLOR",allowString:["default"]},bold:{type:"BOOLEAN",allowString:["default"]},o2_shadow:{type:"BOOLEAN"},o2_shadowcolor:{type:"COLOR"},o2_shadowblur:{type:"INT"},
o2_shadowoffsetx:{type:"INT"},o2_shadowoffsety:{type:"INT"}},action:function(a){var b={rubysize:"rubySize",rubyoffset:"rubyOffset",edgecolor:"edgeColor",shadowcolor:"shadowColor",o2_shadow:"shadow",o2_shadowcolor:"shadowColor",o2_shadowblur:"shadowBlur",o2_shadowoffsetx:"shadowOffsetX",o2_shadowoffsety:"shadowOffsetY"},c;for(c in a){var d=b[c]||c;"default"===a[c]&&(a[c]=o2.currentMessageLayer.deffont[d]);o2.currentMessageLayer.font[d]=a[c];o2.currentMessageLayerWithBack&&(o2.currentMessageLayer.getCorrespondingLayer().font[d]=
a[c])}if(a.face){var e=this;ResourceLoader.loadFont(a.face,!0).always(function(){setTimeout(function(){e.done()})});return 1}return 0}});Tag.actions.resetfont=new TagAction({action:function(){o2.currentMessageLayer.font=clone(o2.currentMessageLayer.defaultFont);if(o2.currentMessageLayerWithBack){var a=o2.currentMessageLayer.getCorrespondingLayer();a.font=clone(a.defaultFont)}}});
Tag.actions.defstyle=new TagAction({rules:{linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT"},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"}},action:function(a){var b={linespacing:"lineSpacing",linesize:"lineSize",o2_kinsoku:"kinsoku",o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar",toback:{type:"BOOLEAN"}};
if(o2.currentMessageLayerWithBack&&!a.toback){var c=clone(a);c.toback=!0;c=new Tag("defstyle",c);this.conductor.queue.push(c)}c=o2.currentMessageLayer;a.toback&&(c=c.getCorrespondingLayer());for(var d in a)c.defaultStyle[b[d]||d]=a[d];if("o2_kinsoku"in a)switch(a.o2_kinsoku){case "none":c.defaultStyle.kinsoku=MessageLayer.KINSOKU_NONE;break;case "oidashi":c.defaultStyle.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case "burasagari-oidashi":c.defaultStyle.kinsoku=MessageLayer.KINSOKU_BURASAGARI}return 0}});
Tag.actions.style=new TagAction({rules:{align:{type:/left|center|right|top|center|bottom|default/},linespacing:{type:"INT"},pitch:{type:"INT"},linesize:{type:"INT",allowString:["default"]},autoreturn:{type:"BOOLEAN",allowString:["default"]},o2_kinsoku:{type:/none|oidashi|burasagari-oidashi/},o2_kinsoku_bol_char:{type:"STRING"},o2_kinsoku_eol_char:{type:"STRING"},o2_kinsoku_burasagari_char:{type:"STRING"},toback:{type:"BOOLEAN"}},action:function(a){if(o2.currentMessageLayerWithBack&&!a.toback){var b=
clone(a);b.toback=!0;b=new Tag("style",b);this.conductor.queue.push(b)}b=o2.currentMessageLayer;a.toback&&(b=b.getCorrespondingLayer());"align"in a&&(b.style.align="default"==a.align?b.vertical?"top":"left":a.align);"linespacing"in a&&(b.vertical?b.textCursor.x-=a.linespacing-b.style.lineSpacing:b.textCursor.y+=a.linespacing-b.style.lineSpacing,b.style.lineSpacing=a.linespacing);"pitch"in a&&(b.style.pitch=a.pitch);"linesize"in a&&(b.style.lineSize="default"==a.linesize?-1:a.linesize);"autoreturn"in
a&&("default"==a.autoreturn&&(a.autoreturn=b.defaultStyle.autoReturn),b.style.autoReturn=a.autoreturn);var c={o2_kinsoku_bol_char:"kinsokuBolChar",o2_kinsoku_eol_char:"kinsokuEolChar",o2_kinsoku_burasagari_char:"kinsokuBurasagariChar"},d;for(d in a)d in c&&(b.style[c[d]]=a[d]);if("o2_kinsoku"in a)switch(a.o2_kinsoku){case "none":b.style.kinsoku=MessageLayer.KINSOKU_NONE;break;case "oidashi":b.style.kinsoku=MessageLayer.KINSOKU_OIDASHI;break;case "burasagari-oidashi":b.style.kinsoku=MessageLayer.KINSOKU_BURASAGARI}}});
Tag.actions.resetstyle=new TagAction({rules:{toback:{type:"BOOLEAN"}},action:function(a){if(o2.currentMessageLayerWithBack&&!a.toback){var b=clone(a);b.toback=!0;b=new Tag("resetstyle",b);this.conductor.queue.push(b)}b=o2.currentMessageLayer;a.toback&&(b=b.getCorrespondingLayer());b.vertical?b.textCursor.x-=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing:b.textCursor.y+=o2.currentMessageLayer.defaultStyle.lineSpacing-o2.currentMessageLayer.style.lineSpacing;
b.style=clone(b.defaultStyle)}});
Tag.actions.locate=new TagAction({rules:{x:{type:"INT"},y:{type:"INT"},toback:{type:"BOOLEAN"}},action:function(a){if(o2.currentMessageLayerWithBack&&!a.toback){var b=clone(a);b.toback=!0;b=new Tag("locate",b);this.conductor.queue.push(b)}b=o2.currentMessageLayer;a.toback&&(b=b.getCorrespondingLayer());"x"in a&&(b.textCursor.x=a.x+b.margin.left,b.vertical&&(b.textCursor.x-=b.style.lineSpacing));"y"in a&&(b.textCursor.y=a.y+b.margin.top,b.vertical||(b.textCursor.y+=b.style.lineSpacing));return 0}});
Tag.actions.r=new TagAction({action:function(){o2.currentMessageLayer.linebreak();o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().linebreak();o2.historyLayer.recorder.addCell(!0);return 0}});
(function(){var a=void 0;Tag.actions.indent=new TagAction({action:function(){var b=o2.currentMessageLayer;b.margin.vertical?(a=b.margin.top,b.margin.top=b.textCursor.y):(a=b.margin.left,b.margin.left=b.textCursor.x);return 0}});Tag.actions.endindent=new TagAction({action:function(){var b=o2.currentMessageLayer,c=b.margin.vertical;void 0===a&&o2.error("indent\u30bf\u30b0\u3092\u5148\u306b\u5b9f\u884c\u3057\u3066\u304f\u3060\u3055\u3044");c?b.margin.top=a:b.margin.left=a;return 0}})})();
Tag.actions.p=new TagAction({action:function(){o2.historyLayer.recorder.addCell(!0);if(o2.autoMode){var a=this;setTimeout(function(){a.done()},sf.__system.autoModePageWait);return 1}o2.skipMode<=o2.SKIP_MODE_PAGE&&(o2.skipMode=o2.SKIP_MODE_NONE);if(o2.skipMode)return 0;o2.showGlyph("page");wait("click",function(){o2.hideGlyph()});return 1}});
Tag.actions.l=new TagAction({action:function(){var a=this.conductor.isCurrentRead();if(config.chNonStopToPageBreak||config.ch2ndNonStopToPageBreak&&a)return 0;if(o2.autoMode){var b=this;setTimeout(function(){b.done()},sf.__system.autoModeLineWait);return 1}o2.skipMode<=o2.SKIP_MODE_CLICK&&(o2.skipMode=o2.SKIP_MODE_NONE);if(o2.skipMode)return 0;o2.showGlyph("line");wait("click",function(){o2.hideGlyph()});return 1}});
Tag.actions.button=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"}},action:function(a){var b=this;ResourceLoader.loadImage(a.graphic).done(function(c){setTimeout(function(){var d=o2.currentMessageLayer.textCursor,d=new KAGButton(c,d.x,d.y);d.importFromKAGArgs(a);
o2.currentMessageLayer.addButton(d);o2.currentMessageLayerWithBack&&o2.currentMessageLayer.getCorrespondingLayer().addButton(clone(d));b.done()})});return 1}});var KAGButton=function(a,b,c){Button.call(this,a,b,c);this.rect.width=Math.floor(this.rect.width/3);this.options.clipLeft=0;this.options.clipWidth=this.rect.width;this.tagArgs};KAGButton.prototype=Object.create(Button.prototype);KAGButton.prototype.initializer="KAGButton";
KAGButton.prototype.clone=function(){var a=new KAGButton(this.image);a.importFrom(this);return a};KAGButton.prototype.drawOnContext=function(a,b){switch(this.state){case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;default:this.options.clipLeft=0}Button.prototype.drawOnContext.apply(this,arguments)};
KAGButton.prototype.importFromKAGArgs=function(a){a&&(this.tagArgs=clone(a),this.click=function(b,c,d){Button.prototype.click.apply(this,arguments);a.o2_exp&&eval(a.o2_exp);a.o2_url&&window.open(a.o2_url,a.o2_urltarget);if(a.storage||a.target){var e=new Tag("jump",{storage:a.storage,target:a.target});currentConductor.queue.push(e)}d.addButtonLinkImages();d.buttons=[];d.links=[]},a.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,arguments);eval(a.o2_onenter)}),a.o2_onleave&&(this.leave=
function(){Button.prototype.leave.apply(this,arguments);eval(a.o2_onleave)}))};KAGButton.prototype.importFrom=function(a){Button.prototype.importFrom.call(this,a);this.importFromKAGArgs(a.tagArgs)};KAGButton.prototype.toJSON=function(){var a=Button.prototype.toJSON.call(this);a.tagArgs=this.tagArgs;return a};KAGButton.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(b){b=new KAGButton(b);b.importFrom(a);return b})};
(function(){KAGLink=function(){Link.call(this);this.tagArgs};KAGLink.prototype=Object.create(Link.prototype);KAGLink.prototype.initializer="KAGLink";KAGLink.restore=function(a){var b=new KAGLink;b.importFromKAGArgs(a.tagArgs);delete a.tagArgs;Link.prototype.importFromSaveData(a);return b};KAGLink.prototype.importFrom=function(a){Link.prototype.importFrom.call(this,a);this.importFromKAGArgs(a.tagArgs)};KAGLink.prototype.importFromKAGArgs=function(a){this.tagArgs=a;this.click=function(b,e,g){Link.prototype.click.apply(this,
arguments);"o2_exp"in a&&eval(a.o2_exp);"o2_url"in a&&window.open(a.o2_url,a.o2_urltarget);if(a.target||a.storage){var i=new Tag("jump",{target:this.tagArgs.target,storage:this.tagArgs.storage});currentConductor.queue.push(i)}g.addButtonLinkImages();g.buttons=[];g.links=[]};"o2_onenter"in a&&(this.enter=function(){Link.prototype.enter.apply(this,arguments);eval(a.o2_onenter)});"o2_onleave"in a&&(this.leave=function(){Link.prototype.leave.apply(this,arguments);eval(a.o2_onleave)})};var a=0,b={};Tag.actions.link=
new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},color:{type:"COLOR"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},o2_exp:{type:"STRING"}},action:function(c){a=o2.currentMessageLayer.textsProperties.length;b=c;return 0}});Tag.actions.endlink=new TagAction({action:function(){var c=new KAGLink;c.importFromKAGArgs(b);c.vertical=o2.currentMessageLayer.vertical;for(var d=a;d<o2.currentMessageLayer.textsProperties.length;d++)c.addTextProperties(o2.currentMessageLayer.textsProperties[d]);
o2.currentMessageLayer.addLink(c);if(o2.currentMessageLayerWithBack){var e=o2.currentMessageLayer.getCorrespondingLayer(),c=new KAGLink;c.importFromKAGArgs(b);c.vertical=e.vertical;for(d=a;d<e.textsProperties.length;d++)c.addTextProperties(e.textsProperties[d]);e.addLink(c)}return 0}})})();
Tag.actions.image=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},grayscale:{type:"BOOLEAN"},rgamma:{type:"FLOAT"},ggamma:{type:"FLOAT"},bgamma:{type:"FLOAT"},rfloor:{type:"INT"},gfloor:{type:"INT"},bfloor:{type:"INT"},rceil:{type:"INT"},gceil:{type:"INT"},bceil:{type:"INT"},mcolor:{type:"COLOR"},mopacity:{type:"INT"},shadow:{type:"COLOR"},shadowopacity:{type:"INT",defaultValue:200},shadowx:{type:"INT",defaultValue:10},
shadowy:{type:"INT",defaultValue:10},shadowblur:{type:"FLOAT",defaultValue:3},clipleft:{type:"INT"},cliptop:{type:"INT"},clipwidth:{type:"INT"},clipheight:{type:"INT"},flipud:{type:"BOOLEAN"},fliplr:{type:"BOOLEAN"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},pos:{type:/left|left_center|center|right_center|right|l|lc|c|rc|r/},opacity:{type:"INT"},allowfail:{type:"BOOLEAN",defaultValue:!1},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},
o2_blur:{type:"INT"},o2_blurx:{type:"INT"},o2_blury:{type:"INT"},o2_blurmode:{type:/linear|constantalpha/}},preload:function(a){ResourceLoader.loadImage(a.storage,!1)},action:function(a){var b=this,c=a.layer[a.page],d={grayscale:!1,rGamma:1,gGamma:1,bGamma:1,rFloor:0,gFloor:0,bFloor:0,rCeil:255,gCeil:255,bCeil:255,tintColor:"#ff0000",tintOpacity:0,shadow:"#000000",shadowOpacity:200,shadowX:10,shadowY:10,shadowBlur:3,clipLeft:void 0,clipTop:void 0,clipWidth:void 0,clipHeight:void 0,flipUD:!1,flipLR:!1,
visible:!0,opacity:255,blurX:0,blurY:0,blurMode:"linear"},e={rgamma:"rGamma",ggamma:"gGamma",bgamma:"bGamma",rfloor:"rFloor",gfloor:"gFloor",bfloor:"bFloor",rceil:"rCeil",gceil:"gCeil",bceil:"bCeil",mcolor:"tintColor",mopacity:"tintOpacity",shadowopacity:"shadowOpacity",shadowx:"shadowX",shadowy:"shadowY",shadowblur:"shadowBlur",clipleft:"clipLeft",cliptop:"clipTop",clipwidth:"clipWidth",clipheight:"clipHeight",flipud:"flipUD",fliplr:"flipLR",o2_blurx:"blurX",o2_blury:"blurY",o2_blurmode:"blurMode"},
g;for(g in a)-1=="storage layer page allowfail left top pos o2_zoom o2_rotate o2_orx o2_ory".split(" ").indexOf(g)&&(d[e[g]||g]=a[g]);"opacity"in d&&(c.opacity=d.opacity/255,d.opacity=1);"visible"in d&&(c.visible=d.visible,d.visible=!0);"shadowOpacity"in d&&(d.shadowOpacity/=255);"tintOpacity"in d&&(d.tintOpacity/=255);"o2_blur"in a&&("o2_blurx"in a||(d.blurX=a.o2_blur),"o2_blury"in a||(d.blurY=a.o2_blur));c.loadImage(a.storage,d,a.allowfail).fail(function(){this.error("\u30a4\u30e1\u30fc\u30b8\u30d5\u30a1\u30a4\u30eb "+
a.storage+" \u3092\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093")}).always(function(d){if("pos"in a){switch(a.pos){case "left":case "l":c.rect.x=config.scPositionX_left-d.rect.width/2;break;case "left_center":case "lc":c.rect.x=config.scPositionX_left_center-d.rect.width/2;break;case "center":case "c":c.rect.x=config.scPositionX_center-d.rect.width/2;break;case "right_center":case "rc":c.rect.x=config.scPositionX_right_center-d.rect.width/2;break;case "right":case "r":c.rect.x=config.scPositionX_right-
d.rect.width/2}c.rect.y=config.scHeight-d.rect.height}else"left"in a&&(c.rect.x=a.left),"top"in a&&(c.rect.y=a.top);c.rect.width=Math.max(config.scWidth,d.rect.width);c.rect.height=Math.max(config.scHeight,d.rect.height);c.setRect();if("o2_zoom"in a){var e=1,g=1,g=a.o2_zoom.split(":");2<=g.length?(e=parseFloat(g[0]),g=parseFloat(g[1])):e=g=parseFloat(g[0]);if(isNaN(e)||isNaN(g))return this.error("o2_zoom\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002"),0;c.scaleX=e/100;c.scaleY=g/100}"o2_rotate"in
a&&(c.rotation=a.o2_rotate/180*Math.PI);c.transformOrigin.x="o2_orx"in a?a.o2_orx:d.rect.width/2;c.transformOrigin.y="o2_ory"in a?a.o2_ory:d.rect.height/2;setTimeout(b.done.bind(b))});return 1}});
Tag.actions.pimage=new TagAction({rules:{storage:{type:"STRING",required:!0},layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},allowfail:{type:"BOOLEAN",defaultValue:!1},dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",defaultValue:0},sy:{type:"INT",defaultValue:0},sw:{type:"INT"},sh:{type:"INT"},opacity:{type:"INT"},o2_grayscale:{type:"BOOLEAN",defaultValue:!1},o2_rgamma:{type:"FLOAT"},o2_ggamma:{type:"FLOAT"},o2_bgamma:{type:"FLOAT"},o2_rfloor:{type:"INT"},
o2_gfloor:{type:"INT"},o2_bfloor:{type:"INT"},o2_rceil:{type:"INT"},o2_gceil:{type:"INT"},o2_bceil:{type:"INT"},o2_mcolor:{type:"COLOR"},o2_mopacity:{type:"INT"}},action:function(a){var b=this;ResourceLoader.loadImage(a.storage,!a.allowfail).done(function(c){var d=a.layer[a.page],c=new DrawableImage(c,a.dx,a.dy),e={sx:"clipLeft",sy:"clipTop",sw:"clipWidth",sh:"clipHeight",opacity:"opacity",o2_grayscale:"grayscale",o2_rgamma:"rGamma",o2_ggamma:"gGamma",o2_bgamma:"bGamma",o2_rfloor:"rFloor",o2_gfloor:"gFloor",
o2_bfloor:"bFloor",o2_rceil:"rCeil",o2_gceil:"gCeil",o2_bceil:"bCeil",o2_mcolor:"tintColor",o2_mopacity:"tintOpacity"},g;for(g in e)g in a&&(c.options[e[g]]=a[g]);"opacity"in c.options&&(c.options.opacity/=255);"tintOpacity"in c.options&&(c.options.tintOpacity/=255);d.addImage(c);setTimeout(b.done.bind(b))});return 1}});
Tag.actions.freeimage=new TagAction({rules:{layer:{type:"IMAGE_LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"}},action:function(a){a.layer[a.page].clearImage();a.layer[a.page].clearAnimationConductors();return 0}});
Tag.actions.backlay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(a){var b=this;renderer.animator.requestFrame(function(){if(a.layer)a.layer.back.importFrom(a.layer.fore);else for(var c=o2.allForeLayers(),d=o2.allBackLayers(),e=0;e<c.length;e++)d[e].importFrom(c[e]);b.done()});return 1}});
Tag.actions.copylay=new TagAction({rules:{srclayer:{type:"LAYER",required:!0},destlayer:{type:"LAYER",required:!0},srcpage:{type:/fore|back/,defaultValue:"fore"},destpage:{type:/fore|back/,defaultValue:"fore"}},action:function(a){var b=a.srclayer[a.srcpage],a=a.destlayer[a.destpage];if(b.initializer!=a.initializer)throw"srclayer\u3068destlayer\u306b\u7570\u306a\u308b\u7a2e\u985e\u306e\u30ec\u30a4\u30e4\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093";a.importFrom(b);
return 0}});Tag.actions.o2_forelay=new TagAction({rules:{layer:{type:"LAYER"}},action:function(a){var b=this;renderer.animator.requestFrame(function(){if(a.layer)a.layer.fore.importFrom(a.layer.back);else for(var c=o2.allForeLayers(),d=o2.allBackLayers(),e=0;e<c.length;e++)c[e].importFrom(d[e]);b.done()});return 1}});
Tag.actions.layopt=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},opacity:{type:"INT"},autohide:{type:"BOOLEAN"},index:{type:"INT"},o2_zoom:{type:/[0-9]+(:[0-9]+)?/},o2_rotate:{type:"FLOAT"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"},o2_frameopacity:{type:"FLOAT"},o2_userinteraction:{type:"BOOLEAN"}},action:function(a){var b=a.layer[a.page];"visible"in a&&(b.visible=a.visible);"left"in
a&&(b.rect.x=a.left);"top"in a&&(b.rect.y=a.top);"opacity"in a&&(b.opacity=a.opacity/255);if("autohide"in a)if(a.autohide)-1==o2.extraAutoHideLayers.indexOf(b)&&o2.extraAutoHideLayers.push(b);else{var c=o2.extraAutoHideLayers.indexOf(b);-1!=c&&o2.extraAutoHideLayers.splice(c,1)}"index"in a&&(b.index=a.index,o2.refreshRendererLayers());if("o2_zoom"in a){var d=c=1,d=a.o2_zoom.split(":");2<=d.length?(c=parseFloat(d[0]),d=parseFloat(d[1])):c=d=parseFloat(d[0]);if(isNaN(c)||isNaN(d))return this.error("o2_zoom\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093\u3002"),
0;b.scaleX=c/100;b.scaleY=d/100}"o2_rotate"in a&&(b.rotation=a.o2_rotate/180*Math.PI);"o2_orx"in a&&(b.transformOrigin.x=a.o2_orx);"o2_ory"in a&&(b.transformOrigin.y=a.o2_ory);"o2_frameopacity"in a&&(b instanceof MessageLayer?b.frameImage?(b.frameImage.options.opacity=a.o2_frameopacity,b.redrawRect(b.frameImage.rect)):(b.frameSolid.opacity=a.o2_frameopacity,b.redrawRect(b.frameSolid.rect)):this.error("\u30e1\u30c3\u30bb\u30fc\u30b8\u30ec\u30a4\u30e4\u30fc\u4ee5\u5916\u306e\u30ec\u30a4\u30e4\u30fc\u306bo2_frameopacity\u3092\u6307\u5b9a\u3067\u304d\u306a\u3044\u3067\u3059"));
"o2_userinteraction"in a&&(b.userInteractionEnabled=a.o2_userinteraction);renderer.animator.requestFrame();return 0}});
Tag.actions.laycount=new TagAction({rules:{layers:{type:"INT"},messages:{type:"INT"}},action:function(a){if("layers"in a)if(a.layers>o2.foreLayers.imageLayers.length)for(var b=o2.foreLayers.imageLayers.length;b<a.layers;b++)o2.foreLayers.imageLayers.push(new ImageLayer),o2.backLayers.imageLayers.push(new ImageLayer);else a.layers<o2.foreLayers.imageLayers.length&&(o2.foreLayers.imageLayers=o2.foreLayers.imageLayers.splice(0,a.layers),o2.backLayers.imageLayers=o2.backLayers.imageLayers.splice(0,a.layers));
if("messages"in a)if(a.messages>o2.foreLayers.messageLayers.length)for(b=o2.foreLayers.messageLayers.length;b<a.messages;b++)o2.foreLayers.messageLayers.push(new MessageLayer),o2.backLayers.messageLayers.push(new MessageLayer);else a.messages<o2.foreLayers.messageLayers.length&&(o2.foreLayers.messageLayers=o2.foreLayers.messageLayers.splice(0,a.messages),o2.backLayers.messageLayers=o2.backLayers.messageLayers.splice(0,a.messages));o2.resetLayersIndex();o2.refreshRendererLayers();renderer.animator.requestFrame();
return 0}});
Tag.actions.trans=new TagAction({rules:{time:{type:"INT",required:!0},layer:{type:"LAYER",defaultValue:"base"},children:{type:"BOOLEAN",defaultValue:!0},method:{type:"STRING",defaultValue:"crossfade"}},action:function(a){function b(){if(!this.end)if(e)$.when(Tag.actions.trans.stopAllTransitions()).done(function(){Tag.actions.trans.runningTag=d;var b=$("#main-wrapper");d.container=$("<div />");d.container.css({position:"absolute",width:b.width()+"px",height:b.height()+"px"});b.append(d.container);d.container.append([renderer.foreCanvas,
renderer.backCanvas]);d.method.transitAllLayers.call(d,a,renderer.backCanvas,renderer.foreCanvas,d.container);renderer.animator.requestFrame(function(){d.end||c()},a.time)});else{a.layer.fore.transit(this);var b=Date.now(),i=function(){d.end||(Date.now()-b<a.time?renderer.animator.requestFrame(i):c())};i()}}function c(){d.end||(d.end=!0,e?$.when(Tag.actions.trans.stopAllTransitions()).done(function(){d.done()}):(a.layer.fore.stopTransition(),d.done()))}this.end=!1;this.transArgs=a;(this.method=Tag.actions.trans.methods[a.method])||
this.error(a.method+" \u3068\u3044\u3046\u30e1\u30bd\u30c3\u30c9\u306f\u5b58\u5728\u3057\u307e\u305b\u3093");"canRun"in this.method&&!this.method.canRun()&&(this.method=Tag.actions.trans.methods.crossfade);var d=this,e=!1;a.layer.fore==o2.foreLayers.baseLayer&&a.children&&(e=!0);!this.method.transit&&!e&&this.error("\u30e1\u30bd\u30c3\u30c9 "+a.method+" \u3092\u5b9f\u884c\u3059\u308b\u306b\u306flayer\u5c5e\u6027\u306bbase\u3001children\u5c5e\u6027\u306btrue\u3092\u6307\u5b9a\u3059\u308b\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059");
renderer.renderBackCanvas=!0;"function"===typeof this.method.preload?this.method.preload.call(this,a).done(function(){renderer.animator.requestFrame(function(){b.call(d);d.done()})}):renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){b.call(d);d.done()})});return 1},stopAllTransitions:function(){for(var a=o2.allForeLayers(),b=o2.allBackLayers(),c=0;c<a.length;c++)a[c].stopTransition();if(Tag.actions.trans.runningTag){var d=$.Deferred();renderer.renderBackCanvas=!1;
for(c=0;c<a.length;c++)a[c].importFrom(b[c]);o2.refreshRendererLayers();var e=Tag.actions.trans.runningTag;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){"function"==typeof e.method.teardownAllLayers&&e.method.teardownAllLayers.call(e,e.transArgs,renderer.backCanvas,renderer.foreCanvas,e.container);$(renderer.backCanvas).detach();e.container&&(e.container.remove(),delete e.container);$("#main-wrapper").append(renderer.foreCanvas);d.resolve()})});e.end=!0;Tag.actions.trans.runningTag=
void 0;$(o2).trigger("transEnd");return d.promise()}},methods:{}});
TransMethod=function(a){for(var b in a)this[b]=a[b];a.transitAllLayers||(this.transitAllLayers=function(b,d,e,g){function i(){k.end||(Date.now()-j<b.time&&renderer.animator.requestFrame(i),a.transit.call(k,b,e,d,k.transCanvas))}$(d).hide();$(e).hide();this.transCanvas=document.createElement("canvas");this.transCanvas.width=e.width;this.transCanvas.height=d.height;$(this.transCanvas).css({position:"absolute",x:0,y:0});$(g).append(this.transCanvas);a.prepare.call(this,b);var j=Date.now(),k=this;i()},
this.teardownAllLayers=function(b,d,e){"function"==typeof a.teardown&&a.teardown.call(this);$(d).show();$(e).show();$(this.transCanvas).remove();this.transCanvas=null})};Tag.actions.stoptrans=new TagAction({action:function(){var a=this;$.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){a.done()})});return 1}});
Tag.actions.wt=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(a){var b=o2.allForeLayers(),c=!0;if(Tag.actions.trans.runningTag)c=!1;else for(var d=b.length-1;0<=d;d--)if(b[d].isTransiting()){c=!1;break}if(c)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode){var e=this;$.when(Tag.actions.trans.stopAllTransitions()).done(function(){setTimeout(function(){e.done()})});return 1}wait("click",function(){Tag.actions.trans.stopAllTransitions()})}wait("trans");return 1}});
Tag.actions.trans.methods.crossfade=new TransMethod({prepare:function(){this.beginning=Date.now()},transit:function(a,b,c,d){var e=d.getContext("2d"),a=(Date.now()-this.beginning)/a.time;if(1<=a||this.end)a=1;e.save();e.clearRect(0,0,d.width,d.height);e.globalAlpha=1;e.drawImage(b,0,0);e.globalAlpha=a;e.drawImage(c,0,0);e.restore()},teardown:function(){delete this.beginning},transitAllLayers:function(a,b,c){var d=this,e=Date.now();c.style.zIndex=1;b.style.zIndex=2;if(supportCssProperty("animationName"))c=
"@-webkit-keyframes fade { \n0% { \n opacity: 0; \n} 100% { \n opacity: 1; \n}} \n",c+=c.replace(/-webkit-/g,"-moz-")+c.replace(/-webkit-/g,"-o-")+c.replace(/-webkit-/g,""),c=document.createTextNode(c),this.cssTag=document.createElement("style"),this.cssTag.type="text/css",this.cssTag.appendChild(c),document.getElementsByTagName("head")[0].appendChild(this.cssTag),$(b).css("opacity",0),renderer.animator.requestFrame(function(){$(b).css({"animation-duration":a.time+"ms","animation-timing-function":a.timing_function||
"linear","animation-name":"fade"})});else{var g=function(){var c=(Date.now()-e)/a.time;d.end||renderer.animator.requestFrame(g);b.style.opacity=c};renderer.animator.requestFrame(g)}},teardownAllLayers:function(a,b){this.end=!0;if(this.cssTag)try{document.getElementsByTagName("head")[0].removeChild(this.cssTag)}catch(c){}$(b).css({opacity:1,"animation-duration":"","animation-timing-function":"","animation-name":""})}});
$.extend(Tag.actions.trans.rules,{from:{type:/left|top|right|bottom/,defaultValue:"left"},stay:{type:/stayfore|stayback|nostay/,defaultValue:"nostay"},o2_timing_function:{type:"STRING",defaultValue:"linear"}});
Tag.actions.trans.methods.scroll=new TransMethod({prepare:function(a){this.beginning=Date.now();if(-1!=a.o2_timing_function.indexOf("cubic-bezier")){a=a.o2_timing_function.replace("cubic-bezier","");a=a.replace("(","");a=a.replace(")","");a=a.split(",").map(function(a){return parseFloat(a)});if(4!=a.length)throw"o2_timing_function\u5c5e\u6027\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093";this.timingFunction=new KeySpline(a[0],a[1],a[2],a[3])}else switch(a.o2_timing_function){case "ease":this.timingFunction=
new KeySpline(0.25,0.1,0.25,1);break;case "ease-in":this.timingFunction=new KeySpline(0.42,0,1,1);break;case "ease-out":this.timingFunction=new KeySpline(0,0,0.58,1);break;case "ease-in-out":this.timingFunction=new KeySpline(0.42,0,0.58,1);break;default:this.timingFunction=new KeySpline(0,0,1,1)}},transit:function(a,b,c,d){var e=(Date.now()-this.beginning)/a.time,g=d.getContext("2d"),e=this.timingFunction.get(e);g.clearRect(0,0,d.width,d.height);var i=drawY=0;if("stayback"!=a.stay)switch(a.from){case "top":drawY=
d.height*e;break;case "right":i=-1*b.width*e;break;case "bottom":drawY=-1*b.height*e;break;default:i=d.width*e}g.drawImage(b,i,drawY,b.width,b.height);var b=c.height,j=c.width,k=0,l=0;if("stayfore"==a.stay)switch(i=drawY=0,a.from){case "top":b*=e;break;case "right":j*=e;i=k=(1-e)*c.width;break;case "bottom":b*=e;drawY=l=(1-e)*c.height;break;default:j*=e}else switch(a.from){case "top":drawY=c.height*(e-1);break;case "right":i=d.width*(1-e);break;case "bottom":drawY=(1-e)*d.height;break;default:i=c.width*
(e-1)}0<j*b&&g.drawImage(c,k,l,j,b,i,drawY,j,b)},teardown:function(){delete this.beginning;delete this.timingFunction}});$.extend(Tag.actions.trans.rules,{vague:{type:"INT",defaultValue:64},rule:{type:"STRING"},liveview:{type:"BOOLEAN",allowString:["auto"],defaultValue:"auto"}});
Tag.actions.trans.methods.universal=new TransMethod({preload:function(a){if(!("rule"in a))throw"rule\u5c5e\u6027\u306f\u5fc5\u9808\u3067\u3059";var b=this;this.liveview=function(){if(!0===a.liveview)return!0;if("auto"==a.liveview){var b;b=a.layer.fore==o2.foreLayers.baseLayer?o2.allLayers():a.layer;for(var d in b)if(b[d].moveTag)return!0}return!1}();return ResourceLoader.loadImage(a.rule).done(function(a){b.maskImage=a})},prepare:function(){this.beginning=Date.now();this.maskCanvas=document.createElement("canvas");
this.maskCanvas.width=this.maskImage.width;this.maskCanvas.height=this.maskImage.height;this.maskContext=this.maskCanvas.getContext("2d");this.maskContext.drawImage(this.maskImage,0,0);this.maskData=this.maskContext.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height)},transit:function(a,b,c,d){var e=(Date.now()-this.beginning)/a.time;1<e&&(e=1);var g,i=b.getContext("2d");g=c.getContext("2d");b=i.getImageData(0,0,b.width,b.height);c=g.getImageData(0,0,c.width,c.height).data;g=b.data;this.liveview||
(this.beforeBitmap=g,this.afterBitmap=c);var a=a.vague,e=a+(a+255)*-e,b=this.maskData.data,i=d.getContext("2d"),j=i.createImageData(d.width,d.height),k=j.data;if(this.maskCanvas.width==d.width&&this.maskCanvas.height==d.height)for(var d=0,l=k.length;d<l;d+=4){var n=1-(b[d]+e)/a,n=Math.max(0,Math.min(1,n));k[d]=g[d]+(c[d]-g[d])*n;k[d+1]=g[d+1]+(c[d+1]-g[d+1])*n;k[d+2]=g[d+2]+(c[d+2]-g[d+2])*n;k[d+3]=255}else for(var p=d.width,q=this.maskCanvas.width,m=this.maskCanvas.height,d=0,l=k.length;d<l;d+=4)n=
Math.floor(d/4/p),maskX=d/4%q,maskY=n%m,maskIndex=4*(maskX+maskY*q),n=1-(b[maskIndex]+e)/a,n=Math.max(0,Math.min(1,n)),k[d]=g[d]+(c[d]-g[d])*n,k[d+1]=g[d+1]+(c[d+1]-g[d+1])*n,k[d+2]=g[d+2]+(c[d+2]-g[d+2])*n,k[d+3]=255;i.putImageData(j,0,0)},teardown:function(){delete this.beginning;delete this.maskCanvas;delete this.maskContext;delete this.maskData;delete this.maskImage}});
Tag.actions.move=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},spline:{type:"BOOLEAN"},time:{type:"INT",required:!0},delay:{type:"INT"},path:{type:"STRING"},accel:{type:"INT",defaultValue:0},o2_path:{type:"STRING"},o2_orx:{type:"FLOAT"},o2_ory:{type:"FLOAT"}},action:function(a){var b=this,c=a.time,d=a.layer[a.page];"o2_orx"in a&&(d.transformOrigin.x=a.o2_orx);"o2_ory"in a&&(d.transformOrigin.y=a.o2_ory);if(!("path"in a)&&!("o2_path"in a))return this.error("path\u5c5e\u6027\u304bo2_path\u5c5e\u6027\u306e\u3044\u305a\u308c\u304b\u306f\u5fc5\u9808\u3067\u3059"),
0;var e=function(a,b,c,d,e,g){this.x=a;this.y=b;this.opacity=c;this.zoomX=d;this.zoomY=e;this.rotation=g},g=[],i=a.path;"o2_path"in a&&(i=a.o2_path);var j=i.match(/\((-?[0-9,\s:]+)*\)/g);null==j&&this.error("path\u5c5e\u6027\u306e\u30d5\u30a9\u30fc\u30de\u30c3\u30c8\u304c\u6b63\u3057\u304f\u3042\u308a\u307e\u305b\u3093");g.push(new e(d.rect.x,d.rect.y,d.opacity,d.scaleX,d.scaleY,d.rotation));for(var k=0;k<j.length;k++){var l=j[k],l=l.replace("(","").replace(")",""),l=l.split(","),n=new e,p=parseFloat(l[0]);
n.x=isNaN(p)?g[g.length-1].x:p;p=parseFloat(l[1]);n.y=isNaN(p)?g[g.length-1].y:p;p=parseFloat(l[2]);n.opacity=isNaN(p)?g[g.length-1].opacity:p/255;p=[];if(3<l.length){if(i==a.path)return this.error("path\u5c5e\u6027\u306b4\u3064\u4ee5\u4e0a\u306e\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0;p=l[3].split(":")}2==p.length?(n.zoomX=parseFloat(p[0])/100||g[g.length-1].zoomX,n.zoomY=parseFloat(p[1])/100||g[g.length-1].zoomY):(n.zoomX=parseFloat(p[0])/
100||g[g.length-1].zoomX,n.zoomY=parseFloat(p[0])/100||g[g.length-1].zoomY);l=parseFloat(l[4]);n.rotation=isNaN(l)?g[g.length-1].rotation:l/180*Math.PI;g.push(n)}var c=a.time*(g.length-1),q;q=-1>a.accel?new KeySpline(0.08,0.44,0.42,0.93):1<a.accel?new KeySpline(0.45,0,0.97,0.65):new KeySpline(0,0,1,1);var e=function(){d.moveTag&&(d.moveTag.end=!0);d.moveTag=this;var e=void 0;a.spline&&2<=g.length&&(e=B_Spline_Generator(g.map(function(a){return[a.x,a.y]})));var i=Date.now();renderer.animator.requestFrame(function H(){var a=
(Date.now()-i)/c,j=1/(g.length-1);if(1<=a||b.end)a=g[g.length-1],d.rect.x=a.x,d.rect.y=a.y,d.opacity=a.opacity,d.scaleX=a.zoomX,d.scaleY=a.zoomY,d.rotation=a.rotation,$(o2).off("transEnd",m),m=null,b.end=!1,d.moveTag==b&&delete d.moveTag,b.done();else{renderer.animator.requestFrame(H);var a=q.get(a),k=Math.floor((g.length-1)*a),l=k+1,j=a/j-k;l>=g.length&&(l=g.length-1);k=g[k];l=g[l];a=e?e(100*a):{x:k.x+(l.x-k.x)*j,y:k.y+(l.y-k.y)*j};d.rect.x=a.x;d.rect.y=a.y;d.opacity=k.opacity+(l.opacity-k.opacity)*
j;d.scaleX=k.zoomX+(l.zoomX-k.zoomX)*j;d.scaleY=k.zoomY+(l.zoomY-k.zoomY)*j;d.rotation=k.rotation+(l.rotation-k.rotation)*j}})},m=function(){d.moveTag==b&&delete d.moveTag;d=d.getCorrespondingLayer();d.moveTag=b};$(o2).on("transEnd",m);a.delay?setTimeout(e.bind(this),a.delay):e.call(this);return 0}});Tag.actions.stopmove=new TagAction({action:function(){for(var a=o2.allLayers(),b=a.length-1;0<=b;b--)a[b].moveTag&&(a[b].moveTag.end=!0);return 0}});
Tag.actions.wm=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(a){function b(){for(var a=o2.allLayers(),b=a.length-1;0<=b;b--)a[b].moveTag&&(a[b].moveTag.end=!0)}var c;a:{c=o2.allLayers();for(var d=c.length-1;0<=d;d--)if(c[d].moveTag&&!c[d].moveTag.end){c=!0;break a}c=!1}if(!c)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b(),0;wait("click",b)}wait("move");return 1}});
(function(){var a=!1,b=!1;Tag.actions.quake=new TagAction({rules:{time:{type:"INT",required:!0},hmax:{type:"INT",defaultValue:10},vmax:{type:"INT",defaultValue:10}},action:function(c){function d(){a=!0;for(var d=0;d<g;d++)i.push({x:Math.floor(2*Math.random()*c.hmax)-c.hmax,y:Math.floor(2*Math.random()*c.vmax)-c.vmax});i.push({x:0,y:0});renderer.animator.requestFrame(function n(){var d=Date.now()-e,g=1/(i.length-1),k=d/c.time;1<k||b?(k=1,b=a=!1,j.done()):renderer.animator.requestFrame(n);var r=Math.floor((i.length-
1)*k),d=r+1,g=k/g-r;d>=i.length&&(d=i.length-1);r=i[r];d=i[d];renderer.xShift=r.x+(d.x-r.x)*g;renderer.yShift=r.y+(d.y-r.y)*g})}var e=Date.now(),g=Math.ceil(c.time/50),i=[],j=this;if(a)return b=!0,renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){d();j.done()})}),1;d();return 0}});Tag.actions.stopquake=new TagAction({rules:{},action:function(){a&&(b=!0);return 0}});Tag.actions.wq=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(c){if(!a)return 0;
if(c.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b=!0,0;wait("click",function(){b=!0})}wait("quake");return 1}})})();
Tag.actions.label=new TagAction({rules:{name:{type:"STRING",required:!0},caption:{type:"STRING"}},action:function(a){if(this.conductor!=conductor)return 0;if(config.autoRecordPageShowing){if(currentConductor.currentRecordName){var b=sf[currentConductor.currentRecordName];void 0===b&&(b=0);b++;sf[currentConductor.currentRecordName]=b}currentConductor.currentRecordName="trail_"+this.file.basename()+"_"+a.name}o2.reloadDelaySpeed();o2.skipMode==o2.SKIP_MODE_UNREAD&&!this.conductor.isCurrentRead()&&(o2.skipMode=
o2.SKIP_MODE_NONE);if("caption"in a&&config.saveMode==o2.SAVE_MODE_KAG3){if(currentConductor.macroStack.length)return o2.error("\u30bb\u30fc\u30d6\u30e2\u30fc\u30c9\u304ckag3\u30e2\u30fc\u30c9\u306e\u5834\u5408\u3001\u30e9\u30d9\u30eb\u3092\u30de\u30af\u30ed\u306e\u4e2d\u306b\u7f6e\u3044\u3066\u306f\u3044\u3051\u306a\u3044\u3002"),0;""!=a.caption?saveCurrentState(a.caption):saveCurrentState()}return 0}});
Tag.actions.jump=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},disable_clear_stack:{type:"BOOLEAN",defaultValue:!1}},action:function(a){function b(b){b||e.error("\u30b7\u30ca\u30ea\u30aa\u30d5\u30a1\u30a4\u30eb "+a.storage+" \u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093");if(a.target){var c=a.target;"*"==c.charAt(0)&&(c=c.substring(1));(d=b.getLabelTag(c))||e.error("\u30e9\u30d9\u30eb "+c+" \u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093")}else d=
b.lines[0];e.conductor.setTag(d);a.disable_clear_stack||(e.conductor.clearIfStack(),e.conductor.clearMacroStack(),(b=(b=e.conductor&&e.conductor.dispatchQueue[0])&&b.file.lines[b.currentLine])&&b.isPrototypeOf(e)&&e.conductor.dispatchQueue.pop())}"o2_url"in a&&window.open(a.o2_url,a.o2_urltarget);var c,d,e=this;c=a.storage?KAGFiles(a.storage):this.conductor.macroStack.length?$.when(this.conductor.macroStack[0].returnTag.restore()).then(function(a){return a.file}):this.conductor.file;if(c instanceof
KAGFile)return b(c),0;$.when(c).then(function(a){b(a);e.done()});return 1}});Tag.actions.call=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(a){a=currentConductor.getNextTag().toRestorable();config.autoRecordPageShowing&&(a.recordName=currentConductor.currentRecordName);currentConductor.callStack.push(a);a=this.normalizedArgs();a.disable_clear_stack=!0;a=new Tag("jump",a);currentConductor.queue.push(a);return 0}});
Tag.actions["return"]=new TagAction({rules:{storage:{type:"STRING"},target:{type:"STRING"}},action:function(a){var b=currentConductor.callStack.pop();b||this.error("\u30b5\u30d6\u30eb\u30fc\u30c1\u30f3\u5916\u3067return\u30bf\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093");var c=b.recordName,b=b.restore(),a=this.normalizedArgs();a.disable_clear_stack=!0;if(a.storage||a.target)return a=new Tag("jump",a),currentConductor.queue.push(a),0;if(b instanceof Tag)return currentConductor.setTag(b),
0;var d=this;$.when(b).then(function(a){setTimeout(function(){c&&(currentConductor.currentRecordName=c);currentConductor.setTag(a);d.done()})});return 1}});
Tag.actions.macro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(a){var b=new MacroDefinition({name:a.name.toLowerCase(),startTag:this.conductor.getNextTag().toRestorable()});this.conductor.macros[a.name.toLowerCase()]=b;(a=this.conductor.getNextTag("endmacro"))||this.error("endmacro\u30bf\u30b0\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093");this.conductor.setTag(a,!0);return 0}});Tag.actions.endmacro=new TagAction({action:function(){return 0}});
Tag.actions.erasemacro=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(a){delete this.conductor.macros[a.name];return 0}});
Tag.actions.seopt=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT"},gvolume:{type:"INT"},pan:{type:"INT",defaultValue:0}},action:function(a){var b=o2.se[a.buf],c=Math.max(-100,Math.min(100,a.pan/100));if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;"volume"in a&&b.setVolume(a.volume/
100);"pan"in a&&b.setPan(c);"gvolume"in a&&o2.setGVolume(a.gvolume/100);return 0}});
Tag.actions.playse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(a){var b=o2.se[a.buf];if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;b.play(a.storage);b.setLoop(a.loop);
"o2_start"in a&&b.setTime(a.o2_start);var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),1):0}});
Tag.actions.stopse=new TagAction({rules:{buf:{type:"INT",defaultValue:0}},action:function(a){var b=o2.se[a.buf];if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;b.stop();return 0}});
Tag.actions.fadese=new TagAction({rules:{buf:{type:"INT",defaultValue:0},volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(a){var b=o2.se[a.buf];if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;b.fade({toVolume:a.volume/100,duration:a.time});return 0}});
Tag.actions.fadeinse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!1},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.se[a.buf];if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),
0;b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);"o2_volume"in a&&b.setVolume(a.o2_volume/100);b.fade({fromVolume:0,duration:a.time});var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),1):0}});
Tag.actions.fadeoutse=new TagAction({rules:{buf:{type:"INT",defaultValue:0},time:{type:"INT",required:!0}},action:function(a){var b=o2.se[a.buf];if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;b.fade({toVolume:0,duration:a.time}).done(function(){b.pause()});return 0}});
Tag.actions.wf=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=this,c=o2.se[a.buf];if(!c)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;var d=c.fade(),e=!1;if(!d)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return c.stopFade(),
0;wait("click",function(){e=!0;c.stopFade()})}d.done(function(){e||setTimeout(function(){b.done()})});return 1}});
Tag.actions.ws=new TagAction({rules:{buf:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.se[a.buf];if(!b)return this.warn(a.buf+"\u3068\u3044\u3046\u5b58\u5728\u3057\u306a\u3044\u30d0\u30c3\u30d5\u30a1\u756a\u53f7\u304c\u6307\u5b9a\u3055\u308c\u305f\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;if(!b.isPlaying||b.loop)return o2.warn("\u52b9\u679c\u97f3\u306e\u30eb\u30fc\u30d7\u518d\u751f\u4e2d\u306b\u518d\u751f\u7d42\u4e86\u3092\u5f85\u3064\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),
0;var c=this,d=!1;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b.stop(),0;wait("click",function(){d=!0;b.stop()})}$(b).one("ended",function(){d||setTimeout(function(){c.done()})});return 1}});Tag.actions.bgmopt=new TagAction({rules:{volume:{type:"INT"},gvolume:{type:"INT"}},action:function(a){var b=o2.bgm;"volume"in a&&b.setVolume(a.volume/100);"gvolume"in a&&o2.setGVolume(a.gvolume/100);return 0}});
Tag.actions.playbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_block:{type:"BOOLEAN"}},action:function(a){var b=o2.bgm;b.stopFade();b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),1):0}});Tag.actions.pausebgm=new TagAction({action:function(){o2.bgm.pause();return 0}});
Tag.actions.resumebgm=new TagAction({action:function(){o2.bgm.play();return 0}});Tag.actions.stopbgm=new TagAction({action:function(){o2.bgm.stop();return 0}});Tag.actions.fadebgm=new TagAction({rules:{volume:{type:"INT",required:!0},time:{type:"INT",required:!0}},action:function(a){o2.bgm.fade({toVolume:a.volume/100,duration:a.time});return 0}});
Tag.actions.fadeinbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},time:{type:"INT",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},o2_start:{type:"TIME"},o2_volume:{type:"INT"},o2_block:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.bgm;b.play(a.storage);b.setLoop(a.loop);"o2_start"in a&&b.setTime(a.o2_start);"o2_volume"in a&&b.setVolume(a.o2_volume/100);b.fade({fromVolume:0,duration:a.time});var c=this;return a.o2_block?(b.loadDefer.done(function(){setTimeout(function(){c.done()})}),
1):0}});Tag.actions.fadeoutbgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){var b=o2.bgm,c=b.volume;(a=b.fade({toVolume:0,duration:a.time}))&&a.done(function(){b.stop();b.setVolume(c)});return 0}});Tag.actions.fadepausebgm=new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){var b=o2.bgm;(a=b.fade({toVolume:0,duration:a.time}))&&a.done(function(){b.pause()});return 0}});
Tag.actions.xchgbgm=new TagAction({rules:{storage:{type:"STRING",required:!0},loop:{type:"BOOLEAN",defaultValue:!0},time:{type:"INT",required:!0},overlap:{type:"INT",defaultValue:0},volume:{type:"INT"},o2_start:{type:"TIME"}},action:function(a){var b=this,c;c="volume"in a?a.volume/100:o2.bgm.volume;if(!browser.supportsMultipleAudio&&o2.prioritySound==o2.bgm)return o2.bgm.stop(),o2.bgm.setFile(a.storage).done(function(){setTimeout(function(){o2.bgm.play();o2.bgm.setVolume(c);o2.bgm.setLoop(a.loop);
"o2_start"in a&&o2.bgm.setTime(a.o2_start);b.done()})}),1;var d=new Sound,e=o2.bgm;d.setFile(a.storage).done(function(){o2.bgm=d;$.when(e.fade({toVolume:0,duration:a.time,id:"old"})).done(function(){e.stop()});setTimeout(function(){d.play();"o2_start"in a&&d.setTime(a.o2_start);d.fade({fromVolume:0,toVolume:c,duration:a.time})},a.time-a.overlap);setTimeout(function(){b.done()})});d.setLoop(a.loop);return 1}});
Tag.actions.wb=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=this,c=o2.bgm,d=c.fade();if(!d)return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return c.stopFade(),0;wait("click",function(){c.stopFade()})}d.done(function(){setTimeout(function(){b.done()})});return 1}});
Tag.actions.wl=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=this,c=o2.bgm;if(!c.isPlaying||c.loop)return o2.warn("\u52b9\u679c\u97f3\u306e\u30eb\u30fc\u30d7\u518d\u751f\u4e2d\u306b\u518d\u751f\u7d42\u4e86\u3092\u5f85\u3064\u3053\u3068\u306f\u3067\u304d\u306a\u3044\u305f\u3081\u3001\u3053\u306e\u30bf\u30b0\u306f\u7121\u8996\u3055\u308c\u307e\u3057\u305f"),0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return c.stop(),0;wait("click",function(){c.stop()})}$(c).one("ended",
function(){setTimeout(function(){b.done()})});return 1}});
(function(){function a(a,c){c||(c=currentConductor);var d=c.upComingTags(),e=0;"string"===typeof a&&(a=[a]);for(var g=0;g<d.length;g++){var i=d[g];if(0===e&&-1!==a.indexOf(i.tagName))return i;"if"===i.tagName&&e++;"endif"===i.tagName&&e--}}IfStatus=function(){this.conditionFulfilled=!1};Tag.actions["if"]=Tag.actions.ignore=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(b){var c=new IfStatus;this.conductor.ifStack.push(c);try{c.conditionFulfilled=eval(b.o2_exp)}catch(d){c.conditionFulfilled=
!1}"ignore"===this.tagName&&(c.conditionFulfilled=!c.conditionFulfilled);c.conditionFulfilled||(b=a(["else","elsif","endif","endignore"],this.conductor))&&this.conductor.setTag(b);return 0}});Tag.actions["else"]=new TagAction({action:function(){var b=this.conductor.ifStack[this.conductor.ifStack.length-1];if(!b)return 0;b.conditionFulfilled&&(b=a(["endif","endignore"],this.conductor))&&this.conductor.setTag(b);return 0}});Tag.actions.elsif=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},
action:function(b){var c=this.conductor.ifStack[this.conductor.ifStack.length-1],d=!1;if(!c)return 0;if(c.conditionFulfilled)d=!0;else{var e;try{e=eval(b.o2_exp)}catch(g){e=!1}e?c.conditionFulfilled=!0:d=!0}d&&(b=a(["else","elsif","endif","endignore"],this.conductor))&&this.conductor.setTag(b);return 0}});Tag.actions.endif=Tag.actions.endignore=new TagAction({action:function(){this.conductor.ifStack.pop();return 0}});Tag.actions["switch"]=new TagAction({rules:{val:{type:"STRING"}},action:function(a){this.value=
a.val;var c=!1;this.originalCase=this.conductor.tagActions["case"];this.conductor.tagActions["case"]=new TagAction({rules:{val:{type:"STRING"}},action:function(d){d.val==a.val&&(c=!0,this.conductor.setTag(this,!0))}});this.originalDefault=this.conductor.tagActions["default"];this.conductor.tagActions["default"]=new TagAction({action:function(){c||this.conductor.setTag(this,!0)}});this.conductor.setTag(this,!0);return 0},closeAction:function(a){a.conductor.tagActions["case"]=a.originalCase;a.conductor.tagActions["default"]=
a.originalDefault;return 0}});Tag.actions.foreach=new TagAction({rules:{val:{type:"OBJECT"},from:{type:"NUMBER",defaultValue:0},to:{type:"NUMBER"}},action:function(a){if(!("to"in a)&&!("val"in a))return this.error("val\u304bto\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044\u3002"),0;if(null!=a.val&&"object"===typeof a.val&&("to"in a||0!=a.from))return this.error("val\u304cobject\u306e\u6642\u3001to/from\u3092\u4f7f\u3048\u306a\u3044"),0;var c;if("val"in a&&(a.val instanceof Array&&!("to"in
a)||null!=a.val&&"object"===typeof a.val))c=Object.keys(a.val),a.to=c.length-1;this.loopStatus={index:a.from,shouldLoop:function(){return this.index<=a.to},getValues:function(){if(a.val instanceof Array)return[a.val[this.index],this.index];if("object"===typeof a.val){var d=c[this.index];return[d,a.val[d]]}return[this.index]},next:function(){this.index++}};if(this.loopStatus.shouldLoop()){var d=this.loopStatus.getValues();this.setScopeVars(d);this.conductor.setTag(this,!0)}return 0},closeAction:function(a){var c=
a.loopStatus;c.next();c.shouldLoop()&&(a.setScopeVars(c.getValues()),this.conductor.setTag(a,!0),this.keepStack());return 0}})})();
(function(){var a=void 0;Tag.actions.wait=new TagAction({rules:{time:{type:"INT",required:!0},mode:{type:/normal|until/,defaultValue:"normal"},canskip:{type:"BOOLEAN",defaultValue:!0}},action:function(b){var c=this;if("until"===b.mode&&(b.time=a+b.time-Date.now(),0>=b.time))return 0;var d=setTimeout(function(){c.done()},b.time);if(b.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return clearTimeout(d),0;this.conductor.wait("click",function(){clearTimeout(d)})}return 1}});Tag.actions.resetwait=new TagAction({action:function(){a=
Date.now();return 0}})})();Tag.actions.waitclick=new TagAction({action:function(){wait("click",function(){o2.skipMode=o2.SKIP_MODE_NONE});return 1}});Tag.actions.cancelskip=new TagAction({action:function(){o2.skipMode=o2.SKIP_MODE_NONE;return 0}});Tag.actions.clickskip=new TagAction({rules:{enabled:{type:"BOOLEAN",required:!0}},action:function(a){o2.clickSkipEnabled=a.enabled;return 0}});Tag.actions.cancelautomode=new TagAction({action:function(){o2.cancelAutoMode();return 0}});
Tag.actions.eval=new TagAction({rules:{o2_exp:{type:"STRING"},func:{type:"FUNCTION"}},action:function(a){!a.o2_exp&&!a.func&&this.error("o2_exp\u304c\u306a\u3044\u3067\u3059");try{a.o2_exp?eval(a.o2_exp):a.func(a)}catch(b){}return 0}});Tag.actions.o2_iscript=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){try{eval(a.o2_exp)}catch(b){}return 0}});
$(function(){function a(){b=[];for(var a=o2.autoHideLayers(),c=0;c<a.length;c++){var g=a[c];b.push(g.visible);g.visible=!1}renderer.animator.requestFrame()}var b=void 0;$(o2).on("rclick",function(){if(-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName)&&o2.rclickSettings.enabled&&!b)if(o2.rclickSettings.call){extraConductor.setFile(conductor.file);currentConductor=extraConductor;var a=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage});extraConductor.queue.push(a)}else o2.rclickSettings.jump?
(a=new Tag("jump",{target:o2.rclickSettings.target,storage:o2.rclickSettings.storage}),currentConductor.queue.push(a)):Tag.actions.rclick.hideMessageLayer()});var c=function(a){a.stopImmediatePropagation();if(b){for(var a=o2.autoHideLayers(),e=0;e<a.length;e++)a[e].visible=b[e];renderer.animator.requestFrame();b=void 0;"p"==conductor.currentTag.tagName?o2.showGlyph("page"):"l"==conductor.currentTag.tagName&&o2.showGlyph("line")}$(o2).off("click",c);$(o2).off("rclick",c)};Tag.actions.rclick=new TagAction({rules:{call:{type:"BOOLEAN"},
jump:{type:"BOOLEAN"},target:{type:"STRING"},storage:{type:"STRING"},enabled:{type:"BOOLEAN"}},action:function(a){if("call"in a&&!0===a.call&&"jump"in a&&!0===a.jump)return this.error("call\u5c5e\u6027\u3068jump\u5c5e\u6027\u306e\u4e21\u65b9\u306btrue\u3092\u6307\u5b9a\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0;for(var b in a)a.hasOwnProperty(b)&&(o2.rclickSettings[b]=a[b]);return 0},hideMessageLayer:function(){a();$(o2).bindFirst("click",c);$(o2).bindFirst("rclick",c)},showMessageLayer:function(){showMessageLayer()}});
Tag.actions.hidemessage=new TagAction({action:function(){a();var b=this;$(o2).bindFirst("click",c);$(o2).bindFirst("click",function g(){setTimeout(function(){b.done()});$(o2).off("click",g)});return 1}})});
(function(){var a=void 0;Tag.actions.o2_request=new TagAction({rules:{method:{type:/get|post/i,required:!0},url:{type:"STRING",required:!0},req:{type:"STRING",required:!0},"return":{type:"STRING",defaultValue:"req"}},action:function(b){a=$.ajax({url:b.url,type:b.method,data:b.req}).done(function(c,d,e){ev[b["return"]]={stat:e.status+" "+e.statusText,head:e.getAllResponseHeaders(),body:c};a=void 0});return 0}});Tag.actions.o2_wr=new TagAction({rules:{canskip:{type:"BOOLEAN",defaultValue:!1},timeout:{type:"INT"}},
action:function(b){function c(){e||(d.done(),e=!0)}if(!a)return 0;var d=this,e=!1;a.done(function(){setTimeout(c)});"timeout"in b&&setTimeout(c,b.timeout);b.canskip&&o2.clickSkipEnabled&&wait("click",function(){e=!0});return 1}})})();Tag.actions.title=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(a){config.title=a.name;document.title=config.title;return 0}});
var GestureRecognizer=function(a){for(var b in a)this[b]=a[b];this.state=GestureRecognizer.STATE.POSSIBLE;this.mutualExclusive=!0};GestureRecognizer.STATE={NONE:0,POSSIBLE:1,SATISIFIED:2,CANCELLED:3};GestureRecognizer.prototype.start=function(){};GestureRecognizer.prototype.move=function(){};GestureRecognizer.prototype.end=function(){};GestureRecognizer.prototype.cancel=function(){};GestureRecognizer.prototype.satisified=function(){this.manager&&this.manager.satisified(this)};
GestureRecognizer.prototype.failed=function(){this.manager&&this.manager.failed(this)};GestureRecognizer.prototype.shouldCancelOtherRecognizer=function(){return this.mutualExclusive};GestureRecognizer.prototype.shouldBeCancelled=function(){return!0};
GestureRecognizer.accumulateRecognizer=function(a,b,c,d,e){function g(e,g){var l=e.x-i.startLocation.x,n=e.y-i.startLocation.y;return g&&(0<=l/a&&1>=l/a||0<=l/b&&1>=l/b)&&(0<=n/c&&1>=n/c||0<=n/d&&1>=n/d)||(void 0==c||n>c)&&(void 0==d||n<d)&&(void 0==a||l>a)&&(void 0==b||l<b)?!0:!1}var i=new GestureRecognizer({startLocation:void 0,start:function(a){a=a.originalEvent.normalizedCoordinate();i.startLocation=a;i.state=GestureRecognizer.STATE.POSSIBLE},move:function(a){i.startLocation&&(a=a.originalEvent.normalizedCoordinate(),
g(a,!0)?g(a)&&(i.satisified(),e(),i.startLocation=void 0):i.cancel())},end:function(a){i.startLocation&&(a=a.originalEvent.normalizedCoordinate(),g(a)?(i.satisified(),e()):i.cancel())},cancel:function(){i.startLocation=void 0;i.failed()}});return i};
GestureRecognizer.basicRecognizer=function(a,b){var c=new GestureRecognizer({startLocation:void 0,start:function(d){c.startLocation=d.originalEvent.normalizedCoordinate();"absolute"==a?b("start",c.startLocation.x,c.startLocation.y):"delta"==a&&b("start",0,0);c.state=GestureRecognizer.STATE.POSSIBLE},move:function(d){if(c.startLocation){var d=d.originalEvent.normalizedCoordinate(),e=d.x-c.startLocation.x,g=d.y-c.startLocation.y;"absolute"==a?b("move",d.x,d.y):"delta"==a&&b("move",e,g)}},end:function(d){if(c.startLocation){var d=
d.originalEvent.normalizedCoordinate(),e=d.x-c.startLocation.x,g=d.y-c.startLocation.y;"absolute"==a?b("end",d.x,d.y):"delta"==a&&b("end",e,g);c.satisified();c.startLocation=void 0}},cancel:function(){c.startLocation=void 0;c.failed()}});return c};
GestureRecognizer.longTapRecognizer=function(a,b,c){var d=new GestureRecognizer({startDate:void 0,startLocation:void 0,timer:void 0,start:function(b){d.startDate=Date.now();d.startLocation=b.originalEvent.normalizedCoordinate();d.state=GestureRecognizer.STATE.POSSIBLE;clearTimeout(d.timer);d.timer=setTimeout(function(){d.startDate=void 0;d.startLocation=void 0;d.timer=void 0;d.satisified();c()},a)},move:function(a){if(d.startLocation){var a=a.originalEvent.normalizedCoordinate(),c=a.y-d.startLocation.y;
(a.x-d.startLocation.x>b||c>b)&&d.cancel()}},end:function(){d.cancel()},cancel:function(){d.startDate=void 0;d.startLocation=void 0;clearTimeout(d.timer);d.timer=void 0;d.failed()}});return d};
var GestureManager={isProcessingEvent:!1,recognizers:[],addRecognizer:function(a){a.manager=this;this.recognizers.push(a)},removeRecognizer:function(a){a=this.recognizers.indexOf(a);-1!=a&&this.recognizers.splice(a,1)},satisified:function(a){a.state=GestureRecognizer.STATE.SATISIFIED;for(var b=0;b<this.recognizers.length;b++){var c=this.recognizers[b];c!=a&&a.shouldCancelOtherRecognizer(c)&&c.shouldBeCancelled(a)&&c.cancel()}},failed:function(a){a.state=GestureRecognizer.STATE.CANCELLED},resetIfPossible:function(){if(!this.recognizers.filter(function(a){return a.state==
GestureRecognizer.STATE.POSSIBLE}).length)for(var a=0;a<this.recognizers.length;a++)this.recognizers[a].state=GestureRecognizer.STATE.NONE},eventHandlers:{start:function(a){GestureManager.isProcessingEvent=!0;for(var b=GestureManager.recognizers.length-1;0<=b;b--){var c=GestureManager.recognizers[b];c.state!=GestureRecognizer.STATE.CANCELLED&&c.start(a)}GestureManager.isProcessingEvent=!1},move:function(a){GestureManager.isProcessingEvent=!0;for(var b=GestureManager.recognizers.length-1;0<=b;b--){var c=
GestureManager.recognizers[b];c.state!=GestureRecognizer.STATE.CANCELLED&&c.move(a)}GestureManager.isProcessingEvent=!1},end:function(a){GestureManager.isProcessingEvent=!0;for(var b=GestureManager.recognizers.length-1;0<=b;b--){var c=GestureManager.recognizers[b];c.state!=GestureRecognizer.STATE.CANCELLED&&c.end(a)}GestureManager.isProcessingEvent=!1;GestureManager.resetIfPossible()},cancel:function(a){GestureManager.isProcessingEvent=!0;for(var b=GestureManager.recognizers.length-1;0<=b;b--)GestureManager.recognizers[b].cancel(a);
GestureManager.isProcessingEvent=!1;GestureManager.resetIfPossible()}}};
function setupEventHandlers(){var a,b;$("body").on("touchend",function(){window.scrollTo(0,0);scaleToFitPage()});$(o2).on("click",function(){o2.autoMode?o2.cancelAutoMode():o2.skipMode>o2.SKIP_MODE_CLICK&&o2.skipMode<=o2.SKIP_MODE_STOP&&(o2.skipMode=o2.SKIP_MODE_NONE);o2.hideGlyph();currentConductor.trigger("click")});$("body").on("touchstart mousedown",function(a){GestureManager.eventHandlers.start(a)}).on("touchmove mousemove",function(a){GestureManager.eventHandlers.move(a)}).on("touchend mouseup",
function(a){GestureManager.eventHandlers.end(a)}).on("touchcancel mouseleave",function(a){GestureManager.eventHandlers.cancel(a)});var c=new GestureRecognizer({numberOfTouches:0,maxNumberOfTouches:0,common:function(a,b){b&&(b.preventDefault(),ev.cursorLocation=b.originalEvent.normalizedCoordinate());if(o2.historyLayer.visible){if(b&&3==b.which)return o2.historyLayer.hide("up",!1),!0;o2.historyLayer[a]&&o2.historyLayer[a](b)?o2.setCursorStyle("pointer"):o2.setCursorStyle("default");return!0}if(b&&
3!=b.which)for(var c=o2.foreLayers.messageLayers.length-1;0<=c;c--){var d=o2.foreLayers.messageLayers[c];if(d[a]&&d[a](b))return b.stopImmediatePropagation(),o2.setCursorStyle("pointer"),!0}o2.setCursorStyle("default");return!1},start:function(a){a.originalEvent.changedTouches&&(this.numberOfTouches+=a.originalEvent.changedTouches.length,this.numberOfTouches>this.maxNumberOfTouches&&(this.maxNumberOfTouches=this.numberOfTouches));this.state=GestureRecognizer.STATE.POSSIBLE;this.common("mousedown",
a)},move:function(a){this.common("mousemove",a)},end:function(a){a.originalEvent.changedTouches&&(this.numberOfTouches-=a.originalEvent.changedTouches.length);2==this.maxNumberOfTouches&&(a.which=3);this.common("mouseup",a)||0==this.numberOfTouches&&(3==a.which||2==this.maxNumberOfTouches?$(o2).trigger("rclick"):$(o2).trigger("click"));0>=this.numberOfTouches&&(this.maxNumberOfTouches=this.numberOfTouches=0,this.state=GestureRecognizer.STATE.CANCELLED)},cancel:function(){this.maxNumberOfTouches=this.numberOfTouches=
0;this.failed();this.common("cancel")}});GestureManager.addRecognizer(c);c=new GestureRecognizer({numberOfTouches:0,start:function(a){this.state=GestureRecognizer.STATE.POSSIBLE;a.originalEvent.changedTouches&&(this.numberOfTouches+=a.originalEvent.changedTouches.length);3==this.numberOfTouches&&(this.satisified(),o2.historyLayer.visible||o2.skipToStopForcibly())},move:function(){},end:function(a){a.originalEvent.changedTouches&&(this.numberOfTouches-=a.originalEvent.changedTouches.length);this.state==
GestureRecognizer.STATE.SATISIFIED&&(o2.skipMode=o2.SKIP_MODE_NONE);0>=this.numberOfTouches&&(this.cancel(),this.numberOfTouches=0)},cancel:function(){this.failed();this.numberOfTouches=0}});GestureManager.addRecognizer(c);c=GestureRecognizer.accumulateRecognizer(-20,20,100,void 0,function(){!o2.historyLayer.visible&&!o2.historyLayer.vertical&&o2.historyLayer.touchmoved({x:0,y:30})});GestureManager.addRecognizer(c);var d=GestureRecognizer.accumulateRecognizer(void 0,0,-20,20,function(){!o2.historyLayer.visible&&
o2.historyLayer.vertical&&o2.historyLayer.touchmoved({x:-30,y:0})});GestureManager.addRecognizer(d);c.shouldCancelOtherRecognizer=d.shouldCancelOtherRecognizer=function(a){return a!=e};var e=GestureRecognizer.basicRecognizer("absolute",function(a,b,c){o2.historyLayer.visible&&(e.lastPoint&&o2.historyLayer.touchmoved({x:b-e.lastPoint.x,y:c-e.lastPoint.y}),e.lastPoint="end"==a?void 0:{x:b,y:c})});e.mutualExclusive=!1;GestureManager.addRecognizer(e);$("body").on("keydown",function(c){if("keyCode"in c)switch(c.keyCode){case 37:o2.historyLayer.scrolled({x:30,
y:0});break;case 38:o2.historyLayer.scrolled({x:0,y:30});break;case 39:o2.historyLayer.scrolled({x:-30,y:0});break;case 40:o2.historyLayer.visible&&o2.historyLayer.scrolled({x:0,y:-30});break;case 13:b?o2.skipMode||o2.skipToStopForcibly():(b=!0,o2.historyLayer.visible||$(o2).trigger("click"));break;case 17:if(a)break;if(o2.historyLayer.visible)break;a=!0;o2.skipToStopForcibly()}});$("body").on("keyup",function(c){if("keyCode"in c)switch(c.keyCode){case 17:a=!1;o2.skipMode=o2.SKIP_MODE_NONE;break;
case 13:b=!1,o2.skipMode=o2.SKIP_MODE_NONE}});$("body").on("mousewheel DOMMouseScroll wheel",function(a){a.preventDefault();a=wheelDistance(a.originalEvent);o2.historyLayer.scrolled(a)});$("body").on("touchstart touchmove touchend touchcancel",function(a){a.originalEvent.normalizedCoordinate();"button"!=a.target.type&&a.preventDefault()});$("body").on("contextmenu",function(a){a.preventDefault()})}var HistoryRecord=function(){};HistoryRecord.prototype.toDrawable=function(){return null};
HistoryRecord.String=function(a){HistoryRecord.call(this);this.text=a};HistoryRecord.String.prototype=Object.create(HistoryRecord.prototype);HistoryRecord.String.prototype.initializer="HistoryRecord.String";HistoryRecord.String.prototype.toDrawable=function(a){return this.text.split("").map(function(b){b=new TextProperties(b);$.extend(b.styles,a.layer.font);return b})};var HistoryCell=function(){this.records=[];this.sizeCache=this.controller=void 0};
HistoryCell.prototype={initializer:"HistoryCell",records:[],objectToBeSerialized:function(a){switch(a){case "initializer":case "records":return this[a]}}};HistoryCell.PageBreakPrototype=function(){};HistoryCell.PageBreakPrototype.prototype=Object.create(HistoryCell.prototype);HistoryCell.PageBreakPrototype.prototype.toJSON=function(){return{initializer:"HistoryCell.PageBreakPrototype"}};HistoryCell.PageBreakPrototype.restore=function(){return HistoryCell.PageBreak};HistoryCell.PageBreak=new HistoryCell.PageBreakPrototype;
var HistoryCellController=function(a,b){DrawableCanvas.call(this);this.cell=a;this.layer=b;this.needPrepare=!0;this.drawables=[];this.needRedrawChildren=!1;this.prepareDrawables();this.drawChildren()};HistoryCellController.prototype=Object.create(DrawableCanvas.prototype);
HistoryCellController.prototype.prepareDrawables=function(){this.needPrepare=!1;for(var a=[],b=0,c=this.cell.records.length;b<c;b++){var d=this.cell.records[b].toDrawable(this,a);d instanceof Drawable?a.push(d):d instanceof Array&&a.push.apply(a,d)}this.drawables=a;c=a.filter(function(a){return a instanceof TextProperties});b=new MessageLayer.textCustomizers.baseTextCustomizer(this.layer,[],c);b.timePassed=Infinity;b.perform();for(b=c.length-1;0<=b;b--)d=c[b],d.rect.x=this.layer.vertical?d.rect.x+
this.layer.margin.right:d.rect.x-this.layer.margin.left,d.rect.y-=this.layer.margin.top;if(this.layer.vertical){d=c.reduce(function(a,b){return Math.min(b.rect.x,a)},Infinity);for(b=0;b<c.length;b++)c[b].rect.x-=d}for(b=0;b<a.length;b++)c=a[b],c instanceof Link&&c.refreshRects();this.cell.sizeCache={width:a.reduce(function(a,b){var c=b.frame();return Math.max(c.x+c.width,a)},0),height:a.reduce(function(a,b){var c=b.frame();return Math.max(c.y+c.height,a)},0)}};
HistoryCellController.prototype.mousemove=function(a){var b=!1;if(this.rect.coverCoordinate(a.x,a.y))for(var c=a.x-this.rect.x,d=a.y-this.rect.y,e=0;e<this.drawables.length;e++)if(a=this.drawables[e],a instanceof Link)a.isHovering(c,d)?(b=!0,a.hovering||(this.needRedrawChildren=a.hovering=!0,this.layer.redrawRect(this.rect))):a.hovering&&(a.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect));else{if(a instanceof Button){var g=a.rect.coverCoordinate(c,d);g&&a.state==Button.STATE_NORMAL?
(a.enter(c,d,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):!g&&a.state==Button.STATE_HOVER&&(a.leave(c,d,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect))}}else for(e=0;e<this.drawables.length;e++)a=this.drawables[e],a instanceof Link&&a.hovering?(a.hovering=!1,this.needRedrawChildren=!0,this.layer.redrawRect(this.rect)):a instanceof Button&&a.state==Button.STATE_HOVER&&(a.leave(c,d,this),this.needRedrawChildren=!0,this.layer.redrawRect(this.rect));return b};
HistoryCellController.prototype.mouseup=function(a){var b=!1;if(this.rect.coverCoordinate(a.x,a.y))for(var c=a.x-this.rect.x,a=a.y-this.rect.y,d=0;d<this.drawables.length;d++){var e=this.drawables[d];e instanceof Link?e.isHovering(c,a)&&(b=!0,e.click()):e instanceof Button&&e.rect.coverCoordinate(c,a)&&(b=!0,e.state=Button.STATE_HOVER,e.click())}return b};
HistoryCellController.prototype.drawChildren=function(){this.rect.width=this.cell.sizeCache.width;this.rect.height=this.cell.sizeCache.height;this.setRect();this.ctx.clearRect(0,0,this.rect.width,this.rect.height);this.ctx.textBaseline="top";for(var a=0;a<this.drawables.length;a++)this.drawables[a].drawOnContext(this.ctx)};
HistoryCellController.prototype.drawOnContext=function(a){this.needRedrawChildren&&this.drawChildren();a.save();this.drawables.length&&DrawableCanvas.prototype.drawOnContext.apply(this,arguments);a.restore()};HistoryRecorder=function(){this.options={enabled:!0,output:!0,repage:config.historyLayerEverypage};this.layer;this.cells=[];this.lineCount=this.pageCount=this.currentPage=0};
HistoryRecorder.prototype.objectToBeSerialized=function(a){switch(a){case "layer":return}return!config.historyLayerStoreState&&("cells"===a||"pageCount"===a||"lineCount"===a)?void 0:this[a]};HistoryRecorder.prototype.importFromSaveData=function(a){this.clearAllRecords();Object.prototype.importFromSaveData.call(this,a)};
HistoryRecorder.prototype.add=function(a){if(this.options.output){if(!(a instanceof HistoryRecord))throw"history record\u3058\u3083\u306a\u3044\u3067\u3059";(!this.cells.length||this.cells[this.cells.length-1]===HistoryCell.PageBreak)&&this.addCell();this.cells[this.cells.length-1].records.push(a);this.lineCount++;this.ensureHistoryLimit()}};
HistoryRecorder.prototype.addCell=function(a){var b=this.cells.length-1;if(this.cells.length&&!this.cells[b].records.length&&this.cells[b]!=HistoryCell.PageBreak)if(a)this.cells[b].records.push(new HistoryRecord.String(" "));else return;this.cells.push(new HistoryCell)};
HistoryRecorder.prototype.addPage=function(){if(this.options.output){var a=this.cells.length-1;this.cells[a]!==HistoryCell.PageBreak&&(this.cells[a].records.length?this.cells.push(HistoryCell.PageBreak):(this.cells[a]=HistoryCell.PageBreak,this.addCell()),this.pageCount++,this.ensureHistoryLimit())}};
HistoryRecorder.prototype.ensureHistoryLimit=function(){var a=config.historyLayerMaxLines||1E3;if(this.pageCount>(config.historyLayerMaxPages||100)){var b=this.cells.indexOf(HistoryCell.PageBreak);this.cells.splice(0,b+1)}if(this.lineCount>a)return a=this.cells.shift(),this.lineCount-=a.records.length,this.cells[0]===HistoryCell.PageBreak&&this.cells.shift(),a};HistoryRecorder.prototype.clearAllRecords=function(){this.cells=[];this.currentPage=this.lineCount=this.pageCount=0};
HistoryLayer=function(){MessageLayer.call(this);this.frameSolid.opacity=0.5;this.visible=!1;this.font.shadow=!1;this.font.edge=!1;this.font.size=36;this.recorder=new HistoryRecorder(this);this.contentOffset={x:0,y:0};this.visibleCellController=[];this.backgroundStay=config.historyLayerFrameFixed;this.animating=!1;this.animationOffset={x:0,y:0};this.animationContentOpacity=1;this.defaultFont.size=config.historyLayerFontHeight;this.defaultFont.face=config.historyLayerFontFace;this.defaultFont.color=
config.historyLayerFontColor;this.defaultFont.shadow=config.historyLayerShadow;this.defaultFont.shadowColor=config.historyLayerShadowColor;this.defaultFont.shadowBlur=config.historyLayerShadowBlur;this.defaultFont.shadowOffsetX=config.historyLayerShadowOffsetX;this.defaultFont.shadowOffsetY=config.historyLayerShadowOffsetY;this.defaultFont.bold=config.historyLayerFontBold;this.defaultFont.edge=config.historyLayerEdge;this.defaultFont.edgeColor=config.historyLayerEdgeColor;this.font=clone(this.defaultFont);
this.style.lineSize=config.historyLayerLineHeight;this.style.lineSpacing=0;this.frameSolid.color=config.historyLayerColor;this.frameSolid.opacity=config.historyLayerOpacity;var a=this;config.historyLayerFrame&&ResourceLoader.loadImage(config.historyLayerFrame,!1).done(function(b){a.frameImage=new DrawableImage(b,0,0)});this.margin={top:config.historyLayerMarginT,right:config.historyLayerMarginR,bottom:config.historyLayerMarginB,left:config.historyLayerMarginL};setTimeout(function(){a.setRect({x:config.historyLayerCurrentPositionX,
y:config.historyLayerCurrentPositionY,width:config.historyLayerCurrentWidth,height:config.historyLayerCurrentHeight})});this.resetCursor();this.originalGlyphShown=!1};HistoryLayer.prototype=Object.create(MessageLayer.prototype);
HistoryLayer.prototype.objectToBeSerialized=function(a){switch(a){case "animating":case "textsProperties":case "buttons":case "links":case "images":case "visibleCellController":return;case "recorder":case "contentOffset":return this[a];case "visible":return!1}return MessageLayer.prototype.objectToBeSerialized.call(this,a)};HistoryLayer.prototype.importFromSaveData=function(a){return Layer.prototype.importFromSaveData.call(this,a)};
HistoryLayer.prototype.drawOnContext=function(){Layer.prototype.drawOnContext.apply(this,arguments)};HistoryLayer.prototype.reloadVertical=function(){this.vertical="auto"==config.historyLayerVertical?o2.currentMessageLayer.vertical:"true"==config.historyLayerVertical||!0==config.historyLayerVertical?!0:!1;this.resetCursor()};
HistoryLayer.prototype.mousemove=function(a){if(!this.visible)return!1;for(var b=!1,c=a.originalEvent.normalizedCoordinate(this),d=0;d<this.visibleCellController.length;d++)this.visibleCellController[d].mousemove(c)&&(b=!0);b||(b=MessageLayer.prototype.mousemove.apply(this,arguments));return b};
HistoryLayer.prototype.mouseup=function(a){if(!this.visible)return!1;for(var b=!1,c=a.originalEvent.normalizedCoordinate(this),d=0;d<this.visibleCellController.length;d++)this.visibleCellController[d].mouseup(c)&&(b=!0);b||(b=MessageLayer.prototype.mouseup.apply(this,arguments));return b};HistoryLayer.prototype.touchmoved=function(a){this.vertical?this.scrolled({x:a.x,y:0}):this.scrolled({x:0,y:a.y})};
HistoryLayer.prototype.scrolled=function(a){if(!this.animating){this.reloadVertical();if(this.vertical){if(!this.visible&&0>a.x){var b=-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName);if(!b)return;this.resetAndShow();return}var c=this.visibleCellController[0],d=this.visibleCellController[this.visibleCellController.length-1],b=!0;if(!this.visibleCellController.length||c.rect.x+a.x>this.margin.left||c.rect.x+c.rect.width+a.x<this.margin.left||d.rect.x+d.rect.width+a.x<this.rect.width-
this.margin.right||d.rect.x+a.x>this.rect.width-this.margin.right){if(this.visibleCellController.length){if(c.rect.x+a.x>this.margin.left&&0<a.x){c=this.recorder.cells.indexOf(c.cell);c=this.recorder.cells[c+1];if(!c||!c.records.length&&c!=HistoryCell.PageBreak)b=!1,this.contentOffset.x=0,this.hide("right",!1);c&&c===HistoryCell.PageBreak&&(b=!1,this.newerPage("right"))}if(d.rect.x+d.rect.width+a.x<this.rect.width-this.margin.right&&0>a.x){c=this.recorder.cells.indexOf(d.cell);c=this.recorder.cells[c-
1];if(!c){b=!1;this.contentOffset.x-=this.rect.width-this.margin.right-(d.rect.x+d.rect.width);this.visibleCellController=this.childrenAtContentOffset(this.contentOffset);return}c&&c===HistoryCell.PageBreak&&(b=!1,this.olderPage("left"))}}b&&(this.contentOffset.x-=a.x,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.x-=a.x,this.visibleCellController.forEach(function(b){b.rect.x+=a.x}),renderer.animator.requestFrame()}else{if(!this.visible&&0<a.y){b=
-1!=["p","l","s"].indexOf(currentConductor.currentTag.tagName);if(!b)return;this.resetAndShow();return}c=this.visibleCellController[0];d=this.visibleCellController[this.visibleCellController.length-1];b=!0;if(!this.visibleCellController.length||c.rect.y+c.rect.height+a.y<this.rect.height-this.margin.bottom||c.rect.y+a.y>this.rect.height-this.margin.bottom||d.rect.y+a.y>this.margin.top||d.rect.y+d.rect.height+a.y<this.margin.top){if(this.visibleCellController.length){if(c.rect.y+c.rect.height+a.y<
this.rect.height-this.margin.bottom&&0>a.y){c=this.recorder.cells.indexOf(c.cell);c=this.recorder.cells[c+1];if(!c||!c.records.length&&c!=HistoryCell.PageBreak)b=!1,this.contentOffset.y=0,this.hide("up",!1);c&&c===HistoryCell.PageBreak&&(b=!1,this.newerPage())}if(d.rect.y+a.y>this.margin.top&&0<a.y){c=this.recorder.cells.indexOf(d.cell);c=this.recorder.cells[c-1];if(!c){b=!1;this.contentOffset.y+=this.margin.top-d.rect.y;this.visibleCellController=this.childrenAtContentOffset(this.contentOffset);
return}c&&c===HistoryCell.PageBreak&&(b=!1,this.olderPage())}}b&&(this.contentOffset.y+=a.y,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset))}else this.contentOffset.y+=a.y,this.visibleCellController.forEach(function(b){b.rect.y+=a.y}),renderer.animator.requestFrame()}this.redrawRect()}};HistoryLayer.prototype.scrollToPageEnd=function(){this.vertical?this.contentOffset.x=0:this.contentOffset.y=0;this.redrawRect()};
HistoryLayer.prototype.show=function(a,b){o2.skipMode=o2.SKIP_MODE_NONE;o2.cancelAutoMode();void 0===b&&(b=this.backgroundStay);this.reloadVertical();var c=$.Deferred();if(this.animating||!this.recorder.options.enabled||!this.recorder.cells.length)return c.reject(),c.promise();this.visible=this.animating=!0;var d=this,e=Date.now(),g=config.historyLayerCurrentPositionX,i=config.historyLayerCurrentPositionY,j=0,k=300;switch(a){case "left":j=300;k=0;break;case "right":j=-300;k=0;break;case "down":k=
-300,j=0}b?this.animationContentOpacity=0:this.opacity=0;var l=new KeySpline(0.08,0.44,0.42,0.93);renderer.animator.requestFrame(function p(){var a=(Date.now()-e)/500;1<=a?(a=1,d.animating=!1,c.resolve()):renderer.animator.requestFrame(p);a=l.get(a);b?(d.animationContentOpacity=a,d.animationOffset.x=j*(1-a),d.animationOffset.y=k*(1-a),d.redrawRect()):(d.opacity=a,d.rect.x=g+j*(1-a),d.rect.y=i+k*(1-a))});this.redrawRect();return c.promise()};
HistoryLayer.prototype.resetAndShow=function(){this.scrollToPageEnd();if(this.vertical)return this.contentOffset.x=0,this.visibleCellController=this.childrenAtContentOffset(this.contentOffset),this.show("left",!1);this.contentOffset.y=0;this.visibleCellController=this.childrenAtContentOffset(this.contentOffset);return this.show("down",!1)};
HistoryLayer.prototype.hide=function(a,b){void 0===b&&(b=this.backgroundStay);this.animating=!0;var c=this,d=Date.now(),e=this.rect.x,g=this.rect.y,i=this.vertical?300:0,j=this.vertical?0:-300;switch(a){case "left":i=-300;j=0;break;case "right":i=300;j=0;break;case "down":j=300,i=0}var k=$.Deferred(),l=new KeySpline(0.45,0,0.97,0.65);renderer.animator.requestFrame(function p(){var a=(Date.now()-d)/500;1<=a?(c.animating=!1,c.visible=!1,c.textsProperties=[],b?(c.animationContentOpacity=1,c.animationOffset.x=
0,c.animationOffset.y=0,c.redrawRect()):(c.rect.x=e,c.rect.y=g,c.opacity=0),k.resolve()):(renderer.animator.requestFrame(p),a=l.get(a),b?(c.animationContentOpacity=1-a,c.animationOffset.x=i*a,c.animationOffset.y=j*a,c.redrawRect()):(c.opacity=1-a,c.rect.x=e+i*a,c.rect.y=g+j*a))});this.redrawRect();return k.promise()};
(function(){function a(a){return function(c,d,e){c instanceof HistoryCell&&(c=this.recorder.cells.indexOf(c));void 0===d?d=this.recorder.cells.length-1:d instanceof HistoryCell&&(d=this.recorder.cells.indexOf(d));if(c>d)throw"start cannot be larger than end";if(!this.recorder.cells[c]||!this.recorder.cells[d])throw"statr or end doesnt exist";for(var g=0,i=c;i<=d;i++)i==c&&e||i==d&&e||(g+=this.recorder.cells[i].sizeCache[a]);return g}}HistoryLayer.prototype.heightBetweenCells=a("height");HistoryLayer.prototype.widthBetweenCells=
a("width")})();
HistoryLayer.prototype.olderPage=function(a){a||(a="down");var b=this;if(this.vertical){var c=this.widthBetweenCells(this.visibleCellController[this.visibleCellController.length-1].cell),b=this;this.hide(a).done(function(){b.contentOffset.x=c;b.visibleCellController=b.childrenAtContentOffset(b.contentOffset);b.show(a)})}else c=this.heightBetweenCells(this.visibleCellController[this.visibleCellController.length-1].cell),b=this,this.hide(a).done(function(){b.contentOffset.y=c;b.visibleCellController=b.childrenAtContentOffset(b.contentOffset);
b.show(a)})};
HistoryLayer.prototype.newerPage=function(a){a||(a="up");var b=this,c=this.recorder.cells.indexOf(b.visibleCellController[0].cell)+2;if(this.vertical){for(var d=this.widthBetweenCells(c)-(this.rect.width-this.margin.left-this.margin.right),e=c;e<this.recorder.cells.length&&this.recorder.cells[e]!=HistoryCell.PageBreak;e++)c=e;var c=this.widthBetweenCells(c),g=Math.max(c,d);this.hide(a).done(function(){b.contentOffset.x=g;b.visibleCellController=b.childrenAtContentOffset(b.contentOffset);b.show(a)})}else{d=
this.heightBetweenCells(c)-(this.rect.height-this.margin.top-this.margin.bottom);for(e=c;e<this.recorder.cells.length&&this.recorder.cells[e]!=HistoryCell.PageBreak;e++)c=e;c=this.heightBetweenCells(c);g=Math.max(c,d);this.hide(a).done(function(){b.contentOffset.y=g;b.visibleCellController=b.childrenAtContentOffset(b.contentOffset);b.show(a)})}};HistoryLayer.prototype.children=function(){return MessageLayer.prototype.children.apply(this,arguments).concat(this.visibleCellController)};
HistoryLayer.prototype.childrenAtContentOffset=function(a){a||(a=this.contentOffset);if(this.vertical){for(var b=0,c=[],d=!1,e=this.recorder.cells.length-1;0<=e;e--){var g=this.recorder.cells[e];if(!g.sizeCache||0==g.sizeCache.width)g.controller=new HistoryCellController(g,this);b+=g.sizeCache.width;if(b>a.x&&b-g.sizeCache.width<this.rect.width-this.margin.right-this.margin.left+a.x)if(g.controller||(g.controller=new HistoryCellController(g,this)),g.controller.rect=new Rect({x:this.margin.left+(b-
g.sizeCache.width)-a.x,y:this.margin.top,width:g.sizeCache.width,height:g.sizeCache.height}),g!=HistoryCell.PageBreak)c.push(g.controller);else{if(c.length){g.controller=null;d=!0;break}}else g.controller&&(g.controller=null)}!d&&(c.length&&c[c.length-1].rect.x+c[c.length-1].rect.width<this.rect.width-this.margin.right)&&(d=!0);if(d){var a=c[c.length-1],i=this.rect.width-this.margin.right-(a.rect.x+a.rect.width);c.forEach(function(a){a.rect.x+=i})}}else{b=0;c=[];d=!1;for(e=this.recorder.cells.length-
1;0<=e;e--){g=this.recorder.cells[e];if(!g.sizeCache||0==g.sizeCache.height)g.controller=new HistoryCellController(g,this);b+=g.sizeCache.height;if(b>a.y&&b-g.sizeCache.height<this.rect.height-this.margin.top-this.margin.bottom+a.y)if(g.controller||(g.controller=new HistoryCellController(g,this)),g.controller.rect=new Rect({x:this.margin.left,y:this.rect.height-this.margin.bottom-b+a.y,width:g.sizeCache.width,height:g.sizeCache.height}),g!=HistoryCell.PageBreak)c.push(g.controller);else{g.controller=
null;d=!0;break}else g.controller&&(g.controller=null)}!d&&(c.length&&c[c.length-1].rect.y>this.margin.top)&&(d=!0);d&&(a=c[c.length-1],i=a.rect.y-this.margin.top,c.forEach(function(a){a.rect.y-=i}))}return c};
HistoryLayer.prototype.flush=function(){if(this.requestedFrame){this.requestedFrame=!1;this.stackedClearRect=new Rect;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.save();this.backgroundStay||this.ctx.translate(this.animationOffset.x,this.animationOffset.y);for(var a=this.children(),b=0;b<a.length;b++){var c=a[b];if(-1==this.visibleCellController.indexOf(c))c.drawOnContext(this.ctx);else break}this.backgroundStay&&(this.ctx.translate(this.animationOffset.x,this.animationOffset.y),
this.ctx.globalAlpha=this.animationContentOpacity);this.ctx.beginPath();this.ctx.rect(this.margin.left,this.margin.top,this.rect.width-this.margin.left-this.margin.right,this.rect.height-this.margin.top-this.margin.bottom);for(this.ctx.clip();b<a.length;)c=a[b],c.drawOnContext(this.ctx),b++;this.ctx.restore();this.resetCursor()}};
Tag.actions.history=new TagAction({rules:{output:{type:"BOOLEAN"},enabled:{type:"BOOLEAN"}},action:function(a){"output"in a&&(o2.historyLayer.recorder.options.output=a.output);"enabled"in a&&(o2.historyLayer.recorder.options.enabled=a.enabled);return 0}});
Tag.actions.hr=new TagAction({rules:{repage:{type:"BOOLEAN",defaultValue:!1}},action:function(a){o2.historyLayer.recorder.options.repage?a.repage?o2.historyLayer.recorder.addPage():o2.historyLayer.recorder.addCell(!0):o2.historyLayer.recorder.addCell(!0);return 0}});
Tag.actions.showhistory=new TagAction({action:function(){if(!o2.historyLayer.visible){var a=this;o2.historyLayer.resetAndShow().done(function(){a.done()}).fail(function(){a.warn("\u30d2\u30b9\u30c8\u30ea\u30fc\u30ec\u30a4\u30e4\u3092\u958b\u3051\u306a\u304b\u3063\u305f\u3002");a.done()})}return 1}});Tag.actions.historytext=new TagAction({rules:{text:{type:"STRING",required:!0}},action:function(a){a=new HistoryRecord.String(a.text);o2.historyLayer.recorder.add(a);return 0}});
(function(){var a=-1,b={};HistoryRecord.LinkStart=function(a){this.args=a};HistoryRecord.LinkStart.prototype=Object.create(HistoryRecord.prototype);HistoryRecord.LinkStart.prototype.initializer="HistoryRecord.LinkStart";HistoryRecord.LinkStart.prototype.toDrawable=function(c,d){a=d.length;b=this.args};HistoryRecord.LinkEnd=function(){};HistoryRecord.LinkEnd.prototype=Object.create(HistoryRecord.prototype);HistoryRecord.LinkEnd.prototype.initializer="HistoryRecord.LinkEnd";HistoryRecord.LinkEnd.prototype.toDrawable=
function(c,d){if(0<=a){var e=d.slice(a);a=-1;var g=new Link;g.color="#ff0000";g.vertical=c.layer.vertical;g.addTextProperties(e);(function(a){g.click=function(){eval(a.o2_exp)}})(b);return g}};Tag.actions.hact=new TagAction({rules:{o2_exp:{type:"STRING",required:!0}},action:function(a){a=new HistoryRecord.LinkStart(a);o2.historyLayer.recorder.add(a);return 0}});Tag.actions.endhact=new TagAction({action:function(){var a=new HistoryRecord.LinkEnd;o2.historyLayer.recorder.add(a);return 0}})})();
var Video=function(){this.element=document.createElement("video");this.element.setAttribute("webkit-playsinline",!0);this.filepath;this.rect=new Rect(0,0,320,240);this.loop=!1;this.outputs=[];this.volume=1;this.mode=Video.MODE_OVERLAY;this.loadDefer};Video.prototype.toJSON=function(){return{rect:this.rect,loop:this.loop,outputs:this.outputs,volume:this.volume,mode:this.mode,currentTime:this.element.currentTime,paused:this.paused(),filepath:this.filepath}};
Video.prototype.importFromSaveData=function(a){var b=$.Deferred();a.filepath&&(this.setFile(a.filepath),delete a.filepath);"paused"in a&&(a.paused?this.pause():this.play());"currentTime"in a&&this.setTime(1E3*a.currentTime);b.resolve();this.mode=a.mode;this.setVolume(a.volume);this.setLoop(a.loop);this.setRect(a.rect);return b.promise()};Video.MODE_OVERLAY=0;Video.MODE_LAYER=1;Video.canPlayInline=function(){var a=null!=navigator.userAgent.match(/iPad/i);return browser.isIOs&&!a?!1:!0}();
Video.prototype.setFile=function(a){if(Video.canPlayInline){this.filepath=a;var b=this;return this.loadDefer=ResourceLoader.loadVideo(a,!0,this.element).done(function(a){b.setLoop();b.setRect();$(a).on("ended",function(){$(b).trigger("ended")})})}};Video.prototype.setVisible=function(a){if(Video.canPlayInline){var b=document.getElementsByClassName("video-wrapper")[0],c=!!this.element.parentNode;c&&!a?b.removeChild(this.element):!c&&a&&b.appendChild(this.element)}};
Video.prototype.setRect=function(a){a&&(this.rect=a);var b=this;this.loadDefer&&this.loadDefer.done(function(a){a.style.marginLeft=b.rect.x+"px";a.style.marginTop=b.rect.y+"px";a.width=b.rect.width;a.height=b.rect.height})};Video.prototype.setLoop=function(a){void 0!==a&&(this.loop=a);if(this.loadDefer){var b=this;this.loadDefer.done(function(a){a.loop=b.loop})}};Video.prototype.setPlaybackRate=function(a){this.loadDefer&&this.loadDefer.done(function(b){b.playbackRate=a})};
Video.prototype.setVolume=function(a){void 0!==a&&(this.volume=a);if(this.loadDefer){var b=this;this.loadDefer.done(function(a){a.volume=b.volume})}};Video.prototype.setMode=function(){};Video.prototype.play=function(a){a&&this.setFile(a);this.element.play()};Video.prototype.pause=function(){this.element.pause()};Video.prototype.paused=function(){return!this.element||!this.loadDefer?!0:this.element.paused};Video.prototype.stop=function(){this.pause();this.setTime(0)};
Video.prototype.setTime=function(a){this.loadDefer&&this.loadDefer.done(function(b){try{b.currentTime=a/1E3}catch(c){$(b).one("loadedmetadata",function(){b.currentTime=a/1E3})}})};Video.prototype.dummyLoad=function(){this.element.src="x";this.element.load()};
Tag.actions.video=new TagAction({rules:{slot:{type:"INT",defaultValue:0},visible:{type:"BOOLEAN"},left:{type:"INT"},top:{type:"INT"},width:{type:"INT"},height:{type:"INT"},loop:{type:"BOOLEAN"},position:{type:"INT"},frame:{type:"INT"},mode:{type:/overlay|layer/i},playrate:{type:"FLOAT"},volume:{type:"FLOAT"}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;"visible"in a&&b.setVisible(a.visible);
var c=!1;"left"in a&&(b.rect.x=a.left,c=!0);"top"in a&&(b.rect.y=a.top,c=!0);"width"in a&&(b.rect.width=a.width,c=!0);"height"in a&&(b.rect.height=a.height,c=!0);c&&b.setRect();"loop"in a&&b.setLoop(a.loop);"position"in a&&b.setTime(a.position);"mode"in a&&("layer"==a.mode?b.setMode(Video.MODE_LAYER):b.setMode(Video.MODE_OVERLAY));"playrate"in a&&b.setPlaybackRate(a.playrate);"volume"in a&&b.setVolume(a.volume/100);return 0}});
Tag.actions.videolayer=new TagAction({rules:{slot:{type:"INT",defaultValue:0},channel:{type:/1|2/,required:!0},page:{type:/fore|back/,required:!0},layer:{type:"LAYER",required:!0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.outputs[a.channel]=a.layer[a.page];return 0}});
Tag.actions.openvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING",required:!0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;try{b.setFile(a.storage)}catch(c){this.error(c)}return 0}});
Tag.actions.preparevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(){var a=this;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){a.done()})});return 1}});Tag.actions.playvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0},storage:{type:"STRING"}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;try{b.play(a.storage)}catch(c){this.error(c)}return 0}});
Tag.actions.pausevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.pause();return 0}});
Tag.actions.resumevideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.play();return 0}});
Tag.actions.stopvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.stop();return 0}});
Tag.actions.rewindvideo=new TagAction({rules:{slot:{type:"INT",defaultValue:0}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;b.setTime(0);return 0}});
Tag.actions.wv=new TagAction({rules:{slot:{type:"INT",defaultValue:0},canskip:{type:"BOOLEAN",defaultValue:!1}},action:function(a){var b=o2.videos[a.slot];if(!b)return this.error("\u30d3\u30c7\u30aa\u30b9\u30ed\u30c3\u30c8 "+a.slot+" \u304c\u5b58\u5728\u3057\u307e\u305b\u3093"),0;if(b.paused())return 0;if(a.canskip&&o2.clickSkipEnabled){if(o2.skipMode)return b.stop(),0;wait("click",function(){b.stop()})}var c=this;$(b).on("ended",function(){c.done()});return 1}});
Object.defineProperty(Object.prototype,"objectToBeSerialized",{enumerable:!1,writable:!0,value:function(a){return this[a]}});Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1,writable:!0,value:function(){var a=this instanceof Array?[]:{},b;for(b in this){var c=this.objectToBeSerialized(b);void 0!==c&&"function"!=typeof c&&(a[b]=c)}return a}});var saveStack=[],holdingDefers=[];
Object.defineProperty(Object.prototype,"importFromSaveData",{enumerable:!1,writable:!0,value:function(a){var b=[],c=this,d;for(d in a)(function(d){var g=c[d],i=a[d];saveStack.push(d);if("object"==typeof g&&null!==g){var j=g.importFromSaveData(i);j&&(j.stackName=saveStack.join(">"),b.push(j),holdingDefers.push(j),j.done(function(){holdingDefers.splice(holdingDefers.indexOf(j,1))}))}else g=!1,void 0!=i&&i.initializer&&(g=!0,b.push($.when(i.restore()).done(function(a){c[d]=a}))),g||(c[d]=i);saveStack.pop()})(d);
return $.when.apply($,b).then(function(){return c})}});Object.defineProperty(Object.prototype,"restore",{enumerable:!1,writable:!0,value:function(){if(this.initializer){var a=this.initializer.split("."),b=window;a.forEach(function(a){b=b[a]});if("function"===typeof b)return b.restore!=Object.prototype.restore?b.restore(this):(new b).importFromSaveData(this)}return this}});
(function(){function a(a){var b=document.createElement("canvas"),a=Math.min(config.scWidth,a),c=a/config.scWidth*config.scHeight;b.width=a;b.height=c;b.getContext("2d").drawImage(renderer.foreCanvas,0,0,config.scWidth,config.scHeight,0,0,a,c);return b.toDataURL()}var b,c=0;$(function(){$(o2).on("init",function(){$([conductor,extraConductor]).on("ran",function(a,b){0!=b&&saveCurrentSystemState()});if(o2.serverStat.mode==o2.SERVER_MODE_O2SERVER)$(o2).on("systeminit.loggedin",function(){loadSystemStateFromServer()});
else o2.serverStat.mode==o2.SERVER_MODE_STANDALONE&&loadSystemStateFromServer()})});var d=function(){};d.prototype={setItem:function(a,b){try{return localStorage[a]=b,$.Deferred().resolve()}catch(c){return $.Deferred().reject("localStorage\u306e\u5bb9\u91cf\u3092\u8d85\u3048\u307e\u3057\u305f\u3002"+c)}},getItem:function(a){return $.Deferred().resolve(localStorage[a])},deleteItem:function(a){return $.Deferred().resolve(delete localStorage[a])},setGlobalSaveData:function(a){return this.setItem(config.gameID+
"_sf",a)},getGlobalSaveData:function(){var a=$.Deferred();return this.getItem(config.gameID+"_sf").then(function(b){var c;try{c=JSON.parse(b)}catch(d){return $.Deferred().reject(d)}for(var b=Object.keys(localStorage),e=RegExp(config.gameID+"_([0-9]+)"),g=null,q={},m=0;m<b.length;m++)(g=b[m].match(e))&&(b[m]+"_date"in localStorage&&b[m]+"_caption"in localStorage)&&(q[g[1]]={date:new Date(1E3*localStorage.getItem(b[m]+"_date")),caption:localStorage.getItem(b[m]+"_caption"),snapshot:localStorage.getItem(b[m]+
"_screen")});return a.resolve(c,q)})},setSaveData:function(a,b){var a=config.gameID+"_"+a,c=a+"_caption",d=a+"_date",e=a+"_screen";try{this.setItem(a,b.data),this.setItem(c,b.caption),this.setItem(d,b.date),b.snapshot&&this.setItem(e,b.snapshot)}catch(g){return $.Deferred().reject("localStorage\u306e\u5bb9\u91cf\u3092\u8d85\u3048\u307e\u3057\u305f\u3002"+g)}return $.Deferred().resolve()},getSaveData:function(a){a=config.gameID+"_"+a;return this.getItem(a)},deleteSaveData:function(a){var a=config.gameID+
"_"+a,b=a+"_caption",c=a+"_date",d=a+"_screen";return $.when(this.deleteItem(a),this.deleteItem(b),this.deleteItem(c),this.deleteItem(d))}};var e=function(){this.lastSentSystemStringTime=0;this.timerDefer;this.scheduledTimer;this.minimumRequestInterval=1E4};e.prototype=Object.create(d.prototype);$.extend(e,{setGlobalSaveData:function(){function a(){return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/save.php",{sysvars:g,novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid})}if(-1==
o2.serverStat.uid||this.waitingForSystemString)return $.Deferred().reject();if(Date.now()-this.lastSentSystemStringTime>this.minimumRequestInterval)return this.lastSentSystemStringTime=Date.now(),a();var b=this;this.scheduledTimer||(this.timerDefer=$.Deferred().resolve().then(function(){var a=b.lastSentSystemStringTime+b.minimumRequestInterval-Date.now(),c=$.Deferred();setTimeout(function(){c.resolve()},a);return c.promise()}).then(function(){return a()}).done(function(){b.timerDefer=null;b.scheduledTimer=
null;b.lastSentSystemStringTime=Date.now()}));return this.timerDefer.promise()},getGlobalSaveData:function(){if(-1==o2.serverStat.uid)return $.Deferred().reject();this.waitingForSystemString=!0;return $.post(o2.serverStat.saveServer+"/api/1.2/globaldata/load.php",{novel:config.gameID,key:o2.serverStat.skey,uid:o2.serverStat.uid}).then(function(a){"string"==typeof a&&(a=JSON.parse(a));if("string"==typeof a.sysvars)try{a.sysvars=JSON.parse(a.sysvars)}catch(b){return $.Deferred().reject(b)}var c={};
if("sindex"in a)for(var d=0;d<a.sindex.length;d++){var e=a.sindex[d];c[e.save_id]={date:new Date(1E3*e.updated_at),caption:e.caption,snapshot:e.screen}}this.waitingForSystemString=!1;return $.Deferred().resolve(a.sysvars,c)})},setSaveData:function(a,b){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/save.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:a,data:b.data,key:o2.serverStat.skey,screen:b.snapshot||"1",caption:b.caption})})},
getSaveData:function(a){return Renderer.askForLogin().then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/load.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:a,key:o2.serverStat.skey})}).then(function(a){"string"==typeof a&&(a=JSON.parse(a));return a.data})},deleteSaveData:function(a){return $.when(Renderer.askForLogin()).then(function(){return $.post(o2.serverStat.saveServer+"/api/1.2/savedata/erase.php",{uid:o2.serverStat.uid,novel:config.gameID,sindex:a,key:o2.serverStat.skey})})}});
window.loadSystemStateFromServer=function(){return o2.currentSaveAdapter.getGlobalSaveData().done(function(a,b){window.sf=mergeObj(a,sf);for(var c in b){var d=b[c];ev.save.date[c]=d.date;ev.save.caption[c]=d.caption;ev.save.snapshot[c]=d.snapshot}o2.setSeGVolume();o2.setBgmGVolume()})};var g;window.saveCurrentSystemState=function(){var a=$.Deferred();try{g=JSON.stringify(window.sf)}catch(c){o2.error("\u30b7\u30b9\u30c6\u30e0\u5909\u6570\u3092\u4fdd\u5b58\u3067\u304d\u306a\u3044\u3002")}if(b==g)return a.reject();
b=g;return o2.currentSaveAdapter.setGlobalSaveData(b)};window.saveCurrentState=function(b){var d=Tag.actions.save,e=JSON.stringify({o2:o2,f:f,mp:mp,conductor:conductor},function(a,b){if("nodeName"==a)debugger;var c=Object.prototype.toString.apply(b);if(/\[object HTML[A-Za-z]*Element\]/.test(c))debugger;else if("function"==typeof b)debugger;else return b});d.stateString=e;!c&&config.saveThumbnail&&(Tag.actions.save.stateScreenShot=a(config.thumbnailWidth));void 0!=b&&(Tag.actions.save.stateCaption=
b);return Tag.actions.save.stateString};Tag.actions.save=new TagAction({rules:{place:{type:"INT",defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(b){if(void 0==Tag.actions.save.stateString)return config.saveMode==o2.SAVE_MODE_KAG3?o2.warn("\u4e00\u5ea6\u3082\u30bb\u30fc\u30d6\u53ef\u80fd\u306a\u30e9\u30d9\u30eb\u3092\u901a\u904e\u3057\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u30bb\u30fc\u30d6\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f"):config.saveMode==o2.SAVE_MODE_O2KAG&&
o2.warn("\u4e00\u5ea6\u3082 o2_savestat \u30bf\u30b0\u304c\u5b9f\u884c\u3055\u308c\u3066\u3044\u306a\u3044\u72b6\u614b\u3067\u30bb\u30fc\u30d6\u3092\u884c\u304a\u3046\u3068\u3057\u307e\u3057\u305f"),0;if(b.ask&&!confirm("\u672c\u5f53\u306b\u30bb\u30fc\u30d6\u3057\u307e\u3059\u304b\uff1f"))return 0;c||(Tag.actions.save.stateScreenShot=a(config.thumbnailWidth));ev.save.date[b.place]=new Date;ev.save.caption[b.place]=Tag.actions.save.stateCaption;ev.save.snapshot[b.place]=Tag.actions.save.stateScreenShot;
var d=this;Tag.actions.save.processForSlot(b.place).always(function(){setTimeout(function(){d.done()})});return 1},processForSlot:function(a){return o2.currentSaveAdapter.setSaveData(a,{data:Tag.actions.save.stateString,caption:Tag.actions.save.stateCaption,date:Date.now()/1E3,snapshot:Tag.actions.save.stateScreenShot})},adapters:{LocalAdapter:d,O2ServerAdapter:e}});Tag.actions.save.stateString=void 0;Tag.actions.save.stateCaption="";Tag.actions.save.stateScreenShot=void 0;Tag.actions.o2_savestat=
new TagAction({rules:{caption:{type:"STRING"}},action:function(a){if(config.saveMode==o2.SAVE_MODE_KAG3)return this.warn("\u30bb\u30fc\u30d6\u30e2\u30fc\u30c9\u304cKAG3\u30e2\u30fc\u30c9\u306e\u6642\u306bo2_savestat\u30bf\u30b0\u3092\u5b9f\u884c\u3059\u308b\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093"),0;var b=this;renderer.animator.requestFrame(function(){renderer.animator.requestFrame(function(){saveCurrentState(a.caption);b.done()})});return 1}});Tag.actions.load=new TagAction({rules:{place:{type:"INT",
defaultValue:0},ask:{type:"BOOLEAN",defaultValue:!1}},action:function(a){if(a.ask&&!confirm("\u672c\u5f53\u306b\u30ed\u30fc\u30c9\u3057\u307e\u3059\u304b\uff1f"))return 0;var b=this;o2.currentSaveAdapter.getSaveData(a.place).then(Tag.actions.load.processData).done(function(b){Tag.actions.load.applyDeserializedData(b).done(function(){setTimeout(function(){Tag.actions.save.stateString=b;Tag.actions.save.stateCaption=ev.save.caption[a.place];Tag.actions.save.stateScreenShot=ev.save.snapshot[a.place];
currentConductor!=conductor&&currentConductor.reset();currentConductor=conductor;o2.refreshRendererLayers();conductor.oneShot()})})}).fail(function(){b.done()});return 1},processData:function(a){return a},applyDeserializedData:function(a){$("body").css("pointer-events","none");renderer.animator.pause();conductor.pause();var a=JSON.parse(a),b=a.conductor;delete a.conductor;return window.importFromSaveData(a).then(function(){return conductor.importFromSaveData(b)}).done(function(){o2.allLayers().forEach(function(a){a.redrawRect()});
o2.setSeGVolume();o2.setBgmGVolume();$("body").css("pointer-events","auto");renderer.animator.resume();conductor.resume()})}});Tag.actions.locksnapshot=new TagAction({action:function(){0==c&&(Tag.actions.save.stateScreenShot=a(config.thumbnailWidth));c++;return 0}});Tag.actions.unlocksnapshot=new TagAction({action:function(){c--;0>c&&this.error("unlocksnapshot\u306e\u56de\u6570\u306flocksnapshot\u3088\u308a\u591a\u3044\u3067\u3059\u3002");return 0}});Tag.actions.erasebookmark=new TagAction({rules:{place:{type:"INT",
defaultValue:0}},action:function(a){delete ev.save.date[a.place];delete ev.save.caption[a.place];delete ev.save.snapshot[a.place];var b=this;o2.currentSaveAdapter.deleteSaveData(a.place).always(function(){setTimeout(function(){b.done()})});return 1}})})();AnimationConductor=function(a){Conductor.call(this,a);this.layer;this.cellImage;this.canvas;this.nextTagTime;this.shouldStop};AnimationConductor.prototype=Object.create(Conductor.prototype);AnimationConductor.prototype.initializer="AnimationConductor";
AnimationConductor.prototype.importFrom=function(a){this.waitTag=clone(a.waitTag);this.setTag(a.currentTag);this.queue=clone(a.queue);this.status=a.status;this.callStack=clone(a.callStack);this.macroStack=clone(a.macroStack);this.macros=clone(a.macros);this.ifStack=clone(a.ifStack);this.layer=a.layer;a.cellImage&&(this.cellImage=clone(a.cellImage));a.canvas&&(this.canvas=clone(a.canvas));this.shouldStop=a.shouldStop;if(a.status!=Conductor.STATUS_STOP)if("wait"==a.currentTag.tagName){this.setTag(a.currentTag,
!0);var a=(a.nextTagTime||Date.now())-Date.now(),b=this;setTimeout(function(){b.run()},a)}else this.run()};AnimationConductor.prototype.toJSON=function(){return{initializer:"AnimationConductor",file:this.file.filename,lineNumber:0}};AnimationConductor.restore=function(a){return $.when(KAGFiles(a.file)).then(function(a){return new AnimationConductor({file:a})})};
AnimationConductor.prototype.run=function(){var a=o2.debugLevel;o2.debugLevel=0;Conductor.prototype.run.apply(this,arguments);o2.debugLevel=a};AnimationConductor.prototype.addChildToLayer=function(){if(!this.canvas)return!1;-1==this.layer.animationChildren.indexOf(this.canvas)&&this.layer.animationChildren.push(this.canvas);return!0};AnimationConductor.prototype.removeChildFromLayer=function(){var a=this.layer.animationChildren.indexOf(this.canvas);0<=a&&this.layer.animationChildren.splice(a,1)};
AnimationConductor.prototype.wait=function(a){Conductor.prototype.wait.call(this,a)};AnimationConductor.prototype.stop=function(){this.removeChildFromLayer();this.status!==Conductor.STATUS_STOP&&this.queue.push(new Tag("s"))};AnimationConductor.prototype.stopUntilHome=function(){this.shouldStop=!0};
AnimationConductor.prototype.tagActions={loadcell:new TagAction({rules:{storage:{type:"STRING"}},action:function(a){var b=this,c=this.conductor,d,e;try{e=this.conductor.layer.images[0],d=a.storage||e.image.originalURL+"_a"}catch(g){this.error("\u30ec\u30a4\u30e4\u306f\u753b\u50cf\u304c\u306a\u3044\u3067\u3059\u3002")}ResourceLoader.loadImage(d,!1).done(function(a){setTimeout(function(){var d=new DrawableImage(a,0,0);d.cacheEnabled=!1;c.cellImage=d;c.canvas=new DrawableCanvas(e.rect);b.done()})});
return 1}}),copy:new TagAction({rules:{dx:{type:"INT",required:!0},dy:{type:"INT",required:!0},sx:{type:"INT",required:!0},sy:{type:"INT",required:!0},sw:{type:"INT",required:!0},sh:{type:"INT",required:!0}},action:function(a){this.conductor.addChildToLayer()||this.error("loadcell\u3057\u3066\u3044\u306a\u3044\u72b6\u614b\u3067copy\u30bf\u30b0\u3092\u4f7f\u304a\u3046\u3068\u3057\u3066\u307e\u3059");var b=this.conductor.canvas,c=b.canvas.getContext("2d"),d=this.conductor.cellImage;d.options.clipLeft=
a.sx;d.options.clipTop=a.sy;d.options.clipWidth=a.sw;d.options.clipHeight=a.sh;d.rect=new Rect({x:a.dx,y:a.dy,width:a.sw,height:a.sh});b.ctx.clearRect(d.rect.x,d.rect.y,d.rect.width,d.rect.height);d.drawOnContext(c);this.conductor.layer.redrawRect(this.conductor.canvas.rect);return 0}}),clip:new TagAction({rules:{left:{type:"INT",required:!0},top:{type:"INT",required:!0}},action:function(a){if(!this.conductor.layer.images[0])return 0;var b=this.conductor.layer.images[0];b.options.clipLeft=a.left;
b.options.clipTop=a.top;b.cacheEnabled=!1;b.cacheCanvas=void 0;this.conductor.layer.redrawRect(b.rect);return 0}}),wait:new TagAction({rules:{time:{type:"INT",required:!0}},action:function(a){this.conductor.nextTagTime=Date.now()+a.time;var b=this,c=this.conductor;setTimeout(function(){delete c.nextTagTime;b.done()},a.time);return 1}}),label:new TagAction({rules:{name:{type:"STRING"}},action:function(){return 0}}),loop:new TagAction({action:function(){}}),home:new TagAction({action:function(){return this.conductor.shouldStop?
2:0}}),s:new TagAction({action:function(){return 2}})};"jump macro endmacro erasemacro if else elsif endif ignore endignore eval o2_iscript".split(" ").forEach(function(a){AnimationConductor.prototype.tagActions[a]=Tag.actions[a]});
Tag.actions.animstart=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT",required:!0},target:{type:"STRING"}},action:function(a){var b=a.layer[a.page];if(!b.images[0]||!b.images[0].image)return this.warn("layer\u306b\u753b\u50cf\u304c\u306a\u3044\u3067\u3059\u3002"),0;var c=b.images[0].image.originalURL,d=KAGFiles(c+".asd"),e=this;$.when(d).then(function(d){setTimeout(function(){if(d){var i=new AnimationConductor({file:d,label:a.target});
b.addAnimationConductor(i,a.seg);i.run()}else e.error(c+".asd\u304c\u898b\u3064\u304b\u3089\u306a\u3044\u3067\u3059\u3002");e.done()})});return 1}});
Tag.actions.animstop=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(a){var b=a.layer[a.page].animationConductors[a.seg];b?b.stopUntilHome():this.warn(a.seg+"\u3068\u3044\u3046\u30a2\u30cb\u30e1\u30fc\u30b7\u30e7\u30f3\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002");return 0}});
Tag.actions.wa=new TagAction({rules:{layer:{type:"LAYER",required:!0},page:{type:/fore|back/,defaultValue:"fore"},seg:{type:"INT"}},action:function(a){var b=this,c=a.layer[a.page].animationConductors[a.seg];if(c)$(c).on("ran",function(a,c){2==c&&b.done()});else return this.warn(a.seg+"\u3068\u3044\u3046\u30a2\u30cb\u30e1\u30fc\u30b7\u30e7\u30f3\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3002"),0;return 1}});
(function(){var a;Tag.actions.o2_geo_watch=new TagAction({action:function(){if(a)return 0;a=navigator.geolocation.watchPosition(function(a){ev.geo=a});return 0}});Tag.actions.o2_geo_endwatch=new TagAction({action:function(){navigator.geolocation.clearWatch(a);a=void 0;return 0}});Tag.actions.o2_geo_get=new TagAction({action:function(){var a=this;navigator.geolocation.getCurrentPosition(function(c){ev.geo=c;a.done()},function(){a.done()});return 0}});Tag.actions.o2_geo_wg=new TagAction({rules:{canskip:{type:"BOOLEAN"}},
action:function(a){a.canskip&&wait("click");wait("o2_geo_get");return 1}})})();Tag.actions.clearsysvar=new TagAction({action:function(){window.sf={};return 0}});Tag.actions.clearvar=new TagAction({action:function(){window.f={}}});Tag.actions.glyph=new TagAction({rules:{line:{type:"STRING"},page:{type:"STRING"},fix:{type:"BOOLEAN"},left:{type:"FLOAT"},top:{type:"FLOAT"}},action:function(a){var b={fix:"fixed",left:"x",top:"y"},c;for(c in a)c=b[c]||c,o2.currentMessageLayer.glyphOptions[c]=a[c];return 0}});
Tag.actions.o2_loadplugin=new TagAction({rules:{module:{type:"STRING",required:!0}},action:function(a){var b=this,c=document.createElement("script");c.onload=function(){b.done()};c.onerror=function(){b.error("\u30d7\u30e9\u30b0\u30a4\u30f3\u30d5\u30a1\u30a4\u30eb "+a.module+" \u3092\u30ed\u30fc\u30c9\u3067\u304d\u307e\u305b\u3093")};c.src="./plugin/"+a.module;document.getElementsByTagName("head")[0].appendChild(c);return 1}});
Tag.actions.o2_sysbutton=new TagAction({rules:{graphic:{type:"STRING",required:!0},graphickey:{type:"COLOR",allowString:["adapt"]},storage:{type:"STRING"},target:{type:"STRING"},o2_url:{type:"STRING"},o2_urltarget:{type:"STRING",defaultValue:"_blank"},o2_exp:{type:"STRING"},o2_onenter:{type:"STRING"},o2_onleave:{type:"STRING"},id:{type:"STRING",required:!0}},action:function(a){var b=this;ResourceLoader.loadImage(a.graphic).done(function(c){setTimeout(function(){var d=o2.currentMessageLayer.textCursor,
d=new RoutineButton(c,d.x,d.y);d.importFromKAGArgs(a);o2.currentMessageLayer.addRoutineButton(d);b.done()})});return 1}});Tag.actions.o2_updatesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0},enabled:{type:"BOOLEAN"}},action:function(a){for(var b=0;b<o2.currentMessageLayer.routineButtons.length;b++){var c=o2.currentMessageLayer.routineButtons[b];if(c.tagArgs.id==a.id){c.enabled=a.enabled;break}}return 0}});
Tag.actions.o2_deletesysbutton=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(a){for(var b=0;b<o2.currentMessageLayer.routineButtons.length;b++){var c=o2.currentMessageLayer.routineButtons[b];if(c.tagArgs.id==a.id){o2.currentMessageLayer.routineButtons.splice(b,1);o2.currentMessageLayer.redrawRect(c.rect);break}}return 0}});
var RoutineButton=function(a,b,c){Button.call(this,a,b,c);this.rect.width=Math.floor(this.rect.width/4);this.options.clipLeft=0;this.options.clipWidth=this.rect.width;this.tagArgs;this.activated=this.enabled=!0};RoutineButton.prototype=Object.create(Button.prototype);RoutineButton.prototype.initializer="RoutineButton";RoutineButton.prototype.clone=function(){var a=new RoutineButton(this.image);a.importFrom(this);return a};
RoutineButton.prototype.drawOnContext=function(a,b){switch(this.state){case Button.STATE_DISABLE:this.options.clipLeft=3*this.rect.width;break;case Button.STATE_HOVER:this.options.clipLeft=2*this.rect.width;break;case Button.STATE_DOWN:this.options.clipLeft=this.rect.width;break;default:this.options.clipLeft=0}this.enabled||(this.options.clipLeft=3*this.rect.width);Button.prototype.drawOnContext.apply(this,arguments)};
RoutineButton.prototype.importFromKAGArgs=function(a){this.tagArgs=clone(a);this.click=function(b,c,d){Button.prototype.click.apply(this,arguments);if(this.activated&&this.enabled&&(a.o2_exp&&eval(a.o2_exp),a.o2_url&&window.open(a.o2_url,a.o2_urltarget),a.storage||a.target)){extraConductor.setFile(conductor.file);currentConductor=extraConductor;var e=new Tag("jump",{storage:a.storage,target:a.target});extraConductor.queue.push(e)}};a.o2_onenter&&(this.enter=function(){Button.prototype.enter.apply(this,
arguments);eval(a.o2_onenter)});a.o2_onleave&&(this.leave=function(){Button.prototype.leave.apply(this,arguments);eval(a.o2_onleave)})};RoutineButton.prototype.importFrom=function(a){Button.prototype.importFrom.call(this,a);a.tagArgs&&this.importFromKAGArgs(a.tagArgs)};RoutineButton.prototype.toJSON=function(){var a=Button.prototype.toJSON.call(this);a.tagArgs=this.tagArgs;return a};
RoutineButton.restore=function(a){return $.when(ResourceLoader.loadImage(a.image,!0)).then(function(b){b=new RoutineButton(b);b.importFrom(a);return b})};Tag.actions.o2_enterskip=new TagAction({action:function(){o2.skipToStop();return 0}});Tag.actions.o2_forcibleskip=new TagAction({action:function(){o2.skipToStopForcibly();return 0}});Tag.actions.o2_enterautomode=new TagAction({action:function(){o2.enterAutoMode();return 0}});
Tag.actions.cancelskip=new TagAction({action:function(){o2.skipMode=o2.SKIP_MODE_NONE;return 0}});Tag.actions.cancelautomode=new TagAction({action:function(){o2.cancelAutoMode();return 0}});
Tag.actions.dispatch=new TagAction({rules:{"break":{type:/click|stop/},noskip:{type:"BOOLEAN"},noauto:{type:"BOOLEAN"}},action:function(a){if(this.isOpen()){var b=currentConductor,c=this.getCallbackTask(),d=this.getScopeTokens(c);c.args=this.flattenCurrentScope(function(a){return-1!=d.indexOf(a)});"condition"in a&&(c.condition=function(){return a.noskip&&o2.skipMode||a.noauto&&o2.autoMode?!1:!0});b.dispatchQueue.push(c);c=conductor.getNextTag();if(!c||!c.isDependency)if("click"===a["break"])b.trigger("click");
else if("stop"===a["break"]&&!trigger("click")&&b.status==Conductor.STATUS_STOP)b.oneShot();return 0}}});
Tag.actions.buildtag=new TagAction({rules:{name:{type:"STRING",required:!0}},action:function(a){this.isOpen()||this.error("openTag\u3058\u3083\u306a\u3044\u3068\u30c0\u30e1\u3067\u3059");var b=this;this.newTag=new Tag(a.name);this.replaceTags=function(a){b.originalTags={};for(var d in a)b.originalTags[d]=b.conductor.tagActions[d],b.conductor.tagActions[d]=a[d]};this.restoreTags=function(){for(var a in b.originalTags)b.conductor.tagActions[a]=b.originalTags[a];b.originalTags=null};this.replaceTags({arg:new TagAction({rules:{name:{type:"STRING",
required:!0},value:{type:"ANY",required:!0}},action:function(a){b.newTag.args[a.name]=a.value}}),callback:new TagAction({action:function(){this.isOpen()||this.error("openTag\u3058\u3083\u306a\u3044\u3068\u30c0\u30e1\u3067\u3059");b.newTag.callbackArgs=this.callbackArgs;b.callbackFile=this.getCallbackFile()}})});this.conductor.setTag(this,!0);return 0},closeAction:function(a){var b=a.newTag;if(a.newTag.isOpen()){var c=a.callbackFile;c.lines.unshift(b);c.lines.push(new Tag("/"));c.lines.forEach(function(a,
b){a.file=c;a.lineNumber=b});b=new Conductor.DispatchTask(c);this.conductor.dispatchQueue.push(b);delete a.callbackFile}else this.conductor.queue.push(a.newTag);delete a.newTag;a.restoreTags()}});
(function(){var a={};Tag.actions.listengesture=new TagAction({rules:{id:{type:"STRING",required:!0},mode:{type:/delta|accumulate|absolute|longtap/,defaultValue:"accumulate"},mutualexclusive:{type:"BOOLEAN",defaultValue:!0},minx:{type:"INT"},maxx:{type:"INT"},miny:{type:"INT"},maxy:{type:"INT"},duration:{type:"INT",defaultValue:1E3},maxmove:{type:"INT",defaultValue:10}},action:function(b){if(this.isOpen())if("id"in a)this.error(id+"\u306f\u3059\u3067\u306b\u5b9a\u7fa9\u3055\u308c\u3066\u308b");else{var c=
this,d=function(){for(var a=c.getCallbackFile(),a=new Conductor({file:a}),b=[],d=0;d<arguments.length;d++)b.push(arguments[d]);b=c.makeScopeVars(b);a.callbackVarsStack.push(b);a.run()},e=function(){switch(b.mode){case "accumulate":return GestureRecognizer.accumulateRecognizer(b.minx,b.maxx,b.miny,b.maxy,d);case "delta":return GestureRecognizer.basicRecognizer("delta",d);case "absolute":return GestureRecognizer.basicRecognizer("absolute",d);case "longtap":return GestureRecognizer.longTapRecognizer(b.duration,
b.maxmove,d)}}();e.mutualExclusive=b.mutualexclusive;GestureManager.addRecognizer(e);a[b.id]=e;return 0}else this.error("open\u30bf\u30b0\u3058\u3083\u306a\u3044\u3068\u30c0\u30e1\u3067\u3059")}});Tag.actions.unlistengesture=new TagAction({rules:{id:{type:"STRING",required:!0}},action:function(b){GestureManager.removeRecognizer(a[b.id]);delete a[b.id];return 0}})})();
var defaultConfig={title:["string","untitled"],gameID:["string","mygame"],scWidth:["number",800],scHeight:["number",600],numMessageLayers:["number",2],numImageLayers:["number",2],backgroundColor:["color","0xeeeeee"],chSpeeds:["number",40],userCh2ndSpeed:["number",-1],numSEBuffers:["number",2],numMovies:["number",1],scPositionX_left:["number",0],scPositionX_left_center:["number",0],scPositionX_center:["number",0],scPositionX_right_center:["number",0],scPositionX_right:["number",0],initialMessageLayerVisible:["boolean",
!1],messageLayerColor:["color","0x000000"],messageLayerOpacity:["opacity",190],messageLayerMarginT:["number",6],messageLayerMarginL:["number",6],messageLayerMarginR:["number",6],messageLayerMarginB:["number",6],messageLayerCurrentPositionX:["number",10],messageLayerCurrentPositionY:["number",60],messageLayerCurrentWidth:["number",480],messageLayerCurrentHeight:["number",35],messageLayerDefaultAutoReturn:["boolean",!0],messageLayerDefaultFontSize:["number",12],messageLayerDefaultFontFace:["string",
"\uff2d\uff33 \uff30\u30b4\u30b7\u30c3\u30af"],messageLayerDefaultFontColor:["color","0xFFFFFF"],messageLayerDefaultFontBold:["boolean",!1],messageLayerDefaultFontItalic:["boolean",!1],messageLayerDefaultStyleLineSpacing:["number",6],messageLayerDefaultStylePitch:["number",0],messageLayerDefaultGlyphLine:["string","linebreak"],messageLayerDefaultGlyphPage:["string","pagebreak"],messageLayerDefaultGlyphFixed:["boolean",!1],messageLayerDefaultGlyphX:["number",0],messageLayerDefaultGlyphY:["number",
0],messageLayerDefaultLinkColor:["color","0x0000ff"],messageLayerDefaultLinkOpacity:["opacity",64],messageLayerVertical:["boolean",!1],messageLayerDefaultRubySize:["number",10],messageLayerDefaultRubyOffset:["number",-2],messageLayerDefaultShadow:["boolean",!0],messageLayerDefaultShadowBlur:["number",3],messageLayerDefaultShadowOffsetX:["number",0],messageLayerDefaultShadowOffsetY:["number",0],messageLayerDefaultShadowColor:["color","0x000000"],messageLayerDefaultEdge:["boolean",!1],messageLayerDefaultEdgeColor:["color",
"0x000000"],historyLayerFontFace:["string","\uff2d\uff33 \uff30\u30b4\u30b7\u30c3\u30af"],historyLayerFontColor:["color","0xFFFFFF"],historyLayerFontBold:["boolean",!1],historyLayerFontHeight:["number",24],historyLayerLineHeight:["number",26],historyLayerEverypage:["boolean",!1],historyLayerMaxPages:["number",30],historyLayerMaxLines:["number",20],historyLayerStoreState:["boolean",!1],historyLayerColor:["color","0x000000"],historyLayerOpacity:["opacity",255],historyLayerFrame:["string",""],historyLayerMarginT:["number",
30],historyLayerMarginL:["number",30],historyLayerMarginR:["number",30],historyLayerMarginB:["number",30],historyLayerCurrentPositionX:["number",10],historyLayerCurrentPositionY:["number",10],historyLayerCurrentWidth:["number",300],historyLayerCurrentHeight:["number",300],historyLayerVertical:["string","auto"],historyLayerShadow:["boolean",!0],historyLayerShadowColor:["color","0x000000"],historyLayerShadowBlur:["number",3],historyLayerShadowOffsetX:["number",0],historyLayerShadowOffsetY:["number",
0],historyLayerEdge:["boolean",!1],historyLayerEdgeColor:["color","0x000000"],historyLayerFrameFixed:["boolean",!1],cursorDefault:["string","auto"],cursorPointed:["string","pointer"],cursorWaitingClick:["string","auto"],cursorDraggable:["string","auto"],saveMode:["string","o2kag"],priorityAudioChannel:["string","bgm"],saveThumbnail:["boolean",!1],thumbnailWidth:["number",128],autoModePageWait:["number",350],autoModeLineWait:["number",50],autoRecordPageShowing:["boolean",!1],chNonStopToPageBreak:["boolean",
!1],ch2ndNonStopToPageBreak:["boolean",!1],numImageCache:["number",-1],numScriptCache:["number",5]},config={},mp={},tf={},sf={__system:{seGVolume:1,bgmGVolume:1,chSpeed:40,useUserChSpeed:!1,userChSpeed:40,userCh2ndSpeed:-1,autoModeLineWait:50,autoModePageWait:350}},f={},ev={query:function(){for(var a={},b=window.location.search.substring(1).split("&"),c=0;c<b.length;c++){var d=b[c].split("=");d.length&&!(1==d.length&&""==d[0])&&(a[d[0]]=2==d.length?decodeURIComponent((RegExp("[?|&]"+d[0]+"=([^&;]+?)(&|#|;|$)").exec(location.search)||
[,""])[1].replace(/\+/g,"%20"))||null:!0)}return a}(),save:{date:{},caption:{},snapshot:{}},cursorLocation:{x:0,y:0},ua:navigator.userAgent,lang:navigator.language?navigator.language:navigator.userLanguage,hostname:location.hostname,lastimage:{},enginever:"2.3.0",enginebuild:"71733ff"},o2={foreLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},backLayers:{baseLayer:void 0,imageLayers:[],messageLayers:[]},currentMessageLayer:void 0,currentMessageLayerWithBack:!1,allForeLayers:function(){return[this.foreLayers.baseLayer].concat(this.foreLayers.imageLayers).concat(this.foreLayers.messageLayers)},
allBackLayers:function(){return[this.backLayers.baseLayer].concat(this.backLayers.imageLayers).concat(this.backLayers.messageLayers)},allLayers:function(){return this.allBackLayers().concat(this.allForeLayers())},autoHideLayers:function(){return this.foreLayers.messageLayers.concat(this.backLayers.messageLayers).concat(this.extraAutoHideLayers)},refreshRendererLayers:function(){function a(a,c){return a.index-c.index}renderer.foreLayers=this.allForeLayers().sort(a);renderer.backLayers=this.allBackLayers().sort(a)},
resetLayersIndex:function(){for(var a=0;a<o2.foreLayers.imageLayers.length;a++)o2.foreLayers.imageLayers[a].index=1E3*(a+1),o2.backLayers.imageLayers[a].index=1E3*(a+1);for(a=0;a<o2.foreLayers.messageLayers.length;a++)o2.foreLayers.messageLayers[a].index=1E6+1E3*(a+1),o2.backLayers.messageLayers[a].index=1E6+1E3*(a+1)},extraAutoHideLayers:[],imageList:[],soundList:[],videoList:[],fontList:[],config:{scriptTagNameKey:"name",scriptTagArgsKey:"args",scriptTagLineKey:"line",scriptTagCharKey:"char"},se:[],
setSeGVolume:function(a){void 0!==a&&(sf.__system.seGVolume=a);this.se.forEach(function(a){a.volumePercentage=sf.__system.seGVolume;a.setVolume(a.volume)})},setBgmGVolume:function(a){void 0!==a&&(sf.__system.bgmGVolume=a);o2.bgm.volumePercentage=sf.__system.bgmGVolume;o2.bgm.setVolume(o2.bgm.volume)},bgm:new Sound,prioritySound:void 0,videos:[],currentSaveAdapter:new Tag.actions.save.adapters.LocalAdapter,skipMode:0,clickSkipEnabled:!0,skipWithMode:function(a){o2.skipMode=a;if(!trigger("click")&&
currentConductor.status!=Conductor.STATUS_STOP&&0==Object.keys(currentConductor.waitTag).length)currentConductor.oneShot()},skipToClick:function(){this.skipWithMode(o2.SKIP_MODE_CLICK)},skipToPage:function(){this.skipWithMode(o2.SKIP_MODE_PAGE)},skipToStop:function(){currentConductor.isCurrentRead()&&this.skipWithMode(o2.SKIP_MODE_UNREAD)},skipToStopForcibly:function(){this.skipWithMode(o2.SKIP_MODE_STOP)},autoMode:!1,enterAutoMode:function(){this.autoMode=!0;if(!trigger("click")&&currentConductor.status!=
Conductor.STATUS_STOP&&0==Object.keys(currentConductor.waitTag).length)currentConductor.oneShot()},cancelAutoMode:function(){this.autoMode=!1},reloadDelaySpeed:function(){var a=sf.__system.chSpeed;sf.__system.useUserChSpeed&&(currentConductor.isCurrentRead()&&"userCh2ndSpeed"in sf.__system&&-1!=sf.__system.userCh2ndSpeed?a=sf.__system.userCh2ndSpeed:"userChSpeed"in sf.__system&&(a=sf.__system.userChSpeed));for(var b=o2.foreLayers.messageLayers.concat(o2.backLayers.messageLayers),c=b.length-1;0<=c;c--)b[c].delaySpeed=
a},historyLayer:void 0,glyphLayer:void 0,showGlyph:function(a){this.currentMessageLayer.showGlyphLayer(this.glyphLayer,a||"line")},hideGlyph:function(){this.currentMessageLayer.hideGlyphLayer()},debugLevel:1,serverStat:{mode:0,key:ev.query.key||null,uid:ev.query.uid||-1,userServer:"https://novelsphere.jp",saveServer:"/",skey:ev.query.skey||null},setServerStat:function(a){o2.serverStat.key=a.key;o2.serverStat.uid=a.uid;o2.serverStat.userServer=a.userServer;o2.serverStat.skey=a.skey;a.saveServer&&(o2.serverStat.saveServer=
a.saveServer)},printLog:function(a){void 0==a&&(a=o2.DEBUG_LEVEL_LOG);if(a>o2.debugLevel)return function(){};switch(a){case o2.DEBUG_LEVEL_ERROR:return console.error;case o2.DEBUG_LEVEL_CAUTION:return console.warn;case o2.DEBUG_LEVEL_LOG:return console.log}return function(){}},log:function(){return o2.printLog(o2.DEBUG_LEVEL_LOG).apply(console,arguments)},warn:function(){return o2.printLog(o2.DEBUG_LEVEL_CAUTION).apply(console,arguments)},error:function(){return o2.printLog(o2.DEBUG_LEVEL_ERROR).apply(console,
arguments)},setCursorStyle:function(a){switch(a){case "pointer":a=config.cursorPointed;break;case "waitClick":a=config.cursorWaitingClick;break;case "draggable":a=config.cursorDraggable;break;default:a=config.cursorDefault}$("body").css("cursor",a)},rclickSettings:{call:!1,jump:!1,target:void 0,storage:void 0,enabled:!0},SKIP_MODE_NONE:0,SKIP_MODE_CLICK:1,SKIP_MODE_PAGE:2,SKIP_MODE_UNREAD:3,SKIP_MODE_STOP:4,SKIP_MODE_FAST_FORWARD:5,DEBUG_LEVEL_OFF:0,DEBUG_LEVEL_ERROR:1,DEBUG_LEVEL_CAUTION:2,DEBUG_LEVEL_LOG:3,
SERVER_MODE_STANDALONE:0,SERVER_MODE_O2SERVER:1,SAVE_MODE_O2KAG:"o2kag",SAVE_MODE_KAG3:"kag3",objectToBeSerialized:function(a){function b(a){for(var b=0;b<o2.foreLayers.messageLayers.length;b++){var e=o2.foreLayers.messageLayers[b];if(a==e)return{page:"fore",layer:b}}for(b=0;b<o2.backLayers.messageLayers.length;b++)if(e=o2.backLayers.messageLayers[b],a==e)return{page:"back",layer:b}}if("function"!=typeof this[a]){switch(a){case "imageList":case "soundList":case "videoList":case "config":case "imageList":case "soundList":case "videoList":case "serverStat":case "prioritySound":case "debugLevel":case "skipMode":case "autoMode":case "SKIP_MODE_NONE":case "SKIP_MODE_CLICK":case "SKIP_MODE_PAGE":case "SKIP_MODE_STOP":case "SKIP_MODE_FAST_FORWARD":case "DEBUG_LEVEL_OFF":case "DEBUG_LEVEL_ERROR":case "DEBUG_LEVEL_CAUTION":case "DEBUG_LEVEL_LOG":case "SERVER_MODE_STANDALONE":case "SERVER_MODE_O2SERVER":case "SAVE_MODE_O2KAG":case "SAVE_MODE_KAG3":return;
case "currentMessageLayer":return b(this.currentMessageLayer);case "autoHideLayers":return this.autoHideLayers.map(function(a){return b(a)})}return this[a]}},importFromSaveData:function(a){var b=this,c=[];["foreLayers","backLayers"].forEach(function(d){["imageLayers","messageLayers"].forEach(function(g){b[d][g]=[];var i=[];c.push(i.importFromSaveData(a[d][g]).done(function(){b[d][g]=i}));delete a[d][g]})});var d=a.currentMessageLayer;delete a.currentMessageLayer;c=c.concat(Object.prototype.importFromSaveData.call(this,
a));return $.when.apply($,c).done(function(){b.currentMessageLayer=b["back"==d.page?"backLayers":"foreLayers"].messageLayers[d.layer];delete a.currentMessageLayer;b.refreshRendererLayers()})}};
function initialize(a){function b(a,b){var c=defaultConfig[a],d;c&&(d=c[0]);switch(d){case "number":config[a]=Number(b);break;case "opacity":config[a]=Number(b)/255;break;case "boolean":config[a]="boolean"==typeof b?b:"true"==b.toLowerCase()?!0:"false"==b.toLowerCase()?!1:Boolean(b);break;case "color":config[a]=b.replace("0x","#");break;default:config[a]=b}}for(var c in defaultConfig)b(c,defaultConfig[c][1]);for(c in a.config)b(c,a.config[c]);document.title=config.title;sf.__system.useUserChSpeed=
!1;sf.__system.userChSpeed=config.chSpeeds;sf.__system.userCh2ndSpeed=config.userCh2ndSpeed;sf.__system.autoModeLineWait=config.autoModeLineWait;sf.__system.autoModePageWait=config.autoModePageWait;c={videolist:"videoList",imagelist:"imageList",soundlist:"soundList",fontlist:"fontList"};for(var d in c)c.hasOwnProperty(d)&&"object"===typeof a[d]&&(o2[c[d]]=a[d]);for(d=0;d<config.numSEBuffers;d++)o2.se.push(new Sound);for(d=0;d<config.numMovies;d++)o2.videos.push(new Video);"bgm"==config.priorityAudioChannel?
o2.prioritySound=o2.bgm:(d=config.priorityAudioChannel.match(/se([0-9]+)/),null==d&&o2.error("config.json\u306epriorityAudioChannel\u306fbgm\u304b\u3001se[0-9]+\u3058\u3083\u306a\u3051\u308c\u3070\u3044\u3051\u306a\u3044\u3067\u3059"),d=parseFloat(d[1]),o2.prioritySound=o2.se[d],o2.prioritySound||o2.error("config.json\u3067\u6307\u5b9a\u3055\u308c\u305fpriorityAudioChannel\u306f\u7121\u52b9\u3067\u3059\u3002"));o2.foreLayers.baseLayer=new BaseLayer;o2.backLayers.baseLayer=new BaseLayer;for(d=0;d<
config.numImageLayers;d++)c=new ImageLayer,o2.foreLayers.imageLayers.push(c),c=new ImageLayer,o2.backLayers.imageLayers.push(c);for(d=0;d<config.numMessageLayers;d++)c=new MessageLayer,o2.foreLayers.messageLayers.push(c),c=new MessageLayer,o2.backLayers.messageLayers.push(c);o2.currentMessageLayer=o2.foreLayers.messageLayers[0];o2.foreLayers.messageLayers[0].visible=o2.backLayers.messageLayers[0].visible=config.initialMessageLayerVisible;o2.historyLayer=new HistoryLayer;o2.glyphLayer=new GlyphLayer;
window.renderer=new Renderer;o2.resetLayersIndex();o2.refreshRendererLayers();$("#main-wrapper").append(renderer.foreCanvas);$("#main-wrapper").css({width:config.scWidth+"px",height:config.scHeight+"px"});a.manifest&&KAGFiles.setupManifest(a.manifest);for(var e in a.scripts)KAGFile.create(e,a.scripts[e]);$("body").css("background-color",config.backgroundColor);scaleToFitPage();$(window).on("resize",scaleToFitPage)}var conductor,currentConductor,extraConductor;
function getScripts(a,b){o2.serverStat.mode=o2.SERVER_MODE_O2SERVER;$.ajax({url:a,data:b,type:b?"POST":"GET",success:function(a){"string"==typeof a&&(a=JSON.parse(a));initScripts(a)}})}
function initScripts(a){initialize(a);a=null;extraConductor=new SubRoutineConductor;o2.serverStat.mode===o2.SERVER_MODE_O2SERVER&&(o2.currentSaveAdapter=new Tag.actions.save.adapters.O2ServerAdapter);a=KAGFiles("first.ks");$.when(a).then(function(a){currentConductor=conductor=new Conductor({file:a});conductor.run();setupEventHandlers();$(o2).trigger("init");window.parent!=window.self&&window.parent.postMessage("scriptLoaded","*")});if(browser.isIOs||browser.isAndroid)$("body").one("touchstart",function(){o2.bgm.dummyLoad();
for(var a=o2.se.length-1;0<=a;a--)o2.se[a].dummyLoad();for(a=o2.videos.length-1;0<=a;a--)o2.videos[a].dummyLoad()});window.FPSMeter&&(window.meter=new FPSMeter({smoothing:2,position:"fixed",top:"auto",left:"auto",bottom:"0px",right:"0px",graph:1,heat:1}))}
(function(){var a={scriptTagNameKey:0,scriptTagArgsKey:1,scriptTagDependencyKey:2,scriptTagCallbackArgsKey:3,scriptTagLineKey:4,scriptTagCharKey:5};"undefined"!==typeof module&&module.exports?exports.config=a:window&&window.o2&&(window.o2.config=a)})();
